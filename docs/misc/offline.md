## åˆ†æ²»æ€æƒ³

https://codgician.me/zh-hans/posts/2019/07/offline-divide-and-conquer/#%E4%BB%8E%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F%E8%AE%B2%E8%B5%B7

åˆ†æ²»ç®—æ³•ï¼Œå³â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œæ¯æ¬¡å°†å½“å‰çš„é—®é¢˜åŒ–æˆä¸¤ä¸ªæˆ–æ›´å¤šç›¸åŒæˆ–ç›¸ä¼¼çš„å­é—®é¢˜ï¼Œå†å¯¹æ¯ä¸ªåˆ†å‡ºçš„é—®é¢˜è¿›è¡ŒåŒæ ·çš„æ“ä½œâ€¦â€¦ ç›´åˆ°å­é—®é¢˜è¶³å¤Ÿåœ°å°ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæ–¹ä¾¿åœ°ç›´æ¥æ±‚è§£ã€‚å½’å¹¶æ’åºä¾¿æ˜¯åˆ†æ²»ç®—æ³•çš„ç»å…¸åº”ç”¨ä¹‹ä¸€ã€‚

ä¸è¿‡ï¼Œåœ¨è¿‡å»æˆ‘ä»¬é‡åˆ°çš„é¢˜ç›®ä¸­ï¼Œå¯èƒ½åˆ†æ²»æ€æƒ³æ›´å¤šåº”ç”¨åœ¨åŠ¨æ€è§„åˆ’è¿™ä¸€ç±»çš„é¢˜ç›®ä¸­ã€‚æˆ‘ä»¬æ¥è€ƒè™‘ï¼Œåœ¨å…è®¸ç¦»çº¿ç®—æ³•çš„æ•°æ®ç»“æ„é—®é¢˜ä¸­ï¼Œæ˜¯å¦å¯ä»¥å°è¯•å¯¹æ“ä½œå’Œè¯¢é—®è¿›è¡Œåˆ†æ²»ï¼Ÿ

æ•°æ®ç»“æ„é—®é¢˜å¾€å¾€è¦æ±‚æˆ‘ä»¬ç»´æŠ¤ä¸€ç³»åˆ—æ•°æ®ï¼Œå¹¶å¯¹ä¸€ç³»åˆ—æ“ä½œä¾æ¬¡åšå‡ºå“åº”ã€‚å…¶ä¸­ï¼Œæ“ä½œå¾€å¾€å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š

1. æŸ¥è¯¢ï¼šç»Ÿè®¡æ•°æ®ä¿¡æ¯ï¼›
2. ä¿®æ”¹ï¼šæ›´æ–°æ•°æ®çŠ¶æ€ã€‚

æœ‰äº†è¿™æ ·çš„å®šä¹‰åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æŠŠå¸¸è§çš„æ•°æ®ç»“æ„é—®é¢˜åˆ†ä¸ºå¦‚ä¸‹ä¸¤ç±»ï¼š

1. é™æ€é—®é¢˜ï¼šåªæœ‰æŸ¥è¯¢ï¼Œæˆ–è€…æ‰€æœ‰æŸ¥è¯¢éƒ½åœ¨æ‰€æœ‰ä¿®æ”¹ä¹‹åè¿›è¡Œã€‚
2. åŠ¨æ€é—®é¢˜ï¼šæ‰€æœ‰ä¸æ˜¯é™æ€é—®é¢˜çš„æ•°æ®ç»“æ„é—®é¢˜ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠæˆ‘ä»¬ç”¨äºæ•°æ®ç»“æ„çš„ç®—æ³•åˆ†ä¸ºä¸¤ç±»ï¼š

1. åœ¨çº¿ç®—æ³•ï¼šå¯¹äºæ¯ä¸€ä¸ªæŸ¥è¯¢åŠæ—¶è¿›è¡Œå“åº”çš„ç®—æ³•ï¼›
2. ç¦»çº¿ç®—æ³•ï¼šé¢„å…ˆçŸ¥é“æ‰€æœ‰æ“ä½œï¼Œé›†ä¸­è¿›è¡Œå¤„ç†åå†æ‰¹é‡å›ç­”æŸ¥è¯¢ã€‚

æ¯”å¦‚ï¼Œå¸¸è§çš„çº¿æ®µæ ‘å°±æ˜¯ä¸€ä¸ªåœ¨çº¿ç®—æ³•ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿå¯¹æ¯ä¸€ä¸ªè¯¢é—®åšå‡ºåŠæ—¶çš„å“åº”ï¼›è€Œè«é˜Ÿåˆ™æ˜¯ä¸€ä¸ªç¦»çº¿ç®—æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»é¢„å…ˆçŸ¥é“å®Œæ•´çš„æ“ä½œåºåˆ—æ‰èƒ½å¤Ÿè®¡ç®—ç­”æ¡ˆã€‚

é¡¾åæ€ä¹‰ï¼Œæœ¬æ–‡æ‰€è¦è®²çš„ç®—æ³•éƒ½æ˜¯ç¦»çº¿ç®—æ³•ã€‚ç¦»çº¿æ‰€èƒ½å¸¦æ¥çš„å¥½å¤„å°±æ˜¯é€šè¿‡å¢åŠ  O(logn) çš„å¤æ‚åº¦è¾¾åˆ°åŸé—®é¢˜è¿›è¡Œç®€åŒ–çš„ç›®çš„ï¼Œæˆ–è®¸æ˜¯æŠŠåŠ¨æ€é—®é¢˜è½¬æ¢æˆæ›´åŠ å®¹æ˜“å¤„ç†çš„é™æ€é—®é¢˜ï¼Œäº¦æˆ–æ˜¯æŠŠå¸¦æœ‰æ’å…¥å’Œåˆ é™¤çš„æ“ä½œåºåˆ—è½¬æ¢æˆåªåŒ…å«æ’å…¥æ“ä½œâ€¦â€¦ éå¸¸çš„ä¼˜é›…ä¸ç®€æ´ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘éå¸¸å–œæ¬¢è¿™ä¸€æ€æƒ³çš„ä¸»è¦åŸå› ã€‚

## åŸºäºæ—¶é—´çš„ç¦»çº¿åˆ†æ²»

### CDQ åˆ†æ²»

**ä»å½’å¹¶æ’åºè®²èµ·**

mergesort(l,r)ï¼šå¯¹åºåˆ—ä¸‹è¡¨åŒºé—´ \[l,r\] å†…å…ƒç´ æŒ‰å€¼è¿›è¡Œæ’åº

- mid = (l+r)/2
- mergesort(l,mid)ï¼›
- mergesort(mid+1,r)ï¼›
- åŒæŒ‡é’ˆåˆå¹¶ä¸¤ä¸ªå·¦å³æœ‰åºåŒºé—´ï¼šmerge(l,mid+1,r+1)

ä¸éš¾å‘ç°ï¼Œå½’å¹¶æ’åºå·§å¦™åœ°é¿å¼€äº†å¯¹åŒºé—´è¿›è¡Œæ’åºæœ¬èº«ï¼ŒæŠŠé—®é¢˜å®Œå…¨è½¬å˜ä¸ºäº†ä¸¤ä¸ªæœ‰åºåŒºé—´çš„åˆå¹¶é—®é¢˜ã€‚åªè¦èƒ½è§£å†³åè€…ï¼Œé‚£ä¹ˆå‰è€…å°±è§£å†³äº†ã€‚è¿™èƒ½ä¸èƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä¸€äº›å¯å‘å‘¢ï¼Ÿ

**ååºé—®é¢˜**

å¯¹äºä¸¤ä¸ª k å…ƒç»„ $t_1: \langle x_1, x_2, \dots x_k \rangle, \ t_2: \langle y_1, y_2, \dots y_k \rangle $ï¼Œå¦‚æœ $\forall i \in [1, k]$ ï¼Œæ»¡è¶³ $x_i < y_i$ ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° $\langle t_1, t_2 \rangle$ æ„æˆä¸€ç»„ k ç»´ååºï¼ˆæœ‰çš„åœ°æ–¹å¯èƒ½ä¼šæŠŠ < å®šä¹‰æˆ $\le$ ï¼‰ã€‚

æˆ‘ä»¬æ¥è€ƒè™‘è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š

???+note "ä¸‰ç»´ååº"
    ç»™å®š n ä¸ªä¸‰å…ƒç»„ $p_i = \langle a_i, b_i, c_i \rangle$ ï¼Œå¯¹äºæ¯ä¸€ä¸ªå…ƒç´  $p_i$ ï¼Œæ±‚æ»¡è¶³ï¼š $a_i < a_j, b_i < b_j, c_i < c_j$ çš„ $\langle i, j \rangle$ å¯¹æ•°ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘ä¸å­˜åœ¨ i, j ä½¿å¾— $a_i = a_j$ æˆ– $b_i = b_j$ æˆ– $c_i = c_j$ çš„æƒ…å†µã€‚

    æ•°æ®èŒƒå›´ï¼š$n \le 10^5, 1 \le a_i, b_i, c_i \le 10^9$ 

é¦–å…ˆï¼Œå¦‚æœæ˜¯äºŒç»´ååºé—®é¢˜çš„è¯ï¼ˆå³å‡è®¾æ¯ä¸ªå…ƒç´ åªæœ‰ a,b ä¸¤ç»´ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“æƒ³åˆ°ä¸€ä¸ªè§£æ³•ï¼šé¦–å…ˆå°†æ‰€æœ‰å…ƒç´ æŒ‰ç…§ a ç»´ä»å°åˆ°å¤§æ’åºï¼Œç„¶åå°† b ç»´ç¦»æ•£åŒ–ï¼ŒæŒ‰å€¼æ‰”è¿›ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„åŒæŒ‡é’ˆç»Ÿè®¡ä¸€ä¸‹å°±å¥½äº†ï¼ˆå³ä»å°åˆ°å¤§éå† aï¼Œç„¶ååœ¨æ ‘çŠ¶æ•°ç»„ä¸­ b çš„ä½ç½® +1ï¼Œæ¯æ¬¡éƒ½ç»Ÿè®¡ä¸€ä¸‹å½“å‰æ ‘çŠ¶æ•°ç»„ä¸­å°äºå½“å‰ a çš„å‰ç¼€å’Œå³å¯ï¼‰ã€‚ç†è®ºä¸Šä¸‰ç»´ååºæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªäºŒç»´æ ‘çŠ¶æ•°ç»„è§£å†³ï¼Œç„¶è€Œç©ºé—´å¼€ä¸ä¸‹ï¼Œè¿™å¯æ€ä¹ˆåŠå‘¢â€¦â€¦

æˆ‘ä»¬è¿˜æ˜¯å…ˆå°†æ‰€æœ‰å…ƒç´ æŒ‰ç…§ a ç»´ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œæ¥ä¸‹æ¥è€ƒè™‘è¿™æ ·ä¸€ä¸ªç®—æ³•ï¼š

$solve(l, r)ï¼š\forall k \in [l, r]$ï¼Œè®¡ç®—ç¬¬ \[l, k - 1\] é¡¹å…ƒç´ å¯¹ç¬¬ k é¡¹å…ƒç´ çš„è´¡çŒ®ï¼ˆä¸æ­¤åŒæ—¶å¯¹æ‰€æœ‰ä¸‰å…ƒç»„æŒ‰ç…§ b ç»´æ’åºï¼‰ï¼š

- $mid = \frac{1}{2}(l + r)$
- solve(l, mid)
- solve(mid + 1, r)

è®¡ç®— \[l, mid\] ä¸­å…ƒç´ å¯¹ \[mid + 1, r\] ä¸­æ¯ä¸ªå…ƒç´ é€ æˆçš„è´¡çŒ®ï¼ŒåŒæ—¶åŒæŒ‡é’ˆåˆå¹¶ä¸¤ä¸ªå·¦å³æœ‰åºåŒºé—´ï¼šmerge(l, mid + 1, r + 1)ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç®€è¦è°ˆè°ˆä¸ºä»€ä¹ˆè¿™ä¸€ç®—æ³•æ˜¯æ­£ç¡®çš„ã€‚å¯¹äºç¬¬ kk é¡¹å…ƒç´ è€Œè¨€ï¼ˆä½œä¸ºååºå¯¹ä¸­è¾ƒå¤§çš„å…ƒç´ ï¼‰ï¼š

- è‹¥ $k \le mid$ ï¼Œåˆ™ solve(l, mid) å·²ç»è®¡ç®—å®ƒæ‰€èƒ½ä¸ç¬¬ \[l, k - 1\] é¡¹å…ƒç´ æ„æˆçš„ååºå¯¹æ•°é‡ï¼›
- è‹¥ k > midï¼Œåˆ™ solve(mid + 1, r) å·²ç»è®¡ç®—äº†å…¶æ‰€èƒ½ä¸ç¬¬ \[mid + 1, k - 1\] é¡¹å…ƒç´ æ„æˆçš„ååºå¯¹æ•°é‡ï¼›æœ€åä¸€æ­¥åˆ™è®¡ç®—äº†å…¶å¯ä¸ç¬¬ \[l, mid\] é¡¹å…ƒç´ æ„æˆçš„ååºå¯¹æ•°é‡ã€‚ä¸¤è€…ç›¸åŠ åå³ä¸ºå…¶ä¸ç¬¬ \[l, k - 1\] é¡¹å…ƒç´ å¯æ„æˆçš„ååºå¯¹æ•°é‡ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä»”ç»†æ¢è®¨ä¸€ä¸‹ä¸Šè¿°ç®—æ³•ä¸­ç¬¬ 44 æ­¥åº”å½“å¦‚ä½•è¿›è¡Œã€‚ä¸éš¾å‘ç°åœ¨è¿™ä¸€æ­¥æ—¶æœ‰ä¸¤ä¸ªé‡è¦ç‰¹æ€§ï¼š

- å·¦åŒºé—´ä¸­æ‰€æœ‰å…ƒç´  a ç»´ä¸€å®šå°äºå³åŒºé—´ä¸­æ‰€æœ‰å…ƒç´  a ç»´ï¼›
- å·¦å³åŒºé—´éƒ½å·²ç»æŒ‰ b ç»´æ’å¥½åºäº†ã€‚

æ˜¾ç„¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸ç”¨å»ç®¡ a ç»´äº†ï¼Œå› ä¸ºåªè¦ä¸¤ä¸ªå…ƒç´ ä¸€ä¸ªæ¥è‡ªäºå·¦åŒºé—´è€Œå¦ä¸€ä¸ªæ¥è‡ªå³åŒºé—´ï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨ a ç»´ä¸Šè‚¯å®šæ˜¯æ»¡è¶³ååºå¯¹è¦æ±‚çš„ã€‚é‚£ä¹ˆâ€¦â€¦ b ç»´å·²ç»æ’å¥½åºäº†ï¼Œc ç»´â€¦â€¦ ç­‰ç­‰ï¼Œè¿™ä¸å°±æ˜¯ä¸ªäºŒç»´ååºé—®é¢˜å—ï¼Ÿæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦é‡‡ç”¨ä¹‹å‰å¯¹äºŒç»´ååºçš„åšæ³•å¯¹å…¶è¿›è¡Œå¤„ç†å°±å®Œäº‹äº†~ ä¸éš¾å‘ç°ï¼Œé‡‡ç”¨äº†åˆ†æ²»æ€æƒ³åï¼Œæˆ‘ä»¬æˆåŠŸåœ°å°†åŸé—®é¢˜çš„ç»´åº¦é™ä½äº†ä¸€ç»´ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹å¤æ‚åº¦ï¼šè®°å½“å‰åˆ†æ²»åŒºé—´é•¿åº¦ä¸º nï¼Œä¸”ç¬¬ 4 æ­¥å¤„ç†æ‰€éœ€å¤æ‚åº¦ä¸º $\mathcal{O}(f(n))$ï¼ˆæ¯”å¦‚åœ¨ä¸Šä¾‹ä¸­å°±æ˜¯æ ‘çŠ¶æ•°ç»„çš„å¤æ‚åº¦å³ $\mathcal{O}(\log{n})$ ï¼Œåˆ™æœ‰ï¼š

$T(n) = 2T(\frac{n}{2}) + \mathcal{O}(f(n))$

å€ŸåŠ©ä¸»å®šç†è§£ä¸€ä¸‹ï¼ˆæˆ–è€…ç”»é€’å½’æ ‘çœ‹ä¸€çœ‹ï¼‰ä¸éš¾å¾—åˆ°ï¼š

$T(n) \le \mathcal{O}(f(n) \log{n})$

é€šè¿‡å¤æ‚åº¦è®¡ç®—æˆ‘ä»¬ä¹Ÿå¾—åˆ°ä¸€æ¡é‡è¦æ³¨æ„äº‹é¡¹ï¼šæˆ‘ä»¬å¿…é¡»ä¿è¯åœ¨æ‰§è¡Œç¬¬ 4 æ­¥çš„æ—¶å€™å¤æ‚åº¦ä¸å½“å‰åˆ†æ²»åŒºé—´é•¿åº¦ç›¸å…³è€Œä¸å¯ä»¥ä¸æ•´ä¸ªåŒºé—´é•¿åº¦ç›¸å…³ï¼Œå¦åˆ™å¤æ‚åº¦å°±ä¸æ˜¯ä¸Šé¢è¿™ä¸ªæ ·å­äº†ã€‚åœ¨ä¹‹å‰æåˆ°çš„å…·ä½“é—®é¢˜ä¸­ï¼Œå°±æ˜¯æ¸…ç©ºæ ‘çŠ¶æ•°ç»„çš„æ—¶å€™ä¸èƒ½ç›´æ¥ memsetï¼Œè€Œå¿…é¡»é€ä¸€åˆ é™¤è¢«ä¿®æ”¹äº†çš„éƒ¨åˆ†ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å¤æ‚åº¦æ­£ç¡®ã€‚

ä¸‹é¢ç®€è¦ä¸Šä¸€æ®µä»£ç ä»¥ä¾›å‚è€ƒï¼š

```cpp
void divideConquer(int headPt, int tailPt) {
    if (headPt == tailPt)
        return;
    int midPt = (headPt + tailPt) >> 1;
    divideConquer(headPt, midPt); divideConquer(midPt + 1, tailPt);
    int j = headPt; // j: å·¦åŒºé—´ä¸­æŒ‡é’ˆï¼›i: å³åŒºé—´ä¸­æŒ‡é’ˆ
    for (int i = midPt + 1; i <= tailPt; i++) {
        for (; j <= midPt && arr[j].b < arr[i].b; j++) 
            add(arr[j].c, 1);
        // ç»Ÿè®¡æ€»ä¸‰ç»´ååºå¯¹æ•°é‡ï¼ˆæ ‘çŠ¶æ•°ç»„ä¸­ c ç»´å°äºå½“å‰çš„æ•°é‡ï¼‰
        ans += prefixSum(arr[i].c - 1);
    }
    // æ’¤é”€å¯¹æ ‘çŠ¶æ•°ç»„çš„æ›´æ”¹
    for (int i = headPt; i < j; i++)
        add(arr[i].c, -1);
    // æŒ‰ b ç»´åˆå¹¶å·¦å³æœ‰åºåŒºé—´ï¼ˆcmpSnd ä¸ºæŒ‰ç…§ b ç»´ä»å°åˆ°å¤§æ’åºçš„æ¯”è¾ƒå‡½æ•°ï¼‰
    inplace_merge(arr + headPt, arr + midPt + 1, arr + tailPt + 1, cmpSnd);
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥ä»”ç»†è€ƒè™‘ä¸€ä¸‹ä¹‹å‰ä¸ºäº†æ–¹ä¾¿å¼•å…¥çš„é™åˆ¶ã€‚å¦‚æœä¸æ»¡è¶³ä¸åŒå…ƒç´ é—´åŒä¸€ç»´ä¸Šçš„å€¼äº’ä¸ç›¸åŒä¼šå¼•å…¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ

é—®é¢˜ä¾ç„¶æ˜¯å‡ºåœ¨ç¬¬ 4 æ­¥ã€‚åœ¨è¿™ä¸€æ­¥æ—¶ï¼Œæˆ‘ä»¬åªèƒ½ä¿è¯å·¦åŒºé—´ a ç»´å°äºç­‰äºå³åŒºé—´ï¼Œè€Œä¸èƒ½ä¿è¯ä¸¥æ ¼å°äºã€‚æ¢è¨€ä¹‹ï¼Œåœ¨å¯¹ b ç»´è¿›è¡Œåˆ†æ²»æ—¶ï¼Œå¯èƒ½å‡ºç°å¯¹äºå³åŒºé—´æŸå…ƒç´ ï¼Œå·¦åŒºé—´ä¸­å­˜åœ¨æŸä¸ªå…ƒç´ ä½¿å¾—ä¸¤è€… a ç»´ç›¸ç­‰ã€‚è¯»è€…å¯ä»¥å…ˆè‡ªè¡Œæ€è€ƒä¸€ä¸‹å¦‚ä½•è§£å†³è¿™ä¸€é—®é¢˜~

è¿™é‡Œæä¾›ä¸€ç§è§£å†³æ–¹æ³•ä»¥ä¾›å‚è€ƒï¼šå…ˆå°† a ç»´ç¦»æ•£åŒ–ï¼Œåœ¨åŒæŒ‡é’ˆå¤„ç†æ—¶å¼€ä¸€ä¸ªæ•°ç»„æ¥è®°å½•æŸä¸ª a ç»´å€¼å¯¹åº”çš„å·¦åŒºé—´ä¸­çš„å…ƒç´ çš„ä¸ªæ•°ï¼Œåœ¨ç»Ÿè®¡æ—¶å‡æ‰ a ç»´ç›¸ç­‰çš„æƒ…å†µã€‚

æœ€åï¼Œå¤§å®¶å¯ä»¥å»å°è¯•ä¸€ä¸‹ä¸€é“æ¨¡æ¿é¢˜ï¼ˆæ³¨æ„è¿™é“é¢˜ä¸å‰é¢ä¸¾çš„ä¾‹å­ä¸å®Œå…¨ä¸€æ ·ï¼‰ï¼Œé¡ºä¾¿é™„ä¸Šä»£ç ä»¥ä¾›å‚è€ƒã€‚

???+note "[é™Œä¸ŠèŠ±å¼€](https://www.luogu.com.cn/problem/P3810)"
    è¿™æ˜¯ä¸€é“æ¨¡æ¿é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ bitsetï¼ŒCDQ åˆ†æ²»ï¼ŒKD-Tree ç­‰æ–¹å¼è§£å†³ã€‚

    æœ‰ n ä¸ªå…ƒç´ ï¼Œç¬¬ i ä¸ªå…ƒç´ æœ‰ $a_i,b_i,c_i$ ä¸‰ä¸ªå±æ€§ï¼Œè®¾ f(i) è¡¨ç¤ºæ»¡è¶³ $a_j \leq a_i$ ä¸” $b_j \leq b_i$ ä¸” $c_j \leq c_i$ ä¸” $j \ne i$ çš„ j çš„æ•°é‡ã€‚

    å¯¹äº $d \in [0, n)$ ï¼Œæ±‚ f(i)=d çš„æ•°é‡ã€‚

    è¾“å…¥æ ¼å¼: ç¬¬ä¸€è¡Œä¸¤ä¸ªæ•´æ•° n, kï¼Œè¡¨ç¤ºå…ƒç´ æ•°é‡å’Œæœ€å¤§å±æ€§å€¼ã€‚

    æ¥ä¸‹æ¥ n è¡Œï¼Œæ¯è¡Œä¸‰ä¸ªæ•´æ•° $a_i ,b_i,c_i$ ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸‰ä¸ªå±æ€§å€¼ã€‚

    è¾“å‡ºæ ¼å¼: n è¡Œï¼Œç¬¬ d+1 è¡Œè¡¨ç¤º f(i)=d çš„ i çš„æ•°é‡ã€‚

???+note "å‚è€ƒä»£ç "

    ```cpp
    // luogu-judger-enable-o2
    #include <bits/stdc++.h>
    using namespace std;

    #define SIZE 100010
    #define VAL_SIZE 200020

    typedef struct _Node {
        int a, b, c;
        int num, ans;

        bool operator == (const struct _Node & snd) const {
            return a == snd.a && b == snd.b && c == snd.c;
        }
    } Node;

    Node arr[SIZE];
    int ans[SIZE], bit[VAL_SIZE], siz;

    bool cmpSnd(const Node & fst, const Node & snd) {
        if (fst.b != snd.b)
            return fst.b < snd.b;
        return fst.c < snd.c;
    }

    bool cmpFst(const Node & fst, const Node & snd) {
        if (fst.a != snd.a)
            return fst.a < snd.a;
        return cmpSnd(fst, snd);
    }

    int lowbit(int n) {
        return n & -n;
    }

    void add(int pos, int val) {
        for (int i = pos; i <= siz; i += lowbit(i))
            bit[i] += val;
    }

    int prefixSum(int pos) {
        int ret = 0;
        for (int i = pos; i > 0; i -= lowbit(i))
            ret += bit[i];
        return ret;
    }

    void divideConquer(int headPt, int tailPt) {
        if (headPt == tailPt)
            return;
        int midPt = (headPt + tailPt) >> 1;
        divideConquer(headPt, midPt);
        divideConquer(midPt + 1, tailPt);

        int j = headPt;
        for (int i = midPt + 1; i <= tailPt; i++) {
            for (; j <= midPt && arr[j].b <= arr[i].b; j++)
                add(arr[j].c, arr[j].num);
            arr[i].ans += prefixSum(arr[i].c);
        }

        for (int i = headPt; i < j; i++)
            add(arr[i].c, -arr[i].num);

        inplace_merge(arr + headPt, arr + midPt + 1, arr + tailPt + 1, cmpSnd);
    }

    int main() {
        ios::sync_with_stdio(false);
        cin.tie(0); cout.tie(0);
        memset(ans, 0, sizeof(ans));
        memset(bit, 0, sizeof(bit));

        int num;
        cin >> num >> siz;
        for (int i = 0; i < num; i++) {
            cin >> arr[i].a >> arr[i].b >> arr[i].c;
            arr[i].num = 1; arr[i].ans = 0;
        }

        sort(arr + 0, arr + num, cmpFst);

        int ovrPt = 0, cntPt = 1;
        while (cntPt < num) {
            if (arr[ovrPt] == arr[cntPt])
                arr[ovrPt].num += arr[cntPt].num;
            else
                arr[++ovrPt] = arr[cntPt];
            cntPt++;
        }
        ovrPt++;

        divideConquer(0, ovrPt - 1);
        for (int i = 0; i < ovrPt; i++) {
            arr[i].ans += arr[i].num - 1;
            ans[arr[i].ans] += arr[i].num;
        }
        for (int i = 0; i < num; i++)
            cout << ans[i] << '\n';
        return 0;
    }
    ```
**å››ç»´ååº**

æ—¢ç„¶ä¸‰ç»´ååºå¯ä»¥å€ŸåŠ©åˆ†æ²»é™æˆäºŒç»´ååºï¼Œé‚£ä¹ˆå››ç»´ååºä½•å°ä¸å¯ä»¥å€ŸåŠ©åˆ†æ²»é™ä¸ºä¸‰ç»´ååºï¼Œç„¶åå†å€ŸåŠ©ä¸€å±‚åˆ†æ²»é™æˆäºŒç»´ååºå‘¢ï¼Ÿï¼ˆä¸è¿‡ $\mathcal{O}(n\log^3{n})$ ) è¿™ä¸ªå¤æ‚åº¦ä¹Ÿæ˜¯æŒºå°´å°¬çš„â€¦â€¦

å¦‚æœæ‚¨å·²ç»è·ƒè·ƒæ¬²è¯•ï¼Œä¸å¦¨å» [COGS 2479:ã€HZOI 2016ã€‘ååº](https://www.cnblogs.com/candy99/p/6442434.html) å½“åœºè¡¨æ¼”ä¸€æ³¢

ä¸è¿‡å½“æˆ‘ä»¬åœ¨å¯¹ c ç»´è¿›è¡Œåˆ†æ²»ï¼ˆå³ä¸‰ç»´ååºé™ä¸ºäºŒç»´ååºï¼‰æ—¶åªèƒ½ä¿è¯ä»»æ„å·¦åŒºé—´å…ƒç´  $p_i$ å’Œä»»æ„å³åŒºé—´å…ƒç´  $p_j$ ä¹‹é—´æ»¡è¶³ $b_i \le b_j$ ï¼Œè€Œå¹¶ä¸èƒ½ä¿è¯ $a_i \le a_j$ ã€‚å› æ­¤ï¼š

- å¯¹ b ç»´è¿›è¡Œåˆ†æ²»æ—¶ï¼Œåˆå¹¶å·¦å³åŒºé—´å‰åº”æ ‡è®°æ­¤æ—¶å…ƒç´ å±äºå“ªä¸ªåŒºé—´ï¼Œä¸”åˆå¹¶ååº”å½“å¤‡ä»½è¿™ä¸€åŒºé—´ï¼›
- å¯¹ c ç»´è¿›è¡Œåˆ†æ²»æ—¶è®¡ç®—ä¸¤å±‚åˆ†æ²»éƒ½åœ¨å·¦åŒºé—´çš„å…ƒç´ å¯¹ä¸¤å±‚åˆ†æ²»éƒ½åœ¨å³åŒºé—´çš„å…ƒç´ çš„è´¡çŒ®ï¼Œå®Œæˆååº”å°†åŒºé—´ä»å¤‡ä»½æ¢å¤ä»¥ç»§ç»­ b ç»´ä¸Šçš„åˆ†æ²»ã€‚

å…·ä½“çš„å®ç°å¯ä»¥å‚è€ƒä¸€ä¸‹[æˆ‘çš„ä»£ç ](https://github.com/codgician/Competitive-Programming/blob/master/COGS/2479/divide_and_conquer_2d.cpp)ã€‚

**åç»´ååºï¼Ÿ**
åœ¨ 10^5^ çš„è¿™ä¸ªæ•°æ®èŒƒå›´ä¸‹ï¼Œ$\mathcal{O}(n^2)$ ) ä¸é¦™å—

### åŠ¨æ€æ•°æ®ç»“æ„é—®é¢˜

æ¥ä¸‹æ¥æˆ‘ä»¬è®¨è®ºè¿™ä¸ªæ€æƒ³æ€ä¹ˆè·ŸåŠ¨æ€æ•°æ®ç»“æ„é—®é¢˜æ‰¯ä¸Šè”ç³»ã€‚

æˆ‘ä»¬æ¥è€ƒè™‘ä¸€ä¸‹åŠ¨æ€æ•°æ®ç»“æ„é—®é¢˜ä¸­å›ç­”æŸ¥è¯¢çš„æœ¬è´¨ï¼šå³è®¡ç®—åˆå§‹æ•°æ®å’Œæœ¬æ¬¡æŸ¥è¯¢ä¹‹å‰ï¼Œæ‰€æœ‰ä¿®æ”¹å¯¹è¯¥æŸ¥è¯¢é€ æˆçš„å½±å“ã€‚é‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½å€ŸåŠ©åˆ†æ²»æ€æƒ³ä½¿å¾—ä¿®æ”¹å’ŒæŸ¥è¯¢ä¸è¦æ··åœ¨ä¸€èµ·å‘¢ï¼Ÿ

$solve(l, r) ï¼š\forall k \in [l, r]$ ï¼Œè‹¥ç¬¬ k é¡¹æ“ä½œæ˜¯æŸ¥è¯¢ï¼Œåˆ™è®¡ç®— \[l, k - 1\] ä¸­ä¿®æ”¹å¯¹å…¶é€ æˆçš„å½±å“ï¼š

- $mid = \frac{1}{2}(l + r)$
- solve(l, mid)
- solve(mid + 1, r)
- è®¡ç®—ç¬¬ \[l, mid\] é¡¹æ“ä½œä¸­æ‰€æœ‰ä¿®æ”¹å¯¹ \[mid + 1, r\] ä¸­æ‰€æœ‰æŸ¥è¯¢é€ æˆçš„å½±å“ã€‚

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ä¾¿å°† â€œè®¡ç®—æ“ä½œé›†åŒºé—´ \[l, r\] å†…æ‰€æœ‰æŸ¥è¯¢â€ è¿™ä¸€é—®é¢˜è½¬æ¢ä¸ºäº† â€œè®¡ç®—å·¦åŒºé—´ä¸­æ‰€æœ‰ä¿®æ”¹å¯¹å³åŒºé—´ä¸­æ‰€æœ‰æŸ¥è¯¢é€ æˆå½±å“â€ã€‚æ¢è¨€ä¹‹ï¼Œä»¥ $\mathcal{O}(\log{n})$ çš„ä»£ä»·ï¼Œæˆ‘ä»¬æˆåŠŸåœ°å°†ä¸€ä¸ªåŠ¨æ€é—®é¢˜è½¬æ¢æˆäº†é™æ€é—®é¢˜ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹å‡ ä¸ªä¾‹å­å§ã€‚

???+note "åŠ¨æ€äºŒç»´æ•°ç‚¹"

    ç»™å®šäºŒç»´å¹³é¢ä¸Š n ä¸ªç‚¹ä¸”æœ‰ q æ¬¡æ“ä½œã€‚éœ€è¦æ”¯æŒä¸¤ç§æ“ä½œï¼š

    - æ·»åŠ ä¸€ä¸ªæ–°åæ ‡ç‚¹ï¼›
    - åˆ é™¤ä¸€ä¸ªå·²æœ‰çš„åæ ‡ç‚¹ï¼›

    æ¯æ¬¡è¯¢é—®ä¸€ä¸ªçŸ©å½¢åŒºåŸŸ $(x_L, y_L), \ (x_R, y_R)$ å†…ç‚¹çš„æ•°é‡ï¼ˆå·¦ä¸‹å’Œå³ä¸Šé¡¶ç‚¹åæ ‡ï¼‰ã€‚

    æ•°æ®èŒƒå›´ï¼š$n \le 10^5, \ q \le 10^5$ ã€‚

ä¸ºäº†æ–¹ä¾¿è¯´æ˜ï¼Œæˆ‘ä»¬å…ˆå¼•å…¥ä¸€äº›æ ‡è®°ï¼š

- è®° a(x,y) ä»£è¡¨ (x,y) ä½ç½®ä¸Šç‚¹çš„ä¸ªæ•°ï¼›
- è®° $Q(x_L, y_L, x_R, y_R)$ ä»£è¡¨çŸ©å½¢åŒºåŸŸ $(x_L, y_L), \ (x_R, y_R)$ å†…ç‚¹çš„æ•°é‡ï¼›
- è®° F(x,y) ä»£è¡¨çŸ©å½¢åŒºåŸŸ $(1, 1), (x, y)$ å†…ç‚¹çš„æ•°é‡ï¼ˆå³äºŒç»´å‰ç¼€å’Œï¼‰ã€‚

é‚£ä¹ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š

$Q(x_L, y_L, x_R, y_R) = \sum\limits_{i = x_L}^{x_R}\sum\limits_{j = y_L}^{y_R} a(i, j)$

å€ŸåŠ©ä¸€ç‚¹ç‚¹å®¹æ–¥åŸç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¨å‡ºï¼š

$\begin{aligned} Q(x_L, y_L, x_R, y_R) = & F(x_R, y_R) + F(x_L âˆ’ 1, y_L âˆ’ 1) \\ & âˆ’ F(x_L âˆ’ 1, y_R) âˆ’ F(x_R, y_L âˆ’ 1) \end{aligned}$

é‚£ä¹ˆç°åœ¨é—®é¢˜å°±è½¬æ¢ä¸ºæ±‚è§£ F(x, y)F(x,y) äº†ã€‚ä¸ºä»€ä¹ˆè¦åšè¿™ä¸€è½¬æ¢ï¼Ÿå› ä¸ºé€šè¿‡ä¹‹å‰çš„äº†è§£æˆ‘ä»¬ä¹Ÿå‘ç°åˆ†æ²»æ€æƒ³èƒ½å¤Ÿå¾ˆå¥½è§£å†³ä¸¤è€…ä¹‹é—´çš„å¤§å°å…³ç³»ï¼Œè€Œå¾ˆéš¾è§£å†³ä¸‰è€…ä¹‹é—´çš„å¤§å°å…³ç³»ã€‚è½¬æ¢ä¸ºå‰ç¼€å’Œåæˆ‘ä»¬å¤„ç†çš„ä¾¿æ˜¯ä¸¤è€…é—´çš„å¤§å°å…³ç³»äº†ã€‚

å¦å¤–æ—¢ç„¶è¦æ”¯æŒä¿®æ”¹ï¼Œé‚£ä¹ˆæ„å‘³ç€æ“ä½œä¹‹é—´çš„é¡ºåºä¸èƒ½å˜ã€‚è¿™ç­‰ä»·äºå¼•å…¥äº†æ—¶é—´ç»´åº¦ tï¼Œè¶Šæ—©å‡ºç°çš„æ“ä½œ t è¶Šå°ã€‚è¿™æ ·é—®é¢˜ä¾¿è¢«è½¬æ¢ä¸ºï¼Œè‹¥ $P_i: \langle t_i, x_i, y_i \rangle$ æ˜¯æŸ¥è¯¢ï¼Œåˆ™éœ€è®¡ç®—æ‰€æœ‰æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¿®æ”¹çš„å½±å“ä¹‹å’Œï¼š

- $t_j < t_i$
â€‹- $x_j \le x_i, \ y_j \le y_i$
 
Ummâ€¦ è¿™ä¸å°±æˆä¸€ä¸ªä¸‰ç»´ååºé—®é¢˜äº†å—ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»‹ç»è¿™ä¸€æ¨¡å‹çš„ä¸€ç§ç»å…¸åº”ç”¨ã€‚

**åŠ¨æ€åŒºé—´ä¸åŒå€¼**

    ???+note "[æ•°é¢œè‰²](https://www.luogu.com.cn/problemnew/show/P1903)"
    ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º n çš„åºåˆ—ï¼Œå…± q æ¬¡æ“ä½œã€‚éœ€è¦æ”¯æŒä¸¤ç§æ“ä½œï¼š

    - æŠŠä½ç½® i ä¸Šçš„æ•°ä¿®æ”¹ä¸º vï¼ˆä» 1 å¼€å§‹ç¼–å·ï¼‰ï¼›
    - æŸ¥è¯¢åŒºé—´ \[L, R\] å†…ä¸åŒçš„æ•°æœ‰å¤šå°‘ç§ã€‚

    æ•°æ®èŒƒå›´ï¼š$n \le 10^5, \ q \le 10^5$ ã€‚

ä¸‹é¢ç»™å‡ºä¸€ç‚¹æç¤ºï¼š

- è®° pre(i) ä»£è¡¨åœ¨ä½ç½® i å·¦è¾¹ä¸å®ƒæœ€è¿‘çš„æ•°å€¼ç›¸åŒçš„æ•°çš„ä½ç½®ï¼›
- å¯¹äºæ¯æ¬¡æŸ¥è¯¢åªè®¡ç®—æ»¡è¶³ $pre(ğ‘–) < L$ çš„ä½ç½®ä¸ªæ•°ï¼›
- $\langle l, 0 \rangle \le \langle i, pre(i) \rangle \le \langle r, l - 1 \rangle$ ã€‚

è‡³æ­¤æˆ‘ä»¬æˆåŠŸå¾—åˆ°äº†ä¸€ä¸ªäºŒç»´æ•°ç‚¹é—®é¢˜ã€‚

ä¸è¿‡æœ€åè¿˜æœ‰ä¸€ç‚¹é—®é¢˜ï¼Œæ¯æ¬¡ä¿®æ”¹ä¼šå½±å“ pre å€¼ã€‚ä¸è¿‡æˆ‘ä»¬å‘ç°æ¯æ¬¡ä¿®æ”¹è‡³å¤šå½±å“ 3 ä¸ªä½ç½®çš„ pre å€¼ï¼ˆå‡è®¾ä¿®æ”¹ä½ç½® iï¼Œé‚£ä¹ˆ pre(i)ã€åŸå…ˆå€¼çš„åç»§ å’Œ æ–°å€¼å‰é©±çš„åç»§ä¼šæ”¹å˜ï¼‰ï¼Œé‚£ä¹ˆæŒ‰å€¼å¼€ n ä¸ª std::set ç»´æŠ¤å³å¯ã€‚

æœ€åé™„ä¸Šä»£ç ä»¥ä¾›å‚è€ƒã€‚

???+note "å‚è€ƒä»£ç "

    ```cpp
    #include <bits/stdc++.h>
    using namespace std;

    #define SIZE 100010
    #define VAL_SIZE 1000010

    typedef struct _Query {
        int type;   // 0: Query+, 1: Query-, 2: Modify
        int x, y, val;

        bool operator < (const _Query & snd) const {
            if (x != snd.x)
                return x < snd.x;
            if (y != snd.y)
                return y < snd.y;
            return type > snd.type;
        }
    } Query;

    Query qArr[SIZE << 3]; 

    set<int> st[VAL_SIZE];

    int arr[SIZE], pre[SIZE], last[VAL_SIZE], bit[SIZE], ans[SIZE];

    int lowbit(int n) { 
        return n & -n;
    }

    void add(int pos, int val) {
        pos += 3;
        for (int i = pos; i < SIZE; i += lowbit(i))
            bit[i] += val;
    }

    int prefixSum(int pos) {
        int ret = 0; pos += 3;
        for (int i = pos; i > 0; i -= lowbit(i))
            ret += bit[i];
        return ret;
    }

    void divideConquer(int headPt, int tailPt) {
        if (headPt == tailPt)
            return;
        int midPt = (headPt + tailPt) >> 1;
        divideConquer(headPt, midPt);
        divideConquer(midPt + 1, tailPt);

        int j = headPt;
        for (int i = midPt + 1; i <= tailPt; i++) {
            if (qArr[i].type == 2)
                continue;
            for (; j <= midPt && qArr[j].x <= qArr[i].x; j++)
                if (qArr[j].type == 2)
                    add(qArr[j].y, qArr[j].val);
            ans[qArr[i].val] += (1 - (qArr[i].type << 1)) * prefixSum(qArr[i].y);
        }

        for (int i = headPt; i < j; i++)
            if (qArr[i].type == 2)
                add(qArr[i].y, -qArr[i].val);

        inplace_merge(qArr + headPt, qArr + midPt + 1, qArr + tailPt + 1);
    }

    int main() {
        ios::sync_with_stdio(false);
        cin.tie(0); cout.tie(0);
        memset(last, -1, sizeof(last));
        memset(bit, 0, sizeof(bit));
        int len, qNum, ansPt = 0, qPt = 0;
        cin >> len >> qNum;
        for (int i = 0; i < len; i++) {
            cin >> arr[i];
            pre[i] = last[arr[i]];
            qArr[qPt++] = {2, i, pre[i], 1};
            last[arr[i]] = i;
            st[arr[i]].insert(i);
        }

        for (int i = 0; i < qNum; i++) {
            char op; int x, y;
            cin >> op >> x >> y;
            x--;
            if (op == 'R') {  // Modify
                // Erase original
                qArr[qPt++] = {2, x, pre[x], -1};

                auto it = st[arr[x]].upper_bound(x);
                if (it != st[arr[x]].end()) {
                    qArr[qPt++] = {2, *it, pre[*it], -1};
                    pre[*it] = pre[x];
                    qArr[qPt++] = {2, *it, pre[*it], 1};
                }

                st[arr[x]].erase(x);

                // Insert new
                it = st[y].upper_bound(x);
                if (it != st[y].end()) {
                    pre[x] = pre[*it];
                    qArr[qPt++] = {2, x, pre[x], 1};
                    qArr[qPt++] = {2, *it, pre[*it], -1};
                    pre[*it] = x;
                    qArr[qPt++] = {2, *it, pre[*it], 1};
                } else {
                    if (st[y].empty()) {
                        pre[x] = -1;
                        qArr[qPt++] = {2, x, pre[x], 1};
                    } else {
                        it = prev(it);
                        pre[x] = *it;
                        qArr[qPt++] = {2, x, pre[x], 1}; 
                    }
                }

                st[y].insert(x);
                arr[x] = y;

            } else {    // Query
                y--;
                qArr[qPt++] = {0, y, x - 1, ansPt};
                qArr[qPt++] = {1, x - 1, x - 1, ansPt};
                ansPt++;
            }
        }

        divideConquer(0, qPt - 1);

        for (int i = 0; i < ansPt; i++)
            cout << ans[i] << '\n';
        return 0;
    }
    ```

**åŠ¨æ€æ›¼å“ˆé¡¿æœ€è¿‘ç‚¹å¯¹**

???+note "[å¤©ä½¿ç©å¶](https://www.luogu.com.cn/problem/P4169)"
    äºŒç»´å¹³é¢ä¸Šï¼Œæœ‰ q ç§æ“ä½œã€‚éœ€è¦æ”¯æŒä¸‰ç§æ“ä½œï¼š

    - æ·»åŠ ä¸€ä¸ªæ–°åæ ‡ç‚¹ (x, y)
    -åˆ é™¤ä¸€ä¸ªå·²æœ‰çš„åæ ‡ç‚¹ (x, y)
    - æŸ¥è¯¢è·ç¦» $(x_A, y_A)$ æ›¼å“ˆé¡¿è·ç¦»æœ€æ¥è¿‘çš„ç‚¹ã€‚

    æ•°æ®èŒƒå›´ï¼šå‡ä¸º $10^5$ æ•°é‡çº§ã€‚

A,B ä¸¤ç‚¹ä¹‹é—´çš„æ›¼å“ˆé¡¿è·ç¦»ï¼š

$dist(A, B) = |x_A - x_B| + |y_A - y_B|$

é¦–å…ˆçœ‹ç€è¿™ä¸ªç»å¯¹å€¼ç¬¦å·å°±å¾ˆä¸çˆ½ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å°†ç»å¯¹å€¼ç¬¦å·å»é™¤æ‰ã€‚æˆ‘ä»¬ä¸å¦¨å¯¹æ‰€æœ‰æƒ…å†µè¿›è¡Œè®¨è®ºè¯•ä¸€è¯•ï¼š

$\begin{cases} (x_A + y_A) - (x_B + y_B) & x_A \ge x_B, \ y_A \ge y_B \\ (x_A - y_A) - (x_B - y_B) & x_A \ge x_B, \ y_A < y_B \\ (-x_A + y_A) - (-x_B + y_B) & x_A < x_B, \ y_A \ge y_B \\ (-x_A - y_A) - (-x_B - y_B) & x_A < x_B, \ y_A < y_B \end{cases}$

ä¸éš¾å‘ç°å¯¹äºæ¯ä¸€æ¬¡è¯¢é—® $(x_A, y_A)$ è€Œè¨€ï¼Œä¸Šé¢å››ä¸ªå¼å­å‰åŠéƒ¨åˆ†éƒ½æ˜¯å®šå€¼ã€‚æ—¢ç„¶è¦æœ€å°åŒ–ç»“æœï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦è®©ååŠéƒ¨åˆ†æœ€å°å°±å¥½äº†ã€‚æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹è¿™å››ç§æƒ…å†µéƒ½åˆ†åˆ«è·‘ä¸€æ¬¡ CDQ åˆ†æ²»å¹¶ä¸”å–æœ€å°ç­”æ¡ˆå°±å¥½äº†ã€‚æŒ‰ç…§ x åæ ‡æ’åºï¼ŒæŒ‰ç…§ y åæ ‡å°† x+y æ’å…¥æ ‘çŠ¶æ•°ç»„ï¼Œå¹¶æ±‚å‡ºæ¯ä¸ªè¯¢é—®ç‚¹å·¦ä¸‹è§’æœ€å¤§çš„ x+y çš„å€¼

ä¸è¿‡ï¼Œåœ¨å®ç°çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªå°æŠ€å·§ã€‚æˆ‘ä»¬è¿˜å¯ä»¥å¯¹ä¸Šé¢çš„å››ç§æƒ…å†µè¿›è¡Œè¿›ä¸€æ­¥æ•´ç†ï¼š

$\begin{cases} (x_A + y_A) - (x_B + y_B) & x_A \ge x_B, \ y_A \ge y_B \\ (x_A + (\infty - y_A)) - (x_B + (\infty - y_B)) & x_A \ge x_B, \ (\infty - y_A) > (\infty - y_B) \\ ((\infty - x_A) + y_A) - ((\infty - x_B) + y_B) & (\infty - x_A) > (t - x_B), \ y_A \ge y_B \\ ((\infty - x_A) + (\infty - y_A)) - ((\infty - x_B) + (\infty - y_B)) & (\infty - x_A) > (\infty - x_B), \ (\infty - y_A) > (\infty - y_B) \end{cases}$

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæœ¬é¢˜æ˜¯å–æœ€å¤§å€¼ï¼Œå› æ­¤æŠŠä¸Šé¢å¼å­ä¸­çš„ >> æ¢æˆ \geâ‰¥ æ˜¯ä¸å½±å“ç­”æ¡ˆçš„ï¼›è€Œå¦‚æœæ˜¯è¦è®¡æ•°çš„è¯åˆ™éœ€è¦ç•™æ„è¿™ä¸€ç»†èŠ‚ã€‚

ä¸éš¾å‘ç°ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æŠŠå››ä¸ªå¼å­éƒ½è½¬æ¢æˆäº†å¦‚ä¸‹çš„å½¢å¼ï¼š

$x_A' + y_A' - (x_B' + y_B') \quad x_A' \ge x_B', \ y_A' \ge y_B'$

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µå°±å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¹å˜ä¸€ä¸‹ $x_A', y_A', x_B', y_B'$ çš„å€¼è·‘å››éä¸€ç§æƒ…å†µå³å¯ï¼Œè¿™æ ·æå¤§æ–¹ä¾¿äº†ä»£ç ç¼–å†™ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨é—®é¢˜è½¬åŒ–æˆäº†éœ€è¦æ”¯æŒä¸‹é¢ä¸¤ç§æ“ä½œï¼š

- æ’å…¥æ–°ç‚¹ (x, y)(x,y)ï¼›
- ç»™å®šç‚¹ $(x_A, y_A)$ï¼Œè¯¢é—®æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„ $(x_B, y_B)$ï¼š
    - $x_A \ge x_B, \ y_A \ge y_B$
    - $x_B + y_B$ å–å€¼æœ€å¤§ã€‚

å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¾ç„¶æ˜¯ä¸ªä¸‰ç»´ååºé—®é¢˜çš„å˜ç§ã€‚è‡³äºç»´æŠ¤æœ€å¤§å€¼ï¼Œæˆ‘ä»¬å…¶å®éœ€è¦ç»´æŠ¤çš„åªæ˜¯å‰ç¼€æœ€å¤§å€¼ï¼Œé­”æ”¹ä¸€ä¸‹æ ‘çŠ¶æ•°ç»„å°±å¥½äº†ã€‚

???+note "å‚è€ƒä»£ç "

    ```cpp
    #include "bits/stdc++.h"
    #define hhh printf("hhh\n")
    #define see(x) (cerr<<(#x)<<'='<<(x)<<endl)
    using namespace std;
    typedef long long ll;
    typedef pair<int,int> pr;
    inline int read() {int x=0;char c=getchar();while(c<'0'||c>'9')c=getchar();while(c>='0'&&c<='9')x=x*10+c-'0',c=getchar();return x;}

    const int maxn = 6e5+10;
    const int mod = 2e9+7;
    const double eps = 1e-9;
    const int maxx = 2e6+10;

    struct P{
        int f, x, y, id;
        P() {}
        P(int f, int x, int y, int id): f(f), x(x), y(y), id(id) {}
        bool operator < (const P &rhs) const {
            return x<rhs.x;
        }
    }a[maxn], a1[maxn];

    int n, m, mx, my, mm, nx;
    int b[maxx], ans[maxn];

    inline void max(int &x, int y) { if(x<y) x=y; }
    inline void min(int &x, int y) { if(x>y) x=y; }
    inline void clear(int x) { while(x<=mm) if(b[x]) b[x]=0, x+=x&-x; else return; }
    inline void update(int x, int d) { while(x<=mm) max(b[x],d), x+=x&-x; }
    inline int query(int x) { int ans=0; while(x) max(ans,b[x]), x-=x&-x; return ans;}

    void pre() {
        int mx=0, my=0; nx=0;
        for(int i=1; i<=n; ++i)
            if(a[i].f) max(mx,a[i].x), max(my,a[i].y);
        for(int i=1; i<=n; ++i)
            if(a[i].x<=mx&&a[i].y<=my) a[++nx]=a[i];
    }

    void solve(int l, int r) {
        if(l==r) return;
        int m=(l+r)/2;
        solve(l,m), solve(m+1,r);
        sort(a+l,a+m+1), sort(a+m+1,a+r+1);
        int j=l;
        for(int i=m+1; i<=r; ++i) {
            if(!a[i].f) continue;
            while(j<=m&&a[j].x<=a[i].x) {
                if(!a[j].f) update(a[j].y,a[j].x+a[j].y);
                ++j;
            }
            int tmp=query(a[i].y);
            if(tmp) min(ans[a[i].id],a[i].x+a[i].y-tmp);
        }
        while(--j>=l) if(!a[j].f) clear(a[j].y);
    }

    int main() {
        //ios::sync_with_stdio(false); cin.tie(0);
        n=read(), m=read();
        for(int i=1; i<=n; ++i) {
            int x=read()+1, y=read()+1;
            max(mx,x), max(my,y);
            a1[i]=P(0,x,y,i);
        }
        while(m--) {
            int f=read()-1, x=read()+1, y=read()+1;
            max(mx,x), max(my,y);
            ++n, a1[n]=P(f,x,y,n);
        }
        ++mx, ++my, mm=mx+my;

        for(int i=1; i<=n; ++i) a[i]=a1[i], ans[i]=1e9;
        pre(); solve(1,nx);
        for(int i=1; i<=n; ++i) a[i]=a1[i], a[i].x=mx-a[i].x;
        pre(); solve(1,nx);
        for(int i=1; i<=n; ++i) a[i]=a1[i], a[i].y=my-a[i].y;
        pre(); solve(1,nx);
        for(int i=1; i<=n; ++i) a[i]=a1[i], a[i].x=mx-a[i].x, a[i].y=my-a[i].y;
        pre(); solve(1,nx);

        for(int i=1; i<=n; ++i) if(a1[i].f) printf("%d\n", ans[i]);
    }
    ```

### ä¼˜åŒ–åŠ¨æ€è§„åˆ’

**ä¸‰ç»´ LIS**

???+note "[Pinball Game 3D](http://acm.hdu.edu.cn/showproblem.php?pid=4742)"
    ç»™å®šé•¿ä¸º n çš„ä¸‰å…ƒç»„åºåˆ— $p_i = \langle a_i, b_i, c_i \rangle$ï¼Œæ±‚å…¶æœ€é•¿çš„ä¸Šå‡å­åºåˆ—ã€‚

    æ•°æ®èŒƒå›´ï¼š$n \le 10^5, a_i, b_i, c_i \le 2^{30}$

å€ŸåŠ©åˆ†æ²»å¯¹ dp(i) è¿›è¡Œæ›´æ–°å°±è¡Œäº†~

é¦–å…ˆï¼ŒLIS çš„ DP æ–¹ç¨‹å¼å¾ˆå¥½å†™å‡ºï¼š

æˆ‘ä»¬è®° dp(i) ä»£è¡¨å‰ i ä¸ªå…ƒç´ æ‰€èƒ½æ„æˆçš„ LIS é•¿åº¦ï¼Œé‚£ä¹ˆå¯¹äºèƒ½å¤Ÿä½¿å¾— $\langle i, j \rangle$ æ„æˆååºå¯¹çš„ jï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹è½¬ç§»æ–¹ç¨‹æ¥æ›´æ–°ç­”æ¡ˆï¼š

$dp(i) = \max\limits_{j < i}\{dp(j)\} + 1$

ä½†æ˜¯åœ¨ DP æ—¶æˆ‘ä»¬éœ€è¦æ³¨æ„é¡ºåºé—®é¢˜ï¼Œæ¯”å¦‚é‡‡ç”¨ä¸Šé¢æ–¹ç¨‹çš„è¯æˆ‘ä»¬éœ€è¦ä»å·¦å¾€å³ DPï¼Œæ¢è¨€ä¹‹åœ¨æ›´æ–° dp(i) æ—¶ï¼Œ$\forall j < i$ ï¼Œå…¶ dp(j) åº”å½“éƒ½å·²è¢«è®¡ç®—å®Œæˆã€‚æ‰€ä»¥åœ¨è¿›è¡Œåˆ†æ²»çš„æ—¶å€™æˆ‘ä»¬è¦ â€œä¸­åºâ€ è¿›è¡Œï¼Œå³å…ˆå·¦åŒºé—´é€’å½’ï¼Œç„¶åè®¡ç®—å·¦å³ä¹‹é—´è´¡çŒ®ï¼Œæœ€åå†å³åŒºé—´é€’å½’ã€‚ç”±äºåŒæŒ‡é’ˆåˆå¹¶è¦æ±‚å·¦å³åŒºé—´æœ‰åºï¼Œå› æ­¤å·¦åŒºé—´é€’å½’åè¿˜éœ€å¯¹å³åŒºé—´è¿›è¡Œæ’åºï¼ŒåŒæ—¶é€’å½’å³åŒºé—´å‰è¿˜éœ€è¿˜åŸå³åŒºé—´çš„é¡ºåºã€‚

???+note "å‚è€ƒä»£ç â€œ

    ```cpp
    #include <bits/stdc++.h>
    using namespace std;

    #define SIZE 100010

    const int mod = 1 << 30;

    typedef struct _Node {
        int x, y, z;
    } Node;

    Node arr[SIZE], tmp[SIZE];

    pair<int, int> dp[SIZE], bit[SIZE];
    int dsc[SIZE], len;

    void upd(pair<int, int> & ret, const pair<int, int> & val) {
        if (ret.first < val.first)
            ret = val;
        else if (ret.first == val.first)
            ret.second += val.second, ret.second -= (ret.second >= mod ? mod : 0);
    }

    int lowbit(int n) {
        return n & -n;
    }

    void addMax(int pos, const pair<int, int> & val) {
        pos++;
        for (int i = pos; i <= len; i += lowbit(i))
            upd(bit[i], val);
    }

    void clear(int pos) {
        pos++;
        for (int i = pos; i <= len; i += lowbit(i))
            bit[i] = make_pair(0, 0);
    }

    pair<int, int> prefixMax(int pos) {
        pair<int, int> ret = make_pair(0, 0); pos++;
        for (int i = pos; i > 0; i -= lowbit(i))
            upd(ret, bit[i]);
        return ret;
    }

    bool cmpSnd(const Node & fst, const Node & snd) {
        if (fst.y != snd.y)
            return fst.y < snd.y;
        return fst.z < snd.z;
    }

    bool cmpFst(const Node & fst, const Node & snd) {
        if (fst.x != snd.x)
            return fst.x < snd.x;
        return cmpSnd(fst, snd);
    }

    void divideConquer(int headPt, int tailPt) {
        if (headPt == tailPt)
            return;

        int midPt = (headPt + tailPt) >> 1;
        divideConquer(headPt, midPt);
        
        copy(arr + midPt + 1, arr + tailPt + 1, tmp + midPt + 1);
        sort(arr + midPt + 1, arr + tailPt + 1, cmpSnd);

        int j = headPt;
        for (int i = midPt + 1; i <= tailPt; i++) {
            for (; j <= midPt && arr[j].y <= arr[i].y; j++)
                addMax(arr[j].z, dp[arr[j].x]);
            
            pair<int, int> ret = prefixMax(arr[i].z); ret.first++;
            upd(dp[arr[i].x], ret);
        }

        for (int i = headPt; i <= j; i++)
            clear(arr[i].z);

        copy(tmp + midPt + 1, tmp + tailPt + 1, arr + midPt + 1);
        divideConquer(midPt + 1, tailPt);
        inplace_merge(arr + headPt, arr + midPt + 1, arr + tailPt + 1, cmpSnd);
    }

    int main() {
        ios::sync_with_stdio(false);
        cin.tie(0); cout.tie(0);

        int caseNum; cin >> caseNum;
        while (caseNum--) {
            cin >> len;
            fill(bit + 0, bit + len, make_pair(0, 0));
            for (int i = 0; i < len; i++) {
                cin >> arr[i].x >> arr[i].y >> arr[i].z;
                dsc[i] = arr[i].z;
            }

            sort(arr + 0, arr + len, cmpFst);
            sort(dsc + 0, dsc + len);
            int dscLen = unique(dsc + 0, dsc + len) - dsc;

            for (int i = 0; i < len; i++) {
                arr[i].z = lower_bound(dsc + 0, dsc + dscLen, arr[i].z) - dsc;
                arr[i].x = i; dp[i] = make_pair(1, 1);
            }

            divideConquer(0, len - 1);

            pair<int, int> ans = make_pair(0, 0);
            for (int i = 0; i < len; i++)
                upd(ans, dp[i]);
            cout << ans.first << " " << ans.second << endl; 
        }

        return 0;
    }
    ```

### å°ç»“

é€šè¿‡ä¸Šé¢çš„ä¾‹é¢˜ï¼Œæˆ‘ä»¬å¤§è‡´é¢†ç•¥äº† CDQ åˆ†æ²»è¿™ä¸€æ€æƒ³çš„å‡ ä¸ªç¥å¥‡ä½œç”¨ï¼Œå³ ä»¥ $\mathcal{O}(\log{n})$ å¤æ‚åº¦çš„ä»£ä»·ï¼š

- å°†åŒºé—´å†…çš„é—®é¢˜è½¬åŒ–ä¸ºä¸¤ä¸ªæœ‰åºåŒºé—´ä¹‹é—´çš„é—®é¢˜ï¼›
- å°†é«˜ç»´çš„é—®é¢˜ç»´åº¦é™ä½ä¸€ç»´ï¼›
- å°†åŠ¨æ€æ•°æ®ç»“æ„é—®é¢˜è½¬åŒ–æˆé™æ€æ•°æ®ç»“æ„é—®é¢˜ã€‚

## çº¿æ®µæ ‘åˆ†æ²»

å‰é¢ä¹Ÿæåˆ°äº†åŠ¨æ€æ•°æ®ç»“æ„é—®é¢˜å¸¦æœ‰ä¿®æ”¹æ“ä½œï¼Œè€Œä¿®æ”¹æ“ä½œä¹Ÿå¯ä»¥è¢«åˆ†ä¸ºæ’å…¥å’Œåˆ é™¤ä¸¤ç§ã€‚å¦‚æœæ’å…¥å’Œåˆ é™¤éƒ½æ¯”è¾ƒå¥½å®ç°çš„è¯ï¼Œé‚£ä¹ˆè¿ç”¨ä¸Šé¢çš„ CDQ åˆ†æ²»å°±å¯ä»¥å®¹æ˜“æ±‚è§£é—®é¢˜äº†ã€‚ä½†æ˜¯å†æœ‰çš„é¢˜ç›®é‡Œé¢ï¼Œæ’å…¥å¾ˆå¥½å®ç°ï¼Œä½†æ˜¯åˆ é™¤å´éš¾ä»¥å®ç°ã€‚æ¯”å¦‚å¹¶æŸ¥é›†ç»´æŠ¤å›¾çš„è¿é€šæ€§æ—¶ï¼Œæ·»åŠ è¾¹å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœè¦åˆ é™¤è¾¹å°±ä¼šå¾ˆå¤æ‚ï¼ˆå› ä¸ºå¹¶æŸ¥é›†é‡Œé¢åªç»´æŠ¤äº†è¿é€šæ€§è€Œæ²¡æœ‰ç»´æŠ¤åŸå›¾æœ¬èº«ï¼‰ã€‚åœ¨è¿™ç§æ—¶å€™ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥è€ƒè™‘ç”¨çº¿æ®µæ ‘åˆ†æ²»ä»¥ $\mathcal{O}(\log{n})$ çš„ä»£ä»·æŠŠå¸¦æœ‰æ’å…¥å’Œåˆ é™¤çš„é—®é¢˜è½¬åŒ–ä¸ºåªå¸¦æ’å…¥çš„é—®é¢˜ã€‚

ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬ç›´æ¥ä¸Šä¸€é“ç»å…¸ä¾‹é¢˜ã€‚

**åŠ¨æ€äºŒåˆ†å›¾åˆ¤å®š**

???+note "[äºŒåˆ†å›¾](https://darkbzoj.tk/problem/4025)"
    ç»™å®šä¸€å¼  n ä¸ªç‚¹çš„å›¾ï¼Œåœ¨ T æ—¶é—´å†…ä¸€äº›è¾¹ä¼šåœ¨ $s_i$ æ—¶åˆ»å‡ºç°ï¼Œå¹¶åœ¨ $t_i$ æ—¶åˆ»æ¶ˆå¤±ã€‚è¯¢é—®æ¯ä¸€ä¸ªæ—¶åˆ»è¯¥å›¾æ˜¯å¦æ˜¯äºŒåˆ†å›¾ã€‚

    æ•°æ®èŒƒå›´ï¼šå‡åœ¨ $10^5$ çº§åˆ«ã€‚

é¦–å…ˆï¼Œåˆ¤æ–­æ˜¯å¦æ„æˆäºŒåˆ†å›¾çš„æœ¬è´¨å³åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¥‡ç¯ã€‚ä¸€å¼ æ— å‘å›¾ä¸å­˜åœ¨å¥‡ç¯æ˜¯è¯¥å›¾ä¸ºäºŒåˆ†å›¾çš„å……è¦æ¡ä»¶ã€‚é‚£ä¹ˆå¦‚ä½•ç»´æŠ¤å¥‡ç¯ä¿¡æ¯ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨å¸¦æƒçš„å¹¶æŸ¥é›†è§£å†³ï¼Œå³åœ¨å¹¶æŸ¥é›†ä¸­è®°å½•ä¸€ä¸ªæ·±åº¦ï¼Œå¦‚æœåœ¨è¿è¾¹æ—¶ä¸¤ç‚¹æ·±åº¦åŠ èµ·æ¥åœ¨åŠ  1 æ˜¯å¥‡æ•°çš„è¯ï¼Œå°±è¯´æ˜å­˜åœ¨å¥‡ç¯äº†ï¼ˆå¤§å®¶å¯ä»¥æƒ³æƒ³ä¸ºä»€ä¹ˆï¼‰ã€‚

ç°åœ¨é—®é¢˜æ¥äº†ï¼Œå¹¶æŸ¥é›†ä¸­åŠ è¾¹å®¹æ˜“åˆ è¾¹éš¾ï¼Œè¿™å¯æ€ä¹ˆåŠ QAQã€‚

é¦–å…ˆï¼Œå¯¹äºå…ƒç´ åˆæœ‰æ’å…¥åˆæœ‰åˆ é™¤è¿™ä¸€ç‰¹æ€§ï¼Œè¯´æ˜æ¯ä¸€ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªå­˜æ´»çš„æ—¶é—´åŒºé—´ï¼ˆåœ¨è¿™é“é¢˜é‡Œé¢æ˜¯ç›´æ¥æŠŠå­˜æ´»åŒºé—´ç»™å‡ºäº†ï¼‰ã€‚å¯¹äºæ›´ä¸€èˆ¬çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å¯¹äºæ¯ä¸€ä¸ªå…ƒç´ é¢„å¤„ç†å‡ºæ—¶é—´åŒºé—´ï¼Œç„¶åå¯¹æ—¶é—´åŒºé—´è¿›è¡Œåˆ†æ²»ã€‚

å‡è®¾ä¸€å…±æœ‰ q æ¬¡è¯¢é—®ï¼ˆå³ q ä¸ªäº‹ä»¶ï¼‰ï¼Œè€ƒè™‘å¯¹å®Œæ•´æ—¶é—´åŒºé—´ \[1, q\] å»ºä¸€æ£µçº¿æ®µæ ‘ï¼Œé‚£ä¹ˆå¯¹äºæ—¶é—´ç‚¹çš„è¯¢é—®å³è¯¢é—®è¿™æ£µçº¿æ®µæ ‘çš„å¶å­èŠ‚ç‚¹ä¸Šçš„çŠ¶æ€ï¼›è€Œå¯¹äºè¾¹çš„ä¿®æ”¹åˆ™æ˜¯å¯¹çº¿æ®µæ ‘ä¸Šå¯¹åº”åŒºé—´ä¸Šçš„ä¿®æ”¹ã€‚è¿™æ ·é—®é¢˜å°±è½¬æ¢ä¸ºå¯¹äºä¸€ä¸ªæ—¶é—´åŒºé—´åŠ è¾¹å’ŒæŸ¥è¯¢å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±ä¸å­˜åœ¨åˆ è¾¹è¿™ç§æ“ä½œäº†ã€‚è€Œæ•´ä¸ªåˆ†æ²»è¿‡ç¨‹æœ¬è´¨ä¸Šå°±æ˜¯å¯¹è¿™ä¸€æ£µçº¿æ®µæ ‘åšå…ˆåºéå†ã€‚

solve(l,r,Q)ï¼šå¯¹äºæ—¶åˆ» \[l, r\]ï¼Œæ“ä½œé›†ä¸º Qï¼Œæ»¡è¶³ $\forall q \in Q$ ï¼Œå…¶å­˜æ´»æ—¶é—´åŒºé—´ä¸å½“å‰åˆ†æ²»çš„æ—¶é—´åŒºé—´äº¤é›†éç©ºï¼›è€Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨ä¸ºå¯¹äº \[l, r\] å†…æ¯ä¸ªæ—¶åˆ»ï¼Œåˆ¤æ–­æ­¤æ—¶å›¾æ˜¯å¦æ˜¯äºŒåˆ†å›¾ã€‚æ“ä½œé›† Q ä¸­å…ƒç´  q å¸¦æœ‰ 4 ä¸ªå±æ€§ï¼š$\langle u, v, l, r \rangle$ ã€‚å…¶ä¸­ï¼Œu,v ä»£è¡¨è¾¹çš„ä¸¤ä¸ªç«¯ç‚¹ï¼Œè€Œ l,r ä»£è¡¨å‡ºç°å’Œæ¶ˆå¤±æ—¶åˆ»ã€‚æˆ‘ä»¬å¯ä»¥è€ƒè™‘å¦‚ä¸‹ç®—æ³•ï¼š

- $mid = \frac{1}{2} (l + r)$ï¼Œå¹¶æ–°å»ºä¸¤ä¸ªç©ºæ“ä½œé›† $Q_L, Q_R$
- éå† $q \in Q$
    - è‹¥ $q.l = l \land q.r = r$ï¼ˆè¯´æ˜è¿™ä¸€æ“ä½œå¯¹å…¶å­æ ‘ä¸­æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½æœ‰å½±å“ï¼Œé‚£ä¹ˆç›´æ¥åŠ è¾¹ï¼‰ï¼š
        - å¹¶æŸ¥é›†ä¸­åˆå¹¶ q.u å’Œ q.vï¼Œå¹¶åˆ¤æ–­æ˜¯å¦å‡ºç°å¥‡ç¯ï¼›
        - å­˜åœ¨å¥‡ç¯ï¼Ÿè¯´æ˜æ—¶é—´åŒºé—´ \[l, r]\ éƒ½å‡‰äº†ï¼Œå‡æ ‡è®°ç­”æ¡ˆä¸ºå¦ï¼æ’¤é”€å¯¹å¹¶æŸ¥é›†çš„æ“ä½œå¹¶å›æº¯ï¼ˆæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯æ’¤é”€å¹¶æŸ¥é›†ï¼Œå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æä¸€ä¸ªæ ˆè®°å½•ä¸€ä¸‹æ“ä½œä¹‹å‰å€¼çš„æƒ…å†µç„¶åæ’¤é”€çš„æ—¶å€™å¼¹æ ˆå°±å¥½äº†ï¼‰ï¼›
    - è‹¥ $q.l \le mid$ ï¼šä»¤ $q.r = \minâ¡(q.r, mid)$ï¼Œå¹¶æŠŠ q æ”¾å…¥ $Q_L$
    - è‹¥ $q.r > mid$ ï¼š$q.l = \maxâ¡(q.l, mid + 1)$ ï¼Œå¹¶æŠŠ q æ”¾å…¥ $Q_R$
- è‹¥ l = rï¼Œæ ‡è®°ç­”æ¡ˆä¸ºæ˜¯ï¼Œæ’¤é”€å¯¹å¹¶æŸ¥é›†çš„æ“ä½œå¹¶å›æº¯ï¼›
- $solve(l, mid, Q_L)$
- $solve(mid + 1, r, Q_R)$
- æ’¤é”€å¯¹å¹¶æŸ¥é›†çš„æ“ä½œå¹¶å›æº¯ã€‚

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±æˆåŠŸé¿å…äº†åˆ é™¤æ“ä½œï¼Œä»è€Œæ›´å®¹æ˜“åœ°å¾—ä»¥è§£å†³é—®é¢˜ã€‚

æœ€åé™„ä¸Š[æˆ‘çš„ä»£ç ](https://github.com/codgician/Competitive-Programming/blob/master/BZOJ/4025/divide_and_conquer_disjoint_set_heuristic.cpp) ä»¥ä¾›å‚è€ƒã€‚æˆ‘çš„å†™æ³•å®é™…ä¸Šæ˜¯æ²¡æœ‰å»ºå‡ºçº¿æ®µæ ‘çš„ï¼Œå½“ç„¶ä¹Ÿæœ‰å¦å¤–å»ºå‡ºçº¿æ®µæ ‘çš„å†™æ³•ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å»äº†è§£ä¸€ä¸‹ã€‚

**è™šå‡çš„å¼ºåˆ¶åœ¨çº¿**

è¿™ä¸€å¯å‘æ¥è‡ªäº Codeforces ä¸Šä¸€é“æœ‰è¶£çš„é¢˜ç›®ã€‚

???+note "[Forced Online Queries Problem](https://codeforces.com/contest/1217/problem/F)"
    ç»™å®šä¸€ä¸ªåˆå§‹æ— è¾¹çš„å«æœ‰ n ä¸ªç‚¹çš„æ— å‘å›¾ï¼ˆæ ‡å·ä» 1 å¼€å§‹ï¼‰ï¼Œå…± q æ¬¡æ“ä½œã€‚æ“ä½œæœ‰ä¸¤ç§å½¢å¼ï¼ˆå…¶ä¸­ last ä»£è¡¨ä¸Šä¸€æ¬¡ 2 ç±»æ“ä½œçš„ç»“æœï¼‰ï¼š

    - $1 \ x \ y \ (1 \le x, y \le n, \ x \neq y)$ ï¼šåœ¨ç‚¹ $(x + last - 1) \bmod (n + 1)$ å’Œç‚¹ $(y + last - 1) \bmod (n + 1)$ é—´æ·»åŠ ä¸€æ¡æ— å‘è¾¹ï¼›
    - $2 \ x \ y \ (1 \le x, y \le n, \ x \neq y)$ ï¼šæŸ¥è¯¢ç‚¹ $(x + last - 1) \bmod (n + 1)$ å’Œç‚¹ $(y + last - 1) \bmod (n + 1)$ æ˜¯å¦è¿é€šã€‚

    æ•°æ®èŒƒå›´ï¼š$2 \le n, q \le 10^5$
 
è™½è¯´è¿™é“é¢˜çœ‹èµ·æ¥å¼ºåˆ¶åœ¨çº¿äº†ï¼Œä½†æ˜¯ $last \in [0, 1]$ ï¼Œå…¶å®å¯èƒ½çš„æ“ä½œç§æ•°é¡¶å¤šå°± 2q ä¸ªã€‚å› æ­¤æˆ‘ä»¬ä¸å¦¨è€ƒè™‘æŠŠæ‰€æœ‰æ“ä½œéƒ½åŠ å…¥çº¿æ®µæ ‘åˆ†æ²»ï¼Œç„¶åå¤„ç†çš„æ—¶å€™åªé€‰å–æœ‰æ•ˆçš„é‚£ä¸ªå¤„ç†ã€‚

ä½†æ˜¯æ€ä¹ˆåˆ¤è¿™ä¸ªæœ‰æ•ˆå‘¢ï¼Ÿæˆ‘ä»¬æ˜¯ä¸æ˜¯åªæœ‰åœ¨æ‰§è¡Œå®Œå…¶ä¹‹å‰æœ€æ¥è¿‘çš„ 2 ç±»æ“ä½œæ‰èƒ½çŸ¥é“å½“å‰æ“ä½œå“ªä¸€ä¸ªæœ‰æ•ˆã€‚æ¢è¨€ä¹‹ï¼Œåªè¦åœ¨åˆ†æ²»è¿‡ç¨‹ä¸­èƒ½ä¿è¯åœ¨å¤„ç†æ¯ä¸€æ¡è¾¹å‰åœ¨å…¶å‰é¢çš„ 2 ç±»æ“ä½œå·²ç»è¢«å¤„ç†è¿‡å°±è¡Œäº†ã€‚ç”±äºæŸ¥è¯¢éƒ½åœ¨å¶å­ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å•ç‹¬å¼€ä¸€ä¸ªæ•°ç»„è®°å½•ç¬¬ i æ—¶åˆ»çš„æŸ¥è¯¢æ˜¯ä»€ä¹ˆï¼ˆå³ç›´æ¥è®°å½•åœ¨çº¿æ®µæ ‘çš„å¶å­ä¸Šï¼‰ã€‚

æˆ‘ä»¬å¯ä»¥æ–½åŠ ä¸€ç‚¹å°æŠ€å·§ã€‚åŸæœ¬è¾¹çš„å‡ºç°æ—¶é—´æ˜¯åŒºé—´ (s, t)ï¼Œæˆ‘ä»¬ç°åœ¨æŠŠå®ƒæ”¹æˆ (s + 1, t)ã€‚è¿™ä¸€ä¿®æ”¹å¯¼è‡´çš„ç»“æœéå¸¸å¾®å¦™ï¼šé¦–å…ˆï¼Œåœ¨ s æ—¶åˆ»çš„æ“ä½œå…¶å®æ˜¯åŠ è¾¹ï¼Œä¸ä¼šåŒæ—¶è¿›è¡ŒæŸ¥è¯¢ï¼Œå› æ­¤è¿™ä¸€ä¿®æ”¹ä¸ä¼šå½±å“ç­”æ¡ˆï¼›å…¶æ¬¡ï¼Œè¿™æ ·çš„ä¿®æ”¹ä¿è¯äº†æˆ‘ä»¬åœ¨æŠŠè¿™ä¸€æ¡è¾¹åŠ å…¥å¹¶æŸ¥é›†æ˜¯ï¼Œs æ—¶åˆ»å¯¹åº”çš„å¶å­èŠ‚ç‚¹ä¸€å®šæ˜¯è¢«éå†è¿‡çš„ï¼Œå³æˆ‘ä»¬å·²ç»çŸ¥é“äº† last ç¡®åˆ‡çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­å‡ºå“ªäº›æ“ä½œæ˜¯æœ‰æ•ˆçš„äº†ã€‚

è¯¦ç»†çš„å®ç°å¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹[æˆ‘çš„ä»£ç ](https://github.com/codgician/Competitive-Programming/blob/master/Codeforces/1217F/divide_and_conquer_disjoint_set_heuristic.cpp)ã€‚

## åŸºäºæ•°å€¼çš„ç¦»çº¿åˆ†æ²»

### æ•´ä½“äºŒåˆ†

å¤§å®¶å¯¹äºäºŒåˆ†ç®—æ³•å¤§æ¦‚æ˜¯éå¸¸ç†Ÿæ‚‰çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ¥è§¦åˆ°çš„ä¼ ç»Ÿçš„äºŒåˆ†å¾€å¾€æ˜¯é’ˆå¯¹å•ä¸ªè¯¢é—®è¿›è¡ŒäºŒåˆ†ã€‚è€Œæ•´ä½“äºŒåˆ†åˆ™æ›´è¿›ä¸€æ­¥ï¼Œå¯¹å¤šä¸ªåŒç±»æ“ä½œï¼ˆåŒ…æ‹¬ä¿®æ”¹å’ŒæŸ¥è¯¢ï¼‰ä¸€èµ·äºŒåˆ†ç­”æ¡ˆï¼ŒåŒæ—¶ä¾æ®å½“å‰äºŒåˆ†çš„åˆ¤å®šå€¼å¯¹å½“å‰æ“ä½œé›†è¿›è¡Œåˆ†ç±»ï¼Œå†åº”ç”¨åˆ†æ²»æ€æƒ³åˆ†è€Œæ²»ä¹‹ã€‚è€Œè¿™ä¸€ç®—æ³•çš„ç»å…¸åº”ç”¨å³ä¸ºåŒºé—´ç¬¬ k å°ã€‚æˆ‘ä»¬ä¸å¦¨ä»¥å…¶ä½œä¸ºä¾‹å­æ¥ä»‹ç»æ•´ä½“äºŒåˆ†ã€‚

**é™æ€åŒºé—´ç¬¬ k å°** 

???+note "[Kth Number](http://bailian.openjudge.cn/practice/2104/)"
    å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°åˆ—ï¼Œç°æœ‰ q æ¬¡è¯¢é—®ã€‚æ¯æ¬¡è¯¢é—®ç»™å‡º l, r, kï¼Œè¯•æ±‚æ•°åˆ—ä¸­ä¸‹æ ‡åœ¨ \[l, r\] ä¸­ç¬¬ k å°çš„æ•°çš„æ•°å€¼ã€‚

    æ•°æ®èŒƒå›´ï¼š$1 \le n \le 10^5, \ 1 \le q \le 5 \times 10^3$

å¦‚æœæ˜¯å¯¹äºå•æ¬¡æŸ¥è¯¢ï¼Œæˆ‘ä»¬æ˜¾ç„¶æ˜¯å¯ä»¥å…ˆå¯¹åŒºé—´è¿›è¡Œé¢„å¤„ç†ç„¶åè¿›è¡ŒäºŒåˆ†çš„ã€‚ä¸€ç§æ˜¾è€Œæ˜“è§çš„æ€è·¯å°±æ˜¯å°†æ•°å€¼ç¦»æ•£åŒ–ç„¶åå¼€ä¸€ä¸ªæ•°ç»„æ¥è®°å½•æ¯ä¸€ä¸ªå€¼åœ¨åŒºé—´å†…å‡ºç°çš„æ¬¡æ•°ç„¶åå¯¹å‰ç¼€å’Œè¿›è¡ŒäºŒåˆ†ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬é¢å¯¹å¤šä¸ªè¯¢é—®çš„æ—¶å€™ï¼Œå¦‚æœå¯¹æ¯ä¸€ä¸ªè¯¢é—®éƒ½è¿›è¡Œé¢„å¤„ç†ç„¶åå†äºŒåˆ†ï¼Œè¿™æ ·çš„å¤æ‚åº¦æ˜¾ç„¶æ˜¯æ— æ³•æ¥å—çš„ã€‚

ä¸éš¾å‘ç°å¯¹äºæ¯ä¸ªè¯¢é—®å…¶å®é¢„å¤„ç†çš„è¿‡ç¨‹éƒ½æ˜¯å¤§è‡´ç›¸åŒçš„ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥å¯¹å¤šä¸ªè¯¢é—®åŒæ—¶è¿›è¡ŒäºŒåˆ†æ“ä½œå‘¢ï¼Ÿ

å‡è®¾é¢˜ç›®ç»™å®šäº†ç”± n ä¸ªè¯¢é—®ç»„æˆçš„ä¸€ä¸ªè¯¢é—®é›†åˆ Qï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“æ‰€æœ‰å‡ºç°è¿‡çš„æ•°å€¼çš„åŒºé—´ä¸º \[l, r\]ã€‚äºŒåˆ†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è®° $mid = \frac{1}{2}(l+r)$ ã€‚åœ¨æ¯ä¸€å±‚é€’å½’ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹äº Q å†…æ¯ä¸€ä¸ªè¯¢é—®è¿›è¡Œå¤„ç†ï¼Œæ±‚å¾—è¯¥è¯¢é—®åŒºé—´ä¸­æ•°å€¼åœ¨ \[l, mid\] èŒƒå›´å†…çš„å€¼çš„ä¸ªæ•° cntã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»¥æ­¤å°† Q ä¸­çš„è¯¢é—®åˆ†ä¸ºä¸¤ç±»ï¼š$cnt \ge k$ çš„ä»¥åŠ $cnt < k$ çš„ã€‚æˆ‘ä»¬ç”¨ $Q_1$ å’Œ $Q_2$ æ¥è¡¨ç¤ºè¿™ä¸¤ç±»è¯¢é—®ã€‚

å¯¹äº $Q_1$â€‹ ä¸­çš„è¯¢é—®ï¼Œæˆ‘ä»¬æ˜¾ç„¶å¯ä»¥åœ¨ \[l, mid\] è¿™ä¸€èŒƒå›´ä¸­æ±‚å¾—ç­”æ¡ˆã€‚æ¢å¥è¯è¯´ï¼Œ\[l, r\] çš„ç¬¬ k å°å³ \[l, mid\] ä¸­çš„ç¬¬ k å°ï¼›è€Œå¯¹äº $Q_2$ ä¸­çš„è¯¢é—®ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¾—çŸ¥ç­”æ¡ˆåè½äº (mid, r] è¿™ä¸€èŒƒå›´ä¸­ã€‚æ˜¾ç„¶ï¼Œæ±‚ \[l, r\] ä¸­çš„ç¬¬ k å°ç­‰ä»·äºæ±‚ (mid, r] ä¸­çš„ç¬¬ kâˆ’cnt å°ï¼ˆæˆ‘ä»¬éœ€è¦å‰”é™¤ [l, mid) ä¸­çš„æ•°ï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé—®é¢˜ Q æ‹†åˆ†æˆ $Q_1$ å’Œ $Q_2$ ä¸¤ä¸ªå­é—®é¢˜ç„¶åå¯¹å®ƒä»¬è¿›è¡Œåˆ†æ²»å¹¶é€’å½’æ±‚è§£ã€‚é€’å½’ç»“æŸäº l = rï¼Œè®°æ­¤æ—¶çš„è¯¢é—®é›†ä¸º $Q'$ ï¼Œåˆ™ $Q'$ ä¸­çš„æ‰€æœ‰è¯¢é—®çš„ç­”æ¡ˆå³ä¸º rï¼Œä¾¿å¯ä»¥æ±‚è§£é—®é¢˜äº†ã€‚

æˆ‘ä»¬æœ€åéœ€è¦è§£å†³çš„é—®é¢˜ä¾¿æ˜¯å¦‚ä½•æ±‚å¾— cnt äº†ã€‚æˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†åŸå§‹æ•°åˆ—ä¸­çš„æ•°å€¼ç¦»æ•£åŒ–ï¼Œç„¶åç”¨ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„æ¥ç»´æŠ¤è¿™ä¸€ä¿¡æ¯ã€‚æ ‘çŠ¶æ•°ç»„çš„ç¬¬ i ä½è¡¨ç¤ºæ•°åˆ—ä¸­ç¬¬ i ä½ä¸Šçš„å€¼æ˜¯å¦åè½äº \[l, mid\] èŒƒå›´å†…ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨æ ‘çŠ¶æ•°ç»„ä¸Šæ±‚\[L, R\] åŒºé—´çš„åŒºé—´å’Œä¾¿å¯ä»¥å¾—çŸ¥ä¸‹æ ‡ \[L, R\] é—´æœ‰å¤šå°‘ä¸ªæ•°åè½äº \[l, mid\] èŒƒå›´å†…ï¼Œå³ cntã€‚

å…·ä½“å®ç°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®°å½•æ•°åˆ—ä¸­æ¯ä¸ªæ•°çš„åŸå§‹ä¸‹æ ‡åå¯¹æ•°åˆ—æŒ‰æ•°å€¼ä»å°åˆ°å¤§æ’åºã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æœç´¢å¿«é€ŸæŸ¥æ‰¾åˆ° l çš„ä½ç½®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿å¯ä»¥è½»æ¾åœ°å¯¹äº \[l, mid\] ä¸­çš„æ¯ä¸ªå€¼æ›´æ–°æ ‘çŠ¶æ•°ç»„ä¸­çš„ä¿¡æ¯ã€‚å†æ±‚å¾— cnt åæˆ‘ä»¬å†é€ä¸€æ’¤é”€æˆ‘ä»¬æ–¹æ‰å¯¹æ ‘çŠ¶æ•°ç»„è¿›è¡Œçš„æ›´æ”¹ä»¥ä¸ºæ¥ä¸‹æ¥é€’å½’ä¸­æ±‚ cnt åšå‡†å¤‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ’¤é”€æ›´æ”¹æ—¶ä¸å¯ä»¥ç›´æ¥ç”¨ memsetï¼Œè‹¥æ˜¯å¦‚æ­¤æ¯ä¸€æ¬¡é¢„å¤„ç†å°±ä¸åŸæ•°ç»„é•¿åº¦æœ‰å…³è€Œå¹¶éä¸å½“å‰äºŒåˆ†åŒºé—´æœ‰å…³äº†ï¼Œè€Œè¿™ä¼šå¯¼è‡´å¤æ‚åº¦çš„å˜åŒ–ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸€è¿‡ç¨‹å¤æ‚åº¦æ˜¯ $\mathcal{O}(m\log{n})$ çš„ï¼Œå…¶ä¸­ m æ˜¯å½“å‰äºŒåˆ†åŒºé—´çš„é•¿åº¦ã€‚æ€»çš„å¤æ‚åº¦æ˜¯ $\mathcal{O}(n\log^2{n})$ çº§åˆ«çš„ã€‚

æœ€åé™„ä¸Š[æˆ‘çš„ä»£ç ](https://github.com/codgician/Competitive-Programming/blob/master/POJ/2104/overall_binary_search_binary_indexed_tree.cpp) ä»¥ä¾›å‚è€ƒã€‚

???+note "å‚è€ƒä»£ç "

    ```cpp
    #include <bits/stdc++.h>
    using namespace std;

    #define SIZE 100100

    typedef struct _Node {
        int val, id;
        bool operator < (const struct _Node & snd) const {
            return val < snd.val;
        }
    } Node;

    Node arr[SIZE];

    typedef struct _Query {
        int qLeftPt, qRightPt, k;
        int id, cnt;
    } Query;

    Query qArr[SIZE], bkt[SIZE];
    int ans[SIZE], bit[SIZE], len, qNum;

    int lowbit(int n) {
        return n & -n;
    }

    void add(int pos, int val) {
        for (int i = pos; i <= len; i += lowbit(i))
            bit[i] += val;
    }

    int getPrefixSum(int pos) {
        int ret = 0;
        for (int i = pos; i > 0; i -= lowbit(i))
            ret += bit[i];
        return ret;
    }

    void divideConquer(int headPt, int tailPt, int leftPt, int rightPt) {
        if (leftPt == rightPt) {
            for (int i = headPt; i <= tailPt; i++)
                ans[qArr[i].id] = rightPt;
            return;
        }
        int midPt = (leftPt + rightPt) >> 1;
        // First element that is not smaller than leftPt
        int pos = lower_bound(arr + 0, arr + len, Node{leftPt, -1}) - arr;
        // Update BIT
        for (int i = pos; i < len && arr[i].val <= midPt; i++)
            add(arr[i].id + 1, 1);
        // Calculate cnt
        for (int i = headPt; i <= tailPt; i++)
            qArr[i].cnt = getPrefixSum(qArr[i].qRightPt + 1) - getPrefixSum(qArr[i].qLeftPt);
        // Restore BIT
        for (int i = pos; i < len && arr[i].val <= midPt; i++)
            add(arr[i].id + 1, -1);
        // Divide And Conquer
        int bktHeadPt = headPt, bktTailPt = tailPt;
        for (int i = headPt; i <= tailPt; i++) {
            if (qArr[i].cnt >= qArr[i].k) {
                bkt[bktHeadPt++] = qArr[i];
            } else {
                qArr[i].k -= qArr[i].cnt;
                bkt[bktTailPt--] = qArr[i];
            }
        }
        for (int i = headPt; i <= tailPt; i++)
            qArr[i] = bkt[i];
        if (bktHeadPt != headPt)
            divideConquer(headPt, bktHeadPt - 1, leftPt, midPt);
        if (bktTailPt != tailPt)
            divideConquer(bktTailPt + 1, tailPt, midPt + 1, rightPt);
    }

    int main() {
        ios::sync_with_stdio(false);
        cin.tie(0); cout.tie(0);
        while (cin >> len >> qNum) {
            memset(bit, 0, sizeof(bit));
            int minVal = INT_MAX, maxVal = INT_MIN;
            for (int i = 0; i < len; i++) {
                cin >> arr[i].val;
                minVal = min(minVal, arr[i].val);
                maxVal = max(maxVal, arr[i].val);
                arr[i].id = i;
            }
            sort(arr + 0, arr + len);
            for (int i = 0; i < qNum; i++) {
                cin >> qArr[i].qLeftPt >> qArr[i].qRightPt >> qArr[i].k;
                qArr[i].qLeftPt--; qArr[i].qRightPt--;
                qArr[i].id = i; qArr[i].cnt = 0;
            }
            divideConquer(0, qNum - 1, minVal, maxVal);
            for (int i = 0; i < qNum; i++)
                cout << ans[i] << '\n';
        }
        return 0;
    }
    ```

**åŠ¨æ€åŒºé—´ç¬¬ k å°**

???+note "[Dynamic Rankings](https://zoj.pintia.cn/problem-sets/91827364500/problems/91827365611)"
    å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°åˆ—ï¼Œç°æœ‰ä¸¤ç±»å…± q æ¬¡æ“ä½œï¼š

    - å°†ç¬¬ i ä¸ªæ•°çš„å€¼ä¿®æ”¹ä¸º vï¼›
    - è¯¢é—®ç¬¬ l ä¸ªæ•°å’Œç¬¬ r ä¸ªæ•°ä¹‹é—´ç¬¬ k å°çš„æ•°å€¼ã€‚

    æ•°æ®èŒƒå›´ï¼š$1 \le n \le 5 \times 10^4, \ 1 \le q \le 10^4$

æœ¬é¢˜ä¸ä¸Šä¸€ä¾‹å”¯ä¸€çš„åŒºåˆ«ä¾¿åœ¨äºæ–°åŠ å…¥äº†ä¿®æ”¹æ“ä½œï¼Œè¿™æ ·ä¸€æ¥ä¸Šä¾‹ä¸­çš„è¯¢é—®é›† Q åœ¨æœ¬é¢˜ä¸­å°±å˜æˆå¯ä»¥å«æœ‰è¯¢é—®åŠä¿®æ”¹ä¸¤ç§æ“ä½œçš„æ“ä½œé›†äº†ã€‚æˆ‘ä»¬ä¸å¦¨æŠŠæ¯ä¸ªä¿®æ”¹æ“ä½œæ‹†æˆä¸¤æ­¥ï¼šå…ˆåˆ é™¤è¯¥ä½ç½®ä¸ŠåŸå€¼ï¼Œå†åœ¨è¯¥ä½ç½®ä¸Šæ’å…¥æ–°å€¼ã€‚åŒæ—¶ï¼Œåºåˆ—çš„åˆå§‹åŒ–ä¹Ÿå¯çœ‹ä½œ n æ¬¡åœ¨ä½ç½® i æ’å…¥æ–°å€¼ã€‚

æˆ‘ä»¬æ³¨æ„åˆ°æ¯ä¸€æ¬¡ä¿®æ”¹æ“ä½œå…¶å®å¯¹ç­”æ¡ˆçš„è´¡çŒ®æ˜¯ç‹¬ç«‹çš„ã€‚å…·ä½“åœ°è¯´ï¼Œå‡è®¾äºŒåˆ†è¿‡ç¨‹ä¸­å½“å‰æŸåŒºé—´å€¼åŸŸä¸º \[L, R\] ï¼Œå½“å‰äºŒåˆ†åŒºé—´ä¸º \[l, r\] ã€‚æˆ‘ä»¬è‹¥æ˜¯å°†è¯¥åŒºé—´å†…æŸä½ç½®ä¸Šçš„å€¼ç”± $a_i$ æ”¹å˜ä¸º $a_i' \ (l \le a_i' \le r)$ ï¼Œå¹¶ä¸ä¼šæ”¹å˜ \[l, r\] ä»¥å¤–çš„åŒºé—´ï¼ˆå³ [L, l) å’Œ (r, R] è¿™ä¸¤ä¸ªåŒºé—´å¯¹ç­”æ¡ˆçš„è´¡çŒ®ã€‚ ç”±æ­¤ï¼Œæ¯ä¸€æ¬¡é¢„å¤„ç†çš„å¤æ‚åº¦ä¾ç„¶ä»…ä»…æ˜¯ä¸å½“å‰äºŒåˆ†åŒºé—´æœ‰å…³çš„ï¼Œå¯ä»¥ä½¿ç”¨æ•´ä½“äºŒåˆ†ã€‚

æ•…æˆ‘ä»¬ä¾ç„¶é‡‡ç”¨ä¸ä¸Šä¾‹ç±»ä¼¼çš„æ€è·¯å¯¹æ‰€æœ‰æ“ä½œè¿›è¡ŒäºŒåˆ†ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œç”±äºä¿®æ”¹è¿™ä¸€æ“ä½œçš„å¼•å…¥ï¼Œæˆ‘ä»¬ä¸èƒ½éšæ„æ”¹å˜æ“ä½œçš„é¡ºåºã€‚å› æ­¤ï¼ŒåŒºåˆ«ä»…ä»…åœ¨äºæ±‚ cnt è¿™ä¸€è¿‡ç¨‹çš„å®ç°ã€‚æˆ‘ä»¬ä¸èƒ½å†åƒä¹‹å‰ä¸€æ ·å…ˆå¯¹å€¼æ’åºç„¶åäºŒåˆ†ï¼Œå› ä¸ºé‚£æ ·ä¼šæ”¹å˜æ“ä½œçš„é¡ºåºã€‚å¯¹äº Q å†…çš„æ“ä½œï¼Œæˆ‘ä»¬å¿…é¡»æŒ‰ç…§åŸé¡ºåºè¿›è¡Œéå†ï¼ŒæŸ¥è¯¢å’Œä¿®æ”¹åŒæ—¶è¿›è¡Œï¼ˆè‹¥æ“ä½œä¸ºä¿®æ”¹ï¼Œåªåº”ç”¨å€¼åœ¨ \[l,mid\] åŒºé—´ä¹‹å†…çš„ï¼‰ã€‚å¦å¤–åœ¨å°† Q åˆ†ç±»ä¸º $Q_1$ å’Œ $Q_2$ æ—¶ä¹Ÿè¦å•ç‹¬å¼€ä¸¤ä¸ªå•ç‹¬çš„ç©ºé—´æ¥è¿›è¡Œåˆ†ç±»ä»¥é˜²æ­¢æ”¹å˜æ“ä½œä¹‹é—´çš„é¡ºåºã€‚

æœ€åé™„ä¸Š[æˆ‘çš„ä»£ç ](https://github.com/codgician/Competitive-Programming/blob/master/ZOJ/2112/overall_binary_search_edit_binary_indexed_tree.cpp)ä»¥ä¾›å‚è€ƒã€‚

???+note "å‚è€ƒä»£ç "

    ```cpp
    #include <bits/stdc++.h>
    using namespace std;

    #define SIZE 50010
    #define QUE_SIZE 10010
    #define OPR_SIZE 70010

    // If k == 0: modify;
    // qLeftPt = pos, qRightPt = val, cnt = type (-1: delete | 1: add)
    typedef struct _Opr {
        int qLeftPt, qRightPt, k;   // pos, val, 0
        int qId, cnt;            // -1, type
    } Opr;

    Opr oprArr[OPR_SIZE], fstBkt[OPR_SIZE], sndBkt[OPR_SIZE];
    int arr[SIZE], ans[QUE_SIZE], bit[SIZE], len;

    int lowbit(int n) {
        return n & -n;
    }

    void add(int pos, int val) {
        for (int i = pos; i <= len; i += lowbit(i))
            bit[i] += val;
    }

    int prefixSum(int pos) {
        int ret = 0;
        for (int i = pos; i > 0; i -= lowbit(i))
            ret += bit[i];
        return ret;
    }

    void divideConquer(int headPt, int tailPt, int leftPt, int rightPt) {
        if (leftPt == rightPt) {
            for (int i = headPt; i <= tailPt; i++) {
                if (oprArr[i].k == 0)   // Skip modifications
                    continue;
                ans[oprArr[i].qId] = rightPt;
            }
            return;
        }

        int midPt = (leftPt + rightPt) >> 1;

        // Update BIT && Calculate cnt
        for (int i = headPt; i <= tailPt; i++) {
            if (oprArr[i].k > 0)    // query
                oprArr[i].cnt = prefixSum(oprArr[i].qRightPt + 1) - prefixSum(oprArr[i].qLeftPt);
            else if (oprArr[i].qRightPt <= midPt)   // modify
                add(oprArr[i].qLeftPt + 1, oprArr[i].cnt);
        }

        // Restore BIT
        for (int i = headPt; i <= tailPt; i++)
            if (oprArr[i].k == 0 && oprArr[i].qRightPt <= midPt)
                add(oprArr[i].qLeftPt + 1, -oprArr[i].cnt);

        // Divide And Conquer
        int fstPt = 0, sndPt = 0;
        for (int i = headPt; i <= tailPt; i++) {
            if (oprArr[i].k > 0) {
                // query
                if (oprArr[i].k <= oprArr[i].cnt) {
                    fstBkt[fstPt++] = oprArr[i];
                } else {
                    oprArr[i].k -= oprArr[i].cnt;
                    sndBkt[sndPt++] = oprArr[i];
                }
            } else {
                // modify
                if (oprArr[i].qRightPt <= midPt)
                    fstBkt[fstPt++] = oprArr[i];
                else
                    sndBkt[sndPt++] = oprArr[i];
            }
        }
        for (int i = 0; i < fstPt; i++)
            oprArr[headPt + i] = fstBkt[i];
        for (int i = 0; i < sndPt; i++)
            oprArr[headPt + fstPt + i] = sndBkt[i];
        if (fstPt > 0)
            divideConquer(headPt, headPt + fstPt - 1, leftPt, midPt);
        if (sndPt > 0)
            divideConquer(headPt + fstPt, tailPt, midPt + 1, rightPt);
    }

    int main() {
        ios::sync_with_stdio(false);
        cin.tie(0); cout.tie(0);
        int caseNum;
        cin >> caseNum;
        while (caseNum--) {
            memset(bit, 0, sizeof(bit));
            int qNum, oprPt = 0, qPt = 0, minVal = INT_MAX, maxVal = 0;
            cin >> len >> qNum;
            for (int i = 0; i < len; i++) {
                // treat original array as insertions
                cin >> arr[i];
                minVal = min(minVal, arr[i]);
                maxVal = max(maxVal, arr[i]);
                oprArr[oprPt++] = {i, arr[i], 0, -1, 1};
            }
            for (int i = 0; i < qNum; i++) {
                char opr; cin >> opr;
                if (opr == 'Q') {
                    int qLeftPt, qRightPt, k;
                    cin >> qLeftPt >> qRightPt >> k;
                    qLeftPt--, qRightPt--;
                    oprArr[oprPt++] = {qLeftPt, qRightPt, k, qPt++, 0};
                } else if (opr == 'C') {
                    int pos, val;
                    cin >> pos >> val;
                    pos--;
                    // delete
                    oprArr[oprPt++] = {pos, arr[pos], 0, -1, -1};
                    // insert
                    oprArr[oprPt++] = {pos, val, 0, -1, 1};
                    arr[pos] = val;
                    minVal = min(minVal, val);
                    maxVal = max(maxVal, val);
                }
            }
            divideConquer(0, oprPt - 1, minVal, maxVal);
            for (int i = 0; i < qPt; i++)
                cout << ans[i] << endl;
        }
        return 0;
    }
    ```