author: HeRaNO, Zhoier, Ir1d, Xeonacid, wangdehu, ouuan, ranwen, ananbaobeichicun, Ycrpro

## å¼•å…¥

æ ‘çŠ¶æ•°ç»„ã€çº¿æ®µæ ‘è¿™ä¸¤ç§æ•°æ®ç»“æ„ç”¨æ¥è§£å†³ä¸€ä¸ªå¸¸è§çš„åº”ç”¨é—®é¢˜ï¼šé«˜æ•ˆç‡åœ°æŸ¥è¯¢å’Œç»´æŠ¤å‰ç¼€å’Œ(æˆ–è€…åŒºé—´å’Œ)ã€‚

æ‰€è°“æŸ¥è¯¢å‰ç¼€å’Œï¼Œå³ç»™å‡ºé•¿åº¦ä¸ºnçš„æ•°åˆ—ğ´=ğ‘1,ğ‘2,...,ğ‘ğ‘›å’Œä¸€ä¸ªæŸ¥è¯¢ğ‘¥â‰¤ğ‘›ï¼Œæ±‚ğ‘ ğ‘¢ğ‘š(ğ‘¥)=ğ‘1+...+ğ‘ğ‘¥ã€‚åŒºé—´\[i, j\]çš„å’Œå¯ä»¥é€šè¿‡å‰ç¼€å’Œæ±‚å¾—ï¼šğ‘ğ‘–+...+ğ‘ğ‘—=ğ‘ ğ‘¢ğ‘š(ğ‘—)âˆ’ğ‘ ğ‘¢ğ‘š(ğ‘–âˆ’1)ã€‚

å¦‚æœæ•°åˆ—ğ´æ˜¯é™æ€ä¸å˜çš„ï¼Œä»£ç å¾ˆå¥½å†™ï¼Œé¢„å¤„ç†å‰ç¼€å’Œå°±å¥½äº†ï¼Œä¸€æ¬¡é¢„å¤„ç†çš„å¤æ‚åº¦æ˜¯O(n)çš„ï¼Œç„¶åæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯O(1)çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœåºåˆ—æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œä¾‹å¦‚æ”¹å˜å…¶ä¸­ä¸€ä¸ªå…ƒç´ ğ‘ğ‘˜çš„å€¼ï¼Œé‚£ä¹ˆå®ƒåé¢çš„å‰ç¼€å’Œéƒ½ä¼šæ”¹å˜ï¼Œéœ€è¦é‡æ–°è®¡ç®—ï¼Œå¦‚æœæ¯æ¬¡æŸ¥è¯¢å‰å…ƒç´ éƒ½æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆä¸€æ¬¡æŸ¥è¯¢çš„çš„å¤æ‚åº¦å°±å˜æˆäº†O(n)ã€‚

æœ‰ä¸¤ç§æ•°æ®ç»“æ„å¯ä»¥é«˜æ•ˆåœ°å¤„ç†è¿™ä¸ªé—®é¢˜ï¼šæ ‘çŠ¶æ•°ç»„ã€çº¿æ®µæ ‘ã€‚å®ƒä»¬å®ç°çš„ä¸¤ä¸ªåŠŸèƒ½ï¼šæŸ¥è¯¢å‰ç¼€å’Œã€ä¿®æ”¹å…ƒç´ å€¼ï¼Œå¤æ‚åº¦éƒ½æ˜¯ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)çš„ã€‚

åœ¨å­¦ä¹ çº¿æ®µæ ‘å’Œæ ‘çŠ¶æ•°ç»„ä¹‹å‰ï¼Œè¯»è€…å¯ä»¥è‡ªå·±æ€è€ƒå¦‚ä½•å®ç°ç”¨ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)çš„å¤æ‚åº¦å®ç°æŸ¥è¯¢å’Œç»´æŠ¤å‰ç¼€å’Œã€‚æ€è·¯å¹¶ä¸éš¾å¾—åˆ°ï¼Œæ ¹æ®äºŒåˆ†æ³•æˆ–è€…åˆ†æ²»æ³•ï¼ŒæŠŠæ•´ä¸ªæ•°åˆ—åˆ†ä¸ºä¸¤åŠï¼Œç„¶åæ¯éƒ¨åˆ†å†ç»§ç»­åˆ†ä¸ºä¸¤åŠ......è¿™æ ·ä¸€æ¥ï¼ŒæŸ¥è¯¢å’Œä¿®æ”¹éƒ½èƒ½ä»¥ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)çš„å¤æ‚åº¦å¾—åˆ°è§£å†³ã€‚è¿™å°±æ˜¯çº¿æ®µæ ‘å’Œæ ‘çŠ¶æ•°ç»„çš„åŸºæœ¬æ€è·¯ï¼Œçº¿æ®µæ ‘å·®ä¸å¤šé‡ç°äº†è¿™ä¸ªæ€è·¯ï¼Œè€Œæ ‘çŠ¶æ•°ç»„å€ŸåŠ©ä¸€ä¸ªç¥å¥‡çš„ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡()æ“ä½œæ¥ç®€æ´åœ°å®ç°ã€‚çº¿æ®µæ ‘çš„ç¼–ç è¦æ›´å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯ä¹Ÿæ›´é€šç”¨ã€‚

æ ‘çŠ¶æ•°ç»„å’Œçº¿æ®µæ ‘å…·æœ‰ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä»–ä¿©æ¯•ç«Ÿè¿˜æœ‰ä¸€äº›åŒºåˆ«ï¼šæ ‘çŠ¶æ•°ç»„èƒ½æœ‰çš„æ“ä½œï¼Œçº¿æ®µæ ‘ä¸€å®šæœ‰ï¼›çº¿æ®µæ ‘æœ‰çš„æ“ä½œï¼Œæ ‘çŠ¶æ•°ç»„ä¸ä¸€å®šæœ‰ã€‚æ ‘çŠ¶æ•°ç»„åªèƒ½å¤„ç†å…·æœ‰é€†è¿ç®—çš„è¿ç®—ï¼Œä¾‹å¦‚åŠ ã€å‡ã€å¼‚æˆ–è¿ç®—ï¼Œä¸èƒ½å¤„ç†ç±»ä¼¼äºæ±‚æœ€å¤§å€¼ã€æœ€å°å€¼çš„è¿ç®—ï¼ˆå®é™…ä¸Šä½¿ç”¨ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„å¯ä»¥ç”¨äºå¤„ç†æœ€å¤§ã€å°å€¼çš„é—®é¢˜ï¼Œè§ [Efficient Range Minimum Queries using Binary Indexed Trees](http://history.ioinformatics.org/oi/files/volume9.pdf#page=41)ï¼‰ã€‚ä½†æ˜¯æ ‘çŠ¶æ•°ç»„çš„ä»£ç è¦æ¯”çº¿æ®µæ ‘çŸ­ï¼Œæ€ç»´æ›´æ¸…æ™°ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«ï¼Œåœ¨è§£å†³ä¸€äº›å•ç‚¹ä¿®æ”¹çš„é—®é¢˜æ—¶ï¼Œæ ‘çŠ¶æ•°ç»„æ˜¯ä¸äºŒä¹‹é€‰ã€‚

æ ‘çŠ¶æ•°ç»„ä¸»è¦ç”¨äºå¤„ç†ï¼š**å•ç‚¹ä¿®æ”¹åŒºé—´æŸ¥è¯¢** çš„é—®é¢˜ã€‚ä½¿ç”¨å·®åˆ†æ•°ç»„å’Œè¾…åŠ©æ•°ç»„å¯ä»¥å°†æ ‘çŠ¶æ•°ç»„åº”ç”¨äº **åŒºé—´ä¿®æ”¹å•ç‚¹æŸ¥è¯¢** å’Œ **åŒºé—´ä¿®æ”¹åŒºé—´æŸ¥è¯¢** çš„é—®é¢˜ã€‚

æœ¬èŠ‚ä»‹ç»æ ‘çŠ¶æ•°ç»„çš„æ¦‚å¿µå’ŒåŸºæœ¬ä»£ç ï¼Œç„¶åç»™å‡ºå®ƒçš„ç»å…¸åº”ç”¨ï¼šåŒºé—´ä¿®æ”¹+å•ç‚¹æŸ¥è¯¢ã€åŒºé—´ä¿®æ”¹+åŒºé—´æŸ¥è¯¢ã€äºŒç»´åŒºé—´ä¿®æ”¹+åŒºé—´æŸ¥è¯¢ã€åŒºé—´æœ€å€¼ã€‚

## æ ‘çŠ¶æ•°ç»„çš„å•ç‚¹ä¿®æ”¹åŒºé—´æŸ¥è¯¢

### è¿‡ç¨‹

æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Tree, BITï¼‰ï¼Œä»å®ƒçš„è‹±æ–‡åå¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯åˆ©ç”¨æ•°çš„äºŒè¿›åˆ¶ç‰¹å¾è¿›è¡Œæ£€ç´¢çš„ä¸€ç§æ ‘çŠ¶çš„ç»“æ„ã€‚

å¦‚ä½•åˆ©ç”¨äºŒåˆ†çš„æ€æƒ³é«˜æ•ˆåœ°æ±‚å‰ç¼€å’Œï¼Ÿä»¥A = {a1,a2,...,a8}è¿™8ä¸ªå…ƒç´ ä¸ºä¾‹ï¼Œå·¦å›¾æ˜¯äºŒå‰æ ‘çš„ç»“æ„ï¼Œå³è¾¹æŠŠå®ƒç”»æˆæ ‘çŠ¶ã€‚

![](./images/bit-1.png)

å³å›¾åœ†åœˆä¸­æ ‡è®°æœ‰æ•°å­—çš„ç»“ç‚¹ï¼Œå­˜å‚¨çš„æ˜¯ç§°ä¸ºæ ‘çŠ¶æ•°ç»„çš„tree\[\]ã€‚ä¸€ä¸ªç»“ç‚¹ä¸Šçš„tree\[\]çš„å€¼ï¼Œå°±æ˜¯å®ƒæ ‘ä¸‹çš„ç›´è¿çš„å­ç»“ç‚¹çš„å’Œã€‚ä¾‹å¦‚ `ğ‘¡ğ‘Ÿğ‘’ğ‘’[1]=ğ‘1ï¼Œğ‘¡ğ‘Ÿğ‘’ğ‘’[2]=ğ‘¡ğ‘Ÿğ‘’ğ‘’[1]+ğ‘2ï¼Œğ‘¡ğ‘Ÿğ‘’ğ‘’[3]=ğ‘3ï¼Œğ‘¡ğ‘Ÿğ‘’ğ‘’[4]=ğ‘¡ğ‘Ÿğ‘’ğ‘’[2]+ğ‘¡ğ‘Ÿğ‘’ğ‘’[3]+ğ‘4ï¼Œ...ï¼Œğ‘¡ğ‘Ÿğ‘’ğ‘’[8]=ğ‘¡ğ‘Ÿğ‘’ğ‘’[4]+ğ‘¡ğ‘Ÿğ‘’ğ‘’[6]+ğ‘¡ğ‘Ÿğ‘’ğ‘’[7]+ğ‘8`ã€‚

åˆ©ç”¨tree\[\]ï¼Œå¯ä»¥é«˜æ•ˆåœ°å®Œæˆä¸‹é¢ä¸¤ä¸ªæ“ä½œï¼š

ï¼ˆ1ï¼‰æŸ¥è¯¢ï¼Œå³æ±‚å‰ç¼€å’Œsumï¼Œä¾‹å¦‚ï¼š`sum(8) = tree[8]ï¼Œsum(7) = tree[7] + tree[6] + tree[4]ï¼Œsum(6) = tree[6] + tree[4]`ã€‚å³å›¾ä¸­çš„è™šçº¿ç®­å¤´æ˜¯è®¡ç®—sum(7)çš„è¿‡ç¨‹ã€‚æ˜¾ç„¶ï¼Œè®¡ç®—çš„å¤æ‚åº¦æ˜¯O(logn)çš„ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†å¿«é€Ÿè®¡ç®—å‰ç¼€å’Œçš„ç›®çš„ã€‚

ï¼ˆ2ï¼‰ç»´æŠ¤ã€‚tree\[\]æœ¬èº«çš„ç»´æŠ¤ä¹Ÿæ˜¯é«˜æ•ˆçš„ã€‚å½“å…ƒç´ ğ‘å‘ç”Ÿæ”¹å˜æ—¶ï¼Œèƒ½ä»¥ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)çš„é«˜æ•ˆç‡ä¿®æ”¹tree\[\]çš„å€¼ã€‚ä¾‹å¦‚æ›´æ–°äº†ğ‘3ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹`tree[3]ã€tree[4]ã€tree[8]...`ï¼Œå³ä¿®æ”¹å®ƒå’Œå®ƒä¸Šé¢çš„é‚£äº›ç»“ç‚¹ï¼šçˆ¶ç»“ç‚¹ï¼ˆå³ğ‘¥+=ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘¥)ï¼‰ä»¥åŠçˆ¶ç»“ç‚¹çš„çˆ¶ç»“ç‚¹ã€‚

æœ‰äº†æ–¹æ¡ˆï¼Œå‰©ä¸‹çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•å¿«é€Ÿè®¡ç®—å‡ºtree\[\]ï¼Ÿè§‚å¯ŸæŸ¥è¯¢å’Œç»´æŠ¤ä¸¤ä¸ªæ“ä½œï¼Œå‘ç°ï¼š

ï¼ˆ1ï¼‰æŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œæ˜¯æ¯æ¬¡å»æ‰äºŒè¿›åˆ¶çš„æœ€åçš„1ã€‚ä¾‹å¦‚æ±‚`sum(7) = tree[7] + tree[6] + tree[4]`ï¼Œæ­¥éª¤æ˜¯ï¼š

    1. 7çš„äºŒè¿›åˆ¶æ˜¯111ï¼Œå»æ‰æœ€åçš„1ï¼Œå¾—110ï¼Œå³tree[6]ï¼›
    2. å»æ‰6çš„äºŒè¿›åˆ¶110çš„æœ€åä¸€ä¸ª1ï¼Œå¾—100ï¼Œå³tree[4]ï¼›
    3. çš„äºŒè¿›åˆ¶æ˜¯100ï¼Œå»æ‰1ä¹‹åå°±æ²¡æœ‰äº†ã€‚

ï¼ˆ2ï¼‰ç»´æŠ¤çš„è¿‡ç¨‹ï¼Œæ˜¯æ¯æ¬¡åœ¨äºŒè¿›åˆ¶çš„æœ€åçš„1ä¸ŠåŠ 1ã€‚ä¾‹å¦‚æ›´æ–°äº†a3ï¼Œéœ€è¦ä¿®æ”¹`tree[3]ã€tree[4]ã€tree[]8...`ç­‰ç­‰ï¼Œæ­¥éª¤æ˜¯ï¼š

    1. 3çš„äºŒè¿›åˆ¶æ˜¯11ï¼Œåœ¨æœ€åçš„1ä¸ŠåŠ ä¸Š1å¾—100ï¼Œå³4ï¼Œä¿®æ”¹tree[4]ï¼›
    2. 4çš„äºŒè¿›åˆ¶æ˜¯100ï¼Œåœ¨æœ€åçš„1ä¸ŠåŠ 1ï¼Œå¾—1000ï¼Œå³8ï¼Œä¿®æ”¹tree[]8ï¼›
    3. ç»§ç»­ä¿®æ”¹tree[16]ã€tree[32]...ç­‰ç­‰ã€‚

æœ€åï¼Œæ ‘çŠ¶æ•°ç»„å½’ç»“åˆ°ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šå¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªæ•°çš„äºŒè¿›åˆ¶çš„æœ€åä¸€ä¸ª1ã€‚

* * *

**ä»¥ä¸‹ä¸ºOI Wikiè€ç‰ˆæœ¬è§£é‡Š**

ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºäº†æ ‘çŠ¶æ•°ç»„çš„å·¥ä½œåŸç†ï¼š

![](./images/fenwick.svg)

è¿™ä¸ªç»“æ„å’Œ [çº¿æ®µæ ‘](./seg.md) æœ‰äº›ç±»ä¼¼ï¼šç”¨ä¸€ä¸ªå¤§èŠ‚ç‚¹è¡¨ç¤ºä¸€äº›å°èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œè¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™åªéœ€è¦æŸ¥è¯¢ä¸€äº›å¤§èŠ‚ç‚¹è€Œä¸æ˜¯æ‰€æœ‰çš„å°èŠ‚ç‚¹ã€‚

æœ€ä¸‹é¢çš„å…«ä¸ªæ–¹å—å°±ä»£è¡¨åŸå§‹æ•°æ®æ•°ç»„ $a$ã€‚ä»–ä»¬ä¸Šé¢çš„å‚å·®ä¸é½çš„æ–¹å—ï¼ˆä¸æœ€ä¸Šé¢çš„å…«ä¸ªæ–¹å—æ˜¯åŒä¸€ä¸ªæ•°ç»„ï¼‰ä»£è¡¨æ•°ç»„ $a$ çš„ä¸Šçº§â€”â€”$c$ æ•°ç»„ã€‚$c$ æ•°ç»„ç”¨æ¥ç®¡ç†åŸå§‹æ•°æ®æ•°ç»„ $a$ æŸä¸€åŒºé—´çš„å’Œã€‚

ä¾‹å¦‚ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼š  
$c_{2}$ ç®¡ç†çš„æ˜¯ $a_{1}$ï¼Œ$a_{2}$ï¼›  
$c_{4}$ ç®¡ç†çš„æ˜¯ $a_{1}$ï¼Œ$a_{2}$ï¼Œ$a_{3}$ï¼Œ$a_{4}$ï¼›  
$c_{6}$ ç®¡ç†çš„æ˜¯ $a_{5}$ï¼Œ$a_{6}$ï¼›  
$c_{7}$ ç®¡ç†çš„æ˜¯ $a_{7}$ï¼›  
$c_{8}$ åˆ™ç®¡ç†å…¨éƒ¨ $8$ ä¸ªæ•°ã€‚

å¦‚æœè¦è®¡ç®—æ•°ç»„ $a$ çš„åŒºé—´å’Œï¼Œæ¯”å¦‚è¯´è¦ç®—åŒºé—´å’Œ $\sum a_{4}...a_{7}$ï¼Œå¯ä»¥å…ˆè®¡ç®—å¾—åˆ° $\sum a_{1}...a_{3}$ å†è®¡ç®—å¾—åˆ° $\sum a_{1}...a_{7}$ï¼Œå°†åè€…å‡å»å‰è€…å¾—åˆ° $\sum a_{4}...a_{7}$ã€‚åœ¨è®¡ç®— $\sum a_{1}...a_{3}$ å’Œ $\sum a_{1}...a_{7}$ æ—¶å¯ä»¥é‡‡ç”¨ç±»ä¼¼å€å¢çš„æ€æƒ³ã€‚  
ä¾‹å¦‚ï¼Œè®¡ç®— $\sum a_{1}...a_{7}$ çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š  
ä» $c_{7}$ å¼€å§‹å¾€å‰è·³ï¼Œå‘ç° $c_{7}$ åªç®¡ç† $a_{7}$ è¿™ä¸ªå…ƒç´ ï¼›é‚£ä¹ˆä½ å°±ä¼šæ‰¾ $c_{6}$ï¼Œå‘ç° $c_{6}$ ç®¡ç†çš„æ˜¯ $a_{5}$ï¼Œ$a_{6}$ è¿™ä¸¤ä¸ªå…ƒç´ ï¼›é‚£ä¹ˆä½ å°±ä¼šç›´æ¥è·³åˆ° $c_{4}$ï¼Œå‘ç° $c_{4}$ å°±ç®¡ç†çš„æ˜¯ $a_{1}ï¼Œa_{2}ï¼Œa_{3}ï¼Œa_{4}$ è¿™äº›å…ƒç´ ï¼Œè‡³æ­¤å·²ç»åˆ°è¾¾å…ƒç´  $a_{1}$ï¼Œè¯´æ˜æ­¤æ—¶å·²ç»å¾—åˆ°ç›®æ ‡å€¼ $\sum a_{1}...a_{7}$ã€‚  
è®¡ç®— $\sum a_{1}...a_{3}$ çš„è¿‡ç¨‹ä¹‹ç±»ä¼¼ï¼›

![](images/fenwick-query.svg)

### å®ç°

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆçŸ¥é“ $c_{x}$ ç®¡ç†çš„æ•°ç»„ $a$ ä¸­çš„å“ªä¸ªåŒºé—´å‘¢ï¼Ÿ  
ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè‹¥ $x\%(2^{n})==0$ï¼Œ$n$ å–æœ€å¤§æ•´æ•°å€¼ï¼Œé‚£ä¹ˆ $c_{x}$ ç®¡ç†çš„åŒºé—´é•¿åº¦ä¸º $2^{n}$ã€‚è€Œ $n$ æ°å¥½ä¸º $x (x>=1)$ äºŒè¿›åˆ¶è¡¨ç¤ºæ—¶æœ€ä½ä½ç¬¬ä¸€ä¸ª `1` çš„å³è¾¹ `0` çš„ä¸ªæ•°ã€‚

ä¾‹å¦‚ï¼š$x=6$ æ—¶ï¼Œ$6_{(10)}=0110_{(2)}$ï¼Œæœ€ä½ä½ `1` çš„å³è¾¹ `0` çš„ä¸ªæ•°ä¸º $n=1$ã€‚å› æ­¤ $c_{6}$ ç®¡ç†çš„åŒºé—´é•¿åº¦ä¸º $2^{1}=2$ï¼Œé‚£ä¹ˆ $c_{x}$ ç®¡ç†çš„åŒºé—´å³ä¸ºï¼š$a_{5}ï¼Œa_{6}$ã€‚

ä¸ºäº†ä¾¿äºè®¡ç®— $x (x>=1)$ å¯¹åº”çš„ $2^{n}$ï¼Œå¼•å…¥ä¸€ä¸ªå‡½æ•°â€”â€”`lowbit(int)`ï¼š

ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘¥)=ğ‘¥ & âˆ’ğ‘¥ï¼ŒåŠŸèƒ½æ˜¯æ‰¾åˆ°xçš„äºŒè¿›åˆ¶æ•°çš„æœ€åä¸€ä¸ª1ã€‚å…¶åŸç†æ˜¯åˆ©ç”¨äº†è´Ÿæ•°çš„è¡¥ç è¡¨ç¤ºï¼Œè¡¥ç æ˜¯åŸç å–ååŠ ä¸€ã€‚ä¾‹å¦‚ğ‘¥=6=000001102ï¼Œâˆ’ğ‘¥=ğ‘¥è¡¥=111110102ï¼Œé‚£ä¹ˆğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘¥)=ğ‘¥ &âˆ’ğ‘¥=102=2ã€‚

???+note "å®ç°"
    === "C++"
    
        ```cpp
        int lowbit(int x) {
          // x çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œæœ€ä½ä½çš„ 1 çš„ä½ç½®ã€‚
          // lowbit(0b01011000) == 0b00001000
          //          ~~~~^~~~
          // lowbit(0b01110010) == 0b00000010
          //          ~~~~~~^~
          return x & -x;
        }
        ```
    
    === "Python"
    
        ```python
        def lowbit(x):
            """
            x çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œæœ€ä½ä½çš„ 1 çš„ä½ç½®ã€‚
            lowbit(0b01011000) == 0b00001000
                    ~~~~~^~~
            lowbit(0b01110010) == 0b00000010
                    ~~~~~~~^~
            """
            return x & -x
        ```

æ³¨é‡Šè¯´æ˜äº† `lowbit` çš„æ„æ€ï¼Œå¯¹äº $x=88$ï¼Œ$88_{(10)}=01011000_{(2)}$   
$x$ äºŒè¿›åˆ¶æœ€ä½ä½ç¬¬ä¸€ä¸ª `1` ä»¥åŠåé¢çš„ `0` ç»„æˆçš„äºŒè¿›åˆ¶æ˜¯ `1000`ï¼Œè¯´æ˜ï¼Œæ‰€ä»¥ $c_{88}$ ä¸€å…±ç®¡ç† $2^{3}=8$ ä¸ª $a$ æ•°ç»„ä¸­çš„å…ƒç´ ã€‚äº‹å®ä¸Šï¼Œ$c_{i}$ ç®¡ç†çš„åŒºé—´å°±æ˜¯ $[i-\operatorname{lowbit}(i)+1, i]$ã€‚

åœ¨å¸¸è§çš„è®¡ç®—æœºä¸­ï¼Œæœ‰ç¬¦å·æ•°é‡‡ç”¨è¡¥ç è¡¨ç¤ºã€‚åœ¨è¡¥ç è¡¨ç¤ºä¸‹ï¼Œæ•° `x` çš„ç›¸åæ•° `-x = ~x + 1`ã€‚

ä»¤ğ‘š=ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘¥)ï¼Œå®šä¹‰ğ‘¡ğ‘Ÿğ‘’ğ‘’\[ğ‘¥\]å€¼ï¼Œæ˜¯æŠŠğ‘ğ‘¥å’Œå®ƒå‰é¢å…±ğ‘šä¸ªæ•°ç›¸åŠ çš„ç»“æœï¼Œå¦‚ä¸Šè¡¨æ‰€ç¤ºã€‚ä¾‹å¦‚ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(6)=2ï¼Œæœ‰ğ‘¡ğ‘Ÿğ‘’ğ‘’\[6\]=ğ‘5+ğ‘6ã€‚

ğ‘¡ğ‘Ÿğ‘’ğ‘’\[\]æ˜¯é€šè¿‡ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡()è®¡ç®—å‡ºçš„æ ‘çŠ¶æ•°ç»„ï¼Œå®ƒèƒ½å¤Ÿä»¥äºŒåˆ†çš„å¤æ‚åº¦å­˜å‚¨ä¸€ä¸ªæ•°åˆ—çš„æ•°æ®ã€‚ å…·ä½“åœ°ï¼Œtree\[x\]ä¸­å‚¨å­˜çš„æ˜¯\[ğ‘¥âˆ’ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘¥)+1,ğ‘¥\]ä¸­æ¯ä¸ªæ•°çš„å’Œã€‚å¦‚ä¸‹å›¾ï¼Œæ¨ªçº¿ä¸­çš„é»‘è‰²è¡¨ç¤ºğ‘¡ğ‘Ÿğ‘’ğ‘’\[ğ‘¥\]ï¼Œå®ƒç­‰äºæ¨ªçº¿ä¸Šå…ƒç´ ç›¸åŠ çš„å’Œã€‚

![](./images/bit-2.png)

ä½¿ç”¨ lowbit å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¾ˆå¤šæ“ä½œï¼Œä¾‹å¦‚å•ç‚¹ä¿®æ”¹ï¼Œå°† $a_{x}$ åŠ ä¸Š $k$ï¼Œåªéœ€è¦æ›´æ–° $a_{x}$ çš„æ‰€æœ‰ä¸Šçº§ï¼š

???+note "å®ç°"
    === "C++"

        ```cpp
        #define lowbit(x)  ((x) & - (x))   
        int tree[Maxn];
        void update(int x, int d) {   //ä¿®æ”¹å…ƒç´ ax,  ax = ax + d
            while(x <= Maxn) {
                tree[x] += d;  
                x += lowbit(x); 
            }
        }
        ```
    
    === "Python"
    
        ```python
        def add(x, k):
            while x <= n: # ä¸èƒ½è¶Šç•Œ
                c[x] = c[x] + k
                x = x + lowbit(x)
        ```

å‰ç¼€æ±‚å’Œï¼š

???+note "å®ç°"
    === "C++"

        ```cpp
        int sum(int x) {           //è¿”å›å€¼æ˜¯å‰ç¼€å’Œï¼šans = a1 + ... + ax
            int ans = 0;
            while(x > 0){
                ans += tree[x];  
                x -= lowbit(x);
            }
            return ans;
        }
        ```
    
    === "Python"
    
        ```python
        def getsum(x): # a[1]..a[x]çš„å’Œ
            ans = 0
            while x >= 1:
                ans = ans + c[x]
                x = x - lowbit(x)
            return ans
        ```

ä¸Šè¿°ä»£ç çš„ä½¿ç”¨æ–¹æ³•æ˜¯ï¼š

ï¼ˆ1ï¼‰åˆå§‹åŒ–ã€‚ä¸»ç¨‹åºå…ˆæ¸…ç©ºæ•°ç»„tree\[\]ï¼Œç„¶åè¯»å–ğ‘1ï¼Œğ‘2ï¼Œ...ï¼Œğ‘ğ‘›ï¼Œç”¨update()é€ä¸€å¤„ç†è¿™ğ‘›ä¸ªæ•°ï¼Œå¾—åˆ°tree\[\]æ•°ç»„ã€‚ä»£ç ä¸­å¹¶ä¸éœ€è¦å®šä¹‰æ•°ç»„ğ‘ï¼Œå› ä¸ºå®ƒéšå«åœ¨ğ‘¡ğ‘Ÿğ‘’ğ‘’[]ä¸­ã€‚

ï¼ˆ2ï¼‰æ±‚å‰ç¼€å’Œã€‚ç”¨ğ‘ ğ‘¢ğ‘š()å‡½æ•°è®¡ç®—ğ‘1+ğ‘2+...+ğ‘ğ‘¥ã€‚æ±‚å’Œæ˜¯åŸºäºæ•°ç»„tree\[\]çš„ã€‚

ï¼ˆ3ï¼‰ä¿®æ”¹å…ƒç´ ã€‚æ‰§è¡Œğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’()ï¼Œå³ä¿®æ”¹æ•°ç»„ğ‘¡ğ‘Ÿğ‘’ğ‘’\[\]ã€‚

ä»ä¸Šé¢çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œğ‘¡ğ‘Ÿğ‘’ğ‘’\[\]è¿™ä¸ªæ•°æ®ç»“æ„å¯ä»¥ç”¨äºè®°å½•å…ƒç´ ï¼Œä»¥åŠè®¡ç®—å‰ç¼€å’Œã€‚
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä»£ç ä¸­å¹¶ä¸éœ€è¦å®šä¹‰å’Œå­˜å‚¨æ•°ç»„ğ‘ï¼Œå› ä¸ºå®ƒéšå«åœ¨ğ‘¡ğ‘Ÿğ‘’ğ‘’\[\]ä¸­ï¼Œç”¨ğ‘ ğ‘¢ğ‘š()å‡½æ•°è®¡ç®—ğ‘ğ‘–=ğ‘ ğ‘¢ğ‘š(ğ‘–)âˆ’ğ‘ ğ‘¢ğ‘š(ğ‘–âˆ’1)ï¼Œå¤æ‚åº¦ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)ã€‚

ä¸‹é¢ä»‹ç»æ ‘çŠ¶æ•°ç»„çš„ç»å…¸åº”ç”¨ï¼Œå®ƒä»¬éƒ½ç»“åˆäº†â€œå·®åˆ†æ•°ç»„â€çš„æ¦‚å¿µï¼Œâ€œå·®åˆ†æ•°ç»„â€æ˜¯ç”¨äºåŒºé—´æŸ¥è¯¢çš„ä¸€ä¸ªæŠ€å·§ã€‚

## åŒºé—´ä¿®æ”¹ + å•ç‚¹æŸ¥è¯¢

ä¸€ä¸ªåºåˆ—ğ´=ğ‘1,ğ‘2,...,ğ‘ğ‘›çš„æ›´æ–°ï¼ˆä¿®æ”¹ï¼‰æœ‰ä¸¤ç§ï¼š

ï¼ˆ1ï¼‰å•ç‚¹ä¿®æ”¹ã€‚ä¸€æ¬¡æ”¹ä¸€ä¸ªæ•°ï¼›

ï¼ˆ2ï¼‰åŒºé—´ä¿®æ”¹ã€‚ä¸€æ¬¡æ”¹å˜ä¸€ä¸ªåŒºé—´\[ğ¿,ğ‘…\]å†…æ‰€æœ‰çš„æ•°ï¼Œä¾‹å¦‚æŠŠæ¯ä¸ªæ•°ç»Ÿä¸€åŠ ä¸Šğ‘‘ã€‚

æ ‘çŠ¶æ•°ç»„çš„åŸå§‹åŠŸèƒ½æ˜¯â€œå•ç‚¹ä¿®æ”¹ + åŒºé—´æŸ¥è¯¢â€ï¼Œæ˜¯å¦èƒ½æ‰©å±•ä¸ºâ€œåŒºé—´ä¿®æ”¹â€ï¼Ÿåªéœ€ä¸€ä¸ªç®€å•è€Œå·§å¦™çš„æ“ä½œï¼ˆå·®åˆ†æ•°ç»„ï¼‰ï¼Œå°±èƒ½æŠŠå•ç‚¹ä¿®æ”¹ç”¨æ¥å¤„ç†åŒºé—´ä¿®æ”¹é—®é¢˜ï¼Œå®ç°é«˜æ•ˆçš„â€œåŒºé—´ä¿®æ”¹ + å•ç‚¹æŸ¥è¯¢â€ï¼Œè¿›ä¸€æ­¥ä¹Ÿèƒ½åšåˆ°â€œåŒºé—´ä¿®æ”¹ + åŒºé—´æŸ¥è¯¢â€ã€‚

???+note "[Color the ball](https://vjudge.net/problem/HDU-1556)"
    **é—®é¢˜æè¿°ï¼š** Nä¸ªæ°”çƒæ’æˆä¸€æ’ï¼Œä»å·¦åˆ°å³ä¾æ¬¡ç¼–å·ä¸º1, 2, 3 .... Nã€‚æ¯æ¬¡ç»™å®š2ä¸ªæ•´æ•°L, R`(L<= R)`ï¼Œleleä»æ°”çƒLå¼€å§‹åˆ°æ°”çƒRä¾æ¬¡ç»™æ¯ä¸ªæ°”çƒæ¶‚ä¸€æ¬¡é¢œè‰²ã€‚ä½†æ˜¯Næ¬¡ä»¥åleleå·²ç»å¿˜è®°äº†ç¬¬iä¸ªæ°”çƒå·²ç»æ¶‚è¿‡å‡ æ¬¡é¢œè‰²äº†ï¼Œä½ èƒ½å¸®ä»–ç®—å‡ºæ¯ä¸ªæ°”çƒè¢«æ¶‚è¿‡å‡ æ¬¡é¢œè‰²å—ï¼Ÿ
    
    **è¾“å…¥ï¼š** æ¯ä¸ªæµ‹è¯•å®ä¾‹ç¬¬ä¸€è¡Œä¸ºä¸€ä¸ªæ•´æ•°Nï¼Œ`(N <= 100000)`ã€‚æ¥ä¸‹æ¥çš„Nè¡Œï¼Œæ¯è¡ŒåŒ…æ‹¬2ä¸ªæ•´æ•°`L, R(1 <= L<= R<= N)`ã€‚å½“N = 0ï¼Œè¾“å…¥ç»“æŸã€‚
    
    **è¾“å‡ºï¼š** æ¯ä¸ªæµ‹è¯•å®ä¾‹è¾“å‡ºä¸€è¡Œï¼ŒåŒ…æ‹¬Nä¸ªæ•´æ•°ï¼Œç¬¬Iä¸ªæ•°ä»£è¡¨ç¬¬Iä¸ªæ°”çƒæ€»å…±è¢«æ¶‚è‰²çš„æ¬¡æ•°ã€‚

???+note "è§£é¢˜æ€è·¯"
    å®šä¹‰æ•°ç»„ğ‘\[ğ‘–\]ä¸ºæ°”çƒğ‘–è¢«æ¶‚è‰²çš„æ¬¡æ•°ã€‚
    
    å¦‚æœç”¨æš´åŠ›å¤„ç†Næ¬¡åŒºé—´ä¿®æ”¹ï¼Œæ˜¯ğ‘‚(ğ‘2)çš„ã€‚ç”¨æ ‘çŠ¶æ•°ç»„ï¼Œå¦‚æœåªæ˜¯ç®€å•æŠŠåŒºé—´\[ğ¿,ğ‘…\]å†…çš„æ¯ä¸ªæ•°ğ‘\[ğ‘¥\]ç”¨ğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’()è¿›è¡Œå•ç‚¹ä¿®æ”¹ï¼Œå¤æ‚åº¦æ›´å·®ï¼Œæ˜¯ğ‘‚(ğ‘2ğ‘™ğ‘œğ‘”ğ‘)çš„ã€‚ä¸‹é¢æŠŠå•ç‚¹ä¿®æ”¹å¤„ç†æˆåŒºé—´ä¿®æ”¹ï¼Œå¤æ‚åº¦ğ‘‚(ğ‘ğ‘™ğ‘œğ‘”ğ‘)ã€‚
    
    å¦‚ä½•ç”¨æ ‘çŠ¶æ•°ç»„å¤„ç†åŒºé—´ä¿®æ”¹ï¼Ÿé¢˜ç›®è¦æ±‚æŠŠ\[ğ¿,ğ‘…\]åŒºé—´å†…æ¯ä¸ªæ•°åŠ ä¸Šğ‘‘ï¼Œä½†æ˜¯ä¸‹é¢çš„è§£æ³•ä¸æ˜¯å¯¹åŒºé—´å†…æ¯ä¸ªæ•°åŠ ğ‘‘ï¼Œè€Œæ˜¯æ“ä½œä¸€ä¸ªè¢«ç§°ä¸ºâ€œå·®åˆ†æ•°ç»„â€çš„ğ·ï¼Œå®ƒçš„å®šä¹‰æ˜¯ï¼š
    
    `ğ·[ğ‘˜]=ğ‘[ğ‘˜]âˆ’ğ‘[ğ‘˜âˆ’1]`ï¼Œå³åŸæ•°ç»„ç›¸é‚»å…ƒç´ çš„å·®ã€‚
    
    ä»å®šä¹‰å¯ä»¥æ¨å‡ºï¼š
    
    `ğ‘[ğ‘˜]=ğ·[1]+ğ·[2]+...+ğ·[ğ‘˜]=âˆ‘ğ‘˜ğ‘–=1ğ·(ğ‘–)`
    
    è¿™ä¸ªå…¬å¼æ·±åˆ»åœ°æè¿°äº†ğ‘å’Œğ·çš„å…³ç³»ï¼Œâ€œå·®åˆ†æ˜¯å‰ç¼€å’Œçš„é€†è¿ç®—â€ï¼Œå®ƒæŠŠæ±‚ğ‘\[ğ‘˜\]è½¬åŒ–ä¸ºæ±‚ğ·çš„å‰ç¼€å’Œï¼Œå‰ç¼€å’Œæ­£é€‚åˆç”¨æ ‘çŠ¶æ•°ç»„æ¥å¤„ç†ã€‚
    
    å¯¹äºåŒºé—´\[ğ¿,ğ‘…\]çš„ä¿®æ”¹é—®é¢˜ï¼Œå¯¹ğ·åšä»¥ä¸‹æ“ä½œï¼š
    
    1. æŠŠğ·\[ğ¿\]åŠ ä¸Šğ‘‘ï¼›
    2. æŠŠğ·\[ğ‘…+1\]å‡å»ğ‘‘ã€‚

    ç„¶åç”¨æ ‘çŠ¶æ•°ç»„å‡½æ•°ğ‘ ğ‘¢ğ‘š()æ±‚å‰ç¼€å’Œ`ğ‘ ğ‘¢ğ‘š[ğ‘¥]=ğ·[1]+ğ·[2]+...+ğ·[ğ‘¥]`ï¼Œæœ‰ï¼š

    1. `1â‰¤ğ‘¥<ğ¿ï¼Œå‰ç¼€å’Œğ‘ ğ‘¢ğ‘š[ğ‘¥]`ä¸å˜ï¼›
    2. `ğ¿â‰¤ğ‘¥â‰¤ğ‘…ï¼Œå‰ç¼€å’Œğ‘ ğ‘¢ğ‘š[ğ‘¥]`å¢åŠ äº†ğ‘‘ï¼›
    3. `ğ‘…<ğ‘¥â‰¤ğ‘ï¼Œå‰ç¼€å’Œğ‘ ğ‘¢ğ‘š[ğ‘¥]`ä¸å˜ï¼Œå› ä¸ºè¢«ğ·\[ğ‘…+1\]ä¸­å‡å»çš„ğ‘‘æŠµæ¶ˆäº†ã€‚

    ğ‘ ğ‘¢ğ‘š\[ğ‘¥\]çš„å€¼ä¸ç›´æ¥æŠŠ\[ğ¿,ğ‘…\]åŒºé—´å†…æ¯ä¸ªæ•°åŠ ä¸Šğ‘‘å¾—åˆ°çš„ğ‘\[ğ‘¥\]æ˜¯ç›¸ç­‰çš„ã€‚è¿™æ ·ï¼Œå°±åˆ©ç”¨æ ‘çŠ¶æ•°ç»„é«˜æ•ˆåœ°è®¡ç®—å‡ºäº†åŒºé—´ä¿®æ”¹åçš„ğ‘\[ğ‘¥\]ã€‚

???+note "å‚è€ƒä»£ç "
    === "æ ‘çŠ¶æ•°ç»„"
        ```cpp
        //tree[Maxn]ï¼Œlowbit(x)ï¼Œupdate()ï¼Œsum()çš„ä»£ç å‰é¢å·²ç»™å‡º
        const int Maxn = 100010;
        int main(){
            int n;
            while(~scanf("%d",&n)) {  
                memset(tree,0,sizeof(tree));          //åªéœ€è¦ä¸€ä¸ªtree[]æ•°ç»„
                for(int i=1;i<=n;i++) {               //åŒºé—´ä¿®æ”¹
                    int L, R; 
                    scanf("%d%d",&L,&R);
                    update(L,1);                       //æœ¬é¢˜çš„d = 1
                    update(R+1,-1);
                }
                for(int i=1;i<=n;i++){                //å•ç‚¹æŸ¥è¯¢
                    if(i!=n)  printf("%d ",sum(i));   //æŠŠsum(i)çœ‹æˆa[i]
                    else      printf("%d\n",sum(i));
                }
            }
            return 0;
        }
        ```

        ä»£ç ä¸­çš„ç¬¬ä¸€ä¸ªğ‘“ğ‘œğ‘Ÿå¾ªç¯åšäº†ğ‘›æ¬¡åŒºé—´ä¿®æ”¹ï¼Œå¤æ‚åº¦ğ‘‚(ğ‘›ğ‘™ğ‘œğ‘”ğ‘›)ï¼›ç¬¬äºŒä¸ªğ‘“ğ‘œğ‘Ÿå¾ªç¯åšäº†ğ‘›æ¬¡å•ç‚¹æŸ¥è¯¢ï¼Œå¤æ‚åº¦ğ‘‚(ğ‘›ğ‘™ğ‘œğ‘”ğ‘›)ã€‚åŠ èµ·æ¥æ€»å¤æ‚åº¦ä»æ˜¯ğ‘‚(ğ‘›ğ‘™ğ‘œğ‘”ğ‘›)ã€‚

    === "å·®åˆ†æ•°ç»„"
        ```cpp
        #include<bits/stdc++.h>
        using namespace std;
        const int Maxn = 100010;
        int a[Maxn],D[Maxn];               //aæ˜¯æ°”çƒï¼ŒDæ˜¯å·®åˆ†æ•°ç»„
        int main(){
            int n;
            while(~scanf("%d",&n)) { 
                memset(a,0,sizeof(a)); memset(D,0,sizeof(D));
                for(int i=1;i<=n;i++){
                    int L,R; scanf("%d%d",&L,&R);
                    D[L]++;                 //å·®åˆ†ï¼ŒåŸç†å’Œå‰é¢æ ‘çŠ¶æ•°ç»„ä¸€æ ·
                    D[R+1]--;
                }
                for(int i=1;i<=n;i++){
                    a[i] = a[i-1] + D[i];          //æ±‚å‰ç¼€å’Œa[]ï¼Œa[i]å°±æ˜¯æ°”çƒiçš„å€¼
                    if(i!=n)  printf("%d ", a[i]);  //é€ä¸ªæ‰“å°ç»“æœ
                    else      printf("%d\n",a[i]);
                }        
            }
            return 0;
        }
        ```

        ä¸è¿‡ï¼Œé‡åˆ°â€œåŒºé—´ä¿®æ”¹â€è¿™ç§é¢˜å‹ï¼Œè¿˜æ˜¯å»ºè®®ç”¨æ ‘çŠ¶æ•°ç»„æ¥æ±‚è§£ã€‚åŸå› æ˜¯å·®åˆ†æ•°ç»„å¯¹â€œåŒºé—´ä¿®æ”¹â€æ˜¯å¾ˆé«˜æ•ˆçš„ï¼Œä½†æ˜¯å¯¹â€œå•ç‚¹æŸ¥è¯¢â€å¹¶ä¸é«˜æ•ˆã€‚å³ä½¿åªæŸ¥è¯¢ä¸€ä¸ªå‰ç¼€å’Œï¼Œå·®åˆ†æ•°ç»„ä»ç„¶è¦è®¡ç®—æ‰€æœ‰çš„å‰ç¼€å’Œï¼Œå¤æ‚åº¦ğ‘‚(ğ‘›)ï¼›è€Œæ ‘çŠ¶æ•°ç»„åšä¸€æ¬¡å‰ç¼€å’Œè®¡ç®—æ˜¯ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)çš„ã€‚

## åŒºé—´ä¿®æ”¹ + åŒºé—´æŸ¥è¯¢

å‰é¢çš„ä¾‹é¢˜å®Œæˆçš„æ˜¯â€œåŒºé—´ä¿®æ”¹ + å•ç‚¹æŸ¥è¯¢â€ï¼Œä¸‹é¢è€ƒè™‘æŠŠå•ç‚¹æŸ¥è¯¢æ‰©å±•åˆ°åŒºé—´æŸ¥è¯¢ï¼Œå³æŸ¥è¯¢çš„ä¸æ˜¯ä¸€ä¸ªå•ç‚¹ğ‘\[ğ‘¥\]çš„å€¼ï¼Œè€Œæ˜¯åŒºé—´\[ğ‘–,ğ‘—\]çš„å’Œã€‚

ä»…ä»…ç”¨ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ï¼Œæ— æ³•åŒæ—¶é«˜æ•ˆåœ°å®Œæˆâ€œåŒºé—´ä¿®æ”¹â€å’Œâ€œåŒºé—´æŸ¥è¯¢â€ï¼Œå› ä¸ºè¿™ä¸ªæ ‘çŠ¶æ•°ç»„çš„tree\[\]å·²ç»ç”¨äºâ€œåŒºé—´ä¿®æ”¹â€ï¼Œå®ƒç”¨ğ‘ ğ‘¢ğ‘š()è®¡ç®—äº†å•ç‚¹ğ‘\[ğ‘¥\]ï¼Œä¸èƒ½å†ç”¨äºæ±‚`ğ‘[ğ‘–]~ğ‘[ğ‘—]`çš„åŒºé—´å’Œã€‚

è¯»è€…å¯èƒ½æƒ³åˆ°å†åŠ ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„ï¼Œä¹Ÿè®¸èƒ½æ¥ç€é«˜æ•ˆåœ°å®ŒæˆåŒºé—´æŸ¥è¯¢ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„åªæ˜¯ç®€å•åœ°ä¸€ä¸ªåšâ€œåŒºé—´ä¿®æ”¹â€ï¼Œä¸€ä¸ªåšâ€œåŒºé—´æŸ¥è¯¢â€ï¼Œåˆèµ·æ¥æ•ˆç‡å¹¶ä¸é«˜ã€‚åšä¸€æ¬¡é•¿åº¦ä¸ºğ‘˜çš„åŒºé—´ä¿®æ”¹ï¼Œè®¡ç®—åŒºé—´å†…æ¯ä¸ªğ‘\[ğ‘¥\]çš„å¤æ‚åº¦æ˜¯ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)çš„ï¼›å¦‚æœç»§ç»­ç”¨ä¸€ä¸ªæ ‘çŠ¶æ•°ç»„å¤„ç†è¿™ğ‘˜ä¸ªğ‘\[ğ‘¥\]ï¼Œå¤æ‚åº¦æ˜¯ğ‘‚(ğ‘˜ğ‘™ğ‘œğ‘”ğ‘›)çš„ï¼›åšğ‘›æ¬¡ä¿®æ”¹å’Œè¯¢é—®ï¼Œæ€»å¤æ‚åº¦ğ‘‚(ğ‘›2ğ‘™ğ‘œğ‘”ğ‘›)ã€‚

è¿™ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„éœ€è¦ç´§å¯†ç»“åˆæ‰èƒ½é«˜æ•ˆå®Œæˆâ€œåŒºé—´ä¿®æ”¹ + åŒºé—´æŸ¥è¯¢â€ï¼Œç§°ä¸ºâ€œäºŒé˜¶æ ‘çŠ¶æ•°ç»„â€ï¼Œå®ƒä¹Ÿæ˜¯â€œå·®åˆ†æ•°ç»„â€æ¦‚å¿µå’Œæ ‘çŠ¶æ•°ç»„çš„ç»“åˆã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªå…¸å‹ä¾‹é¢˜ã€‚

???+note "[ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 1](https://www.luogu.com.cn/problem/P3372)"
    **é—®é¢˜æè¿°ï¼š** å·²çŸ¥ä¸€ä¸ªæ•°åˆ—ï¼Œè¿›è¡Œä¸¤ç§æ“ä½œï¼šï¼ˆ1ï¼‰æŠŠæŸåŒºé—´æ¯ä¸ªæ•°åŠ ä¸Šdï¼›ï¼ˆ2ï¼‰æ±‚æŸåŒºé—´æ‰€æœ‰æ•°çš„å’Œã€‚
    
    **è¾“å…¥ï¼š** ç¬¬ä¸€è¡ŒåŒ…å«ä¸¤ä¸ªæ•´æ•° nï¼Œmï¼Œåˆ†åˆ«è¡¨ç¤ºè¯¥æ•°åˆ—æ•°å­—çš„ä¸ªæ•°å’Œæ“ä½œçš„æ€»ä¸ªæ•°ã€‚ç¬¬äºŒè¡ŒåŒ…å«nä¸ªç”¨ç©ºæ ¼åˆ†éš”çš„æ•´æ•°ï¼Œå…¶ä¸­ç¬¬iä¸ªæ•°å­—è¡¨ç¤ºæ•°åˆ—ç¬¬ié¡¹çš„åˆå§‹å€¼ã€‚æ¥ä¸‹æ¥mè¡Œæ¯è¡ŒåŒ…å«3æˆ–4ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºä¸€ä¸ªæ“ä½œï¼Œå…·ä½“å¦‚ä¸‹ï¼š
    
    ï¼ˆ1ï¼‰1 L R dï¼šå°†åŒºé—´[L, R]å†…æ¯ä¸ªæ•°åŠ ä¸Šdã€‚
    
    ï¼ˆ2ï¼‰2 L Rï¼šè¾“å‡ºåŒºé—´[L, R]å†…æ¯ä¸ªæ•°çš„å’Œã€‚
    
    **è¾“å‡ºï¼š** è¾“å‡ºåŒ…å«è‹¥å¹²è¡Œæ•´æ•°ï¼Œå³ä¸ºæ‰€æœ‰æ“ä½œï¼ˆ2ï¼‰çš„ç»“æœã€‚
    
    `1â‰¤ğ‘›ï¼Œğ‘šâ‰¤10^5ï¼Œå…ƒç´ çš„å€¼åœ¨[âˆ’2^63,2^63)å†…`ã€‚

???+note "è§£é¢˜æ€è·¯"
    æ“ä½œï¼ˆ1ï¼‰æ˜¯åŒºé—´ä¿®æ”¹ï¼Œæ“ä½œï¼ˆ2ï¼‰æ˜¯åŒºé—´æŸ¥è¯¢ã€‚
    
    é¦–å…ˆï¼Œæ±‚åŒºé—´å’Œ`ğ‘ ğ‘¢ğ‘š(ğ¿,ğ‘…)=ğ‘[ğ¿]+ğ‘[ğ¿+1]+...+ğ‘[ğ‘…]=ğ‘ ğ‘¢ğ‘š(1,ğ‘…)âˆ’ğ‘ ğ‘¢ğ‘š(1,ğ¿âˆ’1)`ï¼Œé—®é¢˜è½¬åŒ–ä¸ºæ±‚ğ‘ ğ‘¢ğ‘š(1,ğ‘˜)ã€‚
    
    å®šä¹‰ä¸€ä¸ªå·®åˆ†æ•°ç»„ğ·ï¼Œå®ƒå’ŒåŸæ•°ç»„açš„å…³ç³»ä»ç„¶æ˜¯`ğ·[ğ‘˜]=ğ‘[ğ‘˜]âˆ’ğ‘[ğ‘˜âˆ’1]ï¼Œæœ‰ğ‘[ğ‘˜]=ğ·[1]+ğ·[2]+...+ğ·[ğ‘˜]`ï¼Œä¸‹é¢æ¨å¯¼åŒºé—´å’Œï¼Œçœ‹å®ƒå’Œæ±‚å‰ç¼€å’Œæœ‰æ²¡æœ‰å…³ç³»ï¼Œå¦‚æœæœ‰å…³ç³»ï¼Œå°±èƒ½ç”¨æ ‘çŠ¶æ•°ç»„ã€‚

    `ğ‘1+ğ‘2+...+ğ‘ğ‘˜
    =ğ·1+(ğ·1+ğ·2)+(ğ·1+ğ·2+ğ·3)+...+(ğ·1+ğ·2+...+ğ·ğ‘˜)
    =ğ‘˜âˆ—ğ·1+(ğ‘˜âˆ’1)âˆ—ğ·2+(ğ‘˜âˆ’2)âˆ—ğ·3+...+(ğ‘˜âˆ’(ğ‘˜âˆ’1))ğ·ğ‘˜
    =ğ‘˜(ğ·1+ğ·2+...+ğ·ğ‘˜)âˆ’(ğ·2+2ğ·3+...+(ğ‘˜âˆ’1)ğ·ğ‘˜)
    =ğ‘˜âˆ‘ğ‘˜ğ‘–=1ğ·ğ‘–âˆ’âˆ‘ğ‘˜ğ‘–=1(ğ‘–âˆ’1)ğ·ğ‘–`

    è¿™æ˜¯æ±‚ä¸¤ä¸ªå‰ç¼€å’Œï¼Œç”¨ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„åˆ†åˆ«å¤„ç†ï¼Œä¸€ä¸ªå®ç°ğ·ğ‘–ï¼Œä¸€ä¸ªå®ç°(ğ‘–âˆ’1)ğ·ğ‘–ã€‚
    
    ä¸‹é¢æ˜¯â€œåŒºé—´ä¿®æ”¹ + åŒºé—´æŸ¥è¯¢â€çš„ä»£ç ï¼Œå®Œå…¨é‡ç°äº†ä¸Šé¢æ¨å¯¼å‡ºçš„ç»“è®ºã€‚
    
    ä»£ç ä¸­çš„ğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’1()å’Œğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’2()ã€ğ‘ ğ‘¢ğ‘š1()å’Œğ‘ ğ‘¢ğ‘š2()å‡ ä¹ä¸€æ ·ã€‚ä¹Ÿå¯ä»¥åˆèµ·æ¥å†™æˆğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’1(ğ‘™ğ‘™ ğ‘¥,ğ‘™ğ‘™ ğ‘‘,ğ‘–ğ‘›ğ‘¡ ğ‘£)çš„æ ·å­ï¼Œç”¨ğ‘£æ¥åŒºåˆ†å¤„ç†ğ‘¡ğ‘Ÿğ‘’ğ‘’1å’Œğ‘¡ğ‘Ÿğ‘’ğ‘’2ã€‚ä¸è¿‡åƒä¸‹é¢è¿™æ ·åˆ†å¼€å†™æ›´æ¸…æ™°ï¼Œç¼–ç æ›´å¿«ã€‚
    
    ä»£ç çš„å¤æ‚åº¦æ˜¯ğ‘‚(ğ‘šğ‘™ğ‘œğ‘”ğ‘›)ã€‚

???+note "å‚è€ƒä»£ç "
    ```cpp
    #include<bits/stdc++.h>
    using namespace std;
    #define ll long long
    const int Maxn = 100010;
    #define lowbit(x)  ((x) & - (x))   
    ll tree1[Maxn],tree2[Maxn];         //2ä¸ªæ ‘çŠ¶æ•°ç»„
    void update1(ll x,ll d){
        while(x<=Maxn){
            tree1[x]+=d;  x+=lowbit(x);
        }
    }
    void update2(ll x,ll d){
        while(x<=Maxn){
            tree2[x]+=d;  x+=lowbit(x);
        }
    }
    ll   sum1(ll x){
        ll ans = 0;
        while(x>0) {
            ans+=tree1[x];x-=lowbit(x);
        }
        return ans;
    }
    ll   sum2(ll x){
        ll ans = 0;
        while(x>0) {
            ans+=tree2[x];x-=lowbit(x);
        }
        return ans;
    }
    int main(){
        ll n, m; scanf("%lld%lld",&n,&m);
        ll old = 0, a;
        for (int i=1;i<=n;i++) {        
            scanf("%lld",&a);      //è¾“å…¥æ¯ä¸ªåˆå§‹å€¼
            update1(i, a-old);     //å·®åˆ†æ•°ç»„åŸç†ï¼Œåˆå§‹åŒ–
            update2(i,(i-1)*(a-old));
            old = a;
        }
        while (m--){                     //mä¸ªæ“ä½œ
            ll q, L, R, d; 
            scanf("%lld",&q);
            if (q==1){                   //åŒºé—´ä¿®æ”¹
                scanf("%lld%lld%lld",&L, &R, &d);
                update1(L,d);            //ç¬¬1ä¸ªæ ‘çŠ¶æ•°ç»„
                update1(R+1,-d); 
                update2(L,d*(L-1));      //ç¬¬2ä¸ªæ ‘çŠ¶æ•°ç»„
                update2(R+1,-d*R);       //d*R = d*(R+1-1)
            }
            else {                       //åŒºé—´è¯¢é—®
                scanf("%lld%lld",&L,&R);
                printf("%lld\n",R*sum1(R)-sum2(R) - (L-1)*sum1(L-1)+sum2(L-1));
            } 
        }
        return 0;
    }
    ```

## äºŒç»´åŒºé—´ä¿®æ”¹ + åŒºé—´æŸ¥è¯¢
å‰é¢çš„ä¾‹é¢˜éƒ½æ˜¯ä¸€ç»´çš„ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªäºŒç»´æ±‚â€œåŒºé—´ä¿®æ”¹+åŒºé—´æŸ¥è¯¢â€çš„ä¾‹é¢˜ã€‚

???+note "[ä¸Šå¸é€ é¢˜çš„ä¸ƒåˆ†é’Ÿ](https://www.luogu.com.cn/problem/P4514)"
    **è¾“å…¥ï¼š** ç¬¬ä¸€è¡Œæ˜¯X n mï¼Œä»£è¡¨çŸ©é˜µå¤§å°ä¸ºnÃ—mã€‚ä»ç¬¬äºŒè¡Œå¼€å§‹åˆ°æ–‡ä»¶å°¾çš„æ¯ä¸€è¡Œå‡ºç°ä»¥ä¸‹ä¸¤ç§æ“ä½œï¼š
    
    L a b c d delta ä»£è¡¨å°†(a,b),(c,d)ä¸ºé¡¶ç‚¹çš„çŸ©å½¢åŒºåŸŸå†…æ‰€æœ‰æ•°å­—åŠ ä¸Šdeltaã€‚
    
    k a b c d ä»£è¡¨æ±‚(a,b),(c,d)ä¸ºé¡¶ç‚¹çš„çŸ©å½¢åŒºåŸŸå†…æ‰€æœ‰æ•°å­—çš„å’Œã€‚
    
    **è¾“å‡ºï¼š** é’ˆå¯¹æ¯ä¸ªkæ“ä½œï¼Œè¾“å‡ºç­”æ¡ˆã€‚
    
    è¾“å…¥æ ·ä¾‹ï¼š
    
    X 4 4
    
    L 1 1 3 3 2
    
    L 2 2 4 4 1
    
    k 2 2 3 3
    
    è¾“å‡ºæ ·ä¾‹ï¼š
    
    12
    
    æ³¨ï¼š`1 â‰¤ n â‰¤ 2048, 1 â‰¤ m â‰¤ 2048, âˆ’500 â‰¤ delta â‰¤ 500`, æ“ä½œä¸è¶…è¿‡200000ä¸ª,ä¿è¯è¿ç®—è¿‡ç¨‹ä¸­åŠæœ€ç»ˆç»“æœå‡ä¸è¶…è¿‡32ä½å¸¦ç¬¦å·æ•´æ•°ç±»å‹çš„è¡¨ç¤ºèŒƒå›´ã€‚

???+note "è§£é¢˜æ€è·¯"
    æœ¬é¢˜éœ€è¦ç”¨äºŒç»´æ ‘çŠ¶æ•°ç»„ã€‚äºŒç»´çš„â€œåŒºé—´ä¿®æ”¹+åŒºé—´æŸ¥è¯¢â€ï¼Œå°±æ˜¯ä¸€ç»´â€œåŒºé—´ä¿®æ”¹+åŒºé—´æŸ¥è¯¢â€çš„æ‰©å±•ï¼Œæ–¹æ³•å’Œæ¨å¯¼è¿‡ç¨‹ç±»ä¼¼ã€‚ 
    
    ï¼ˆ1ï¼‰äºŒç»´åŒºé—´ä¿®æ”¹

    ![](./images/bit-3.png)

    å¦‚ä½•å®ç°åŒºé—´ä¿®æ”¹ï¼Ÿéœ€è¦ç»“åˆäºŒç»´çš„å·®åˆ†æ•°ç»„ã€‚å®šä¹‰ä¸€ä¸ªäºŒç»´çš„å·®åˆ†æ•°ç»„ğ·\[ğ‘–\]\[ğ‘—\]ï¼Œå®ƒå’ŒçŸ©é˜µå…ƒç´ ğ‘\[ğ‘\]\[ğ‘‘\]çš„å…³ç³»æ˜¯ï¼š
    
    `ğ·[ğ‘–][ğ‘—]=ğ‘[ğ‘–][ğ‘—]âˆ’ğ‘[ğ‘–âˆ’1][ğ‘—]âˆ’ğ‘[ğ‘–][ğ‘—âˆ’1]+ğ‘[ğ‘–âˆ’1][ğ‘—âˆ’1]`ï¼Œå¯¹ç…§ä¸Šå›¾ï¼Œ`ğ·[ğ‘–][ğ‘—]`å°±æ˜¯é˜´å½±çš„é¢ç§¯ã€‚
    
    `ğ‘[ğ‘][ğ‘‘]=âˆ‘ğ‘ğ‘–=1âˆ‘ğ‘‘ğ‘—=1ğ·[ğ‘–][ğ‘—]`ï¼Œçœ‹æˆå¯¹ä»¥(1,1)ã€(ğ‘,ğ‘‘)ä¸ºé¡¶ç‚¹çš„çŸ©é˜µå†…çš„`ğ·[ğ‘–][ğ‘—]`æ±‚å’Œã€‚
    
    å®ƒä»¬åŒæ ·æ»¡è¶³â€œå·®åˆ†æ˜¯å‰ç¼€å’Œçš„é€†è¿ç®—â€å…³ç³»ã€‚
    
    ç”¨äºŒç»´æ ‘çŠ¶æ•°ç»„å®ç°ğ·\[ğ‘–\]\[ğ‘—\]ï¼Œç¼–ç è§åé¢çš„ä»£ç ä¸­çš„ğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’()å’Œğ‘ ğ‘¢ğ‘š()ã€‚è¿›è¡ŒåŒºé—´ä¿®æ”¹çš„æ—¶å€™ï¼Œåœ¨ğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’()ä¸­ï¼Œæ¯æ¬¡ç¬¬ğ‘–è¡Œå‡å°‘ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘–)ï¼Œç¬¬ğ‘—jåˆ—å‡ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘—)ï¼Œå¤æ‚åº¦ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›ğ‘™ğ‘œğ‘”ğ‘š)ã€‚
    
    ï¼ˆ2ï¼‰äºŒç»´åŒºé—´æŸ¥è¯¢

    ![](./images/bit-4.png)

    æŸ¥è¯¢(a, b)ã€(c, d)ä¸ºé¡¶ç‚¹çš„çŸ©é˜µåŒºé—´å’Œï¼Œå¯¹ç…§ä¸Šå›¾çš„é˜´å½±éƒ¨åˆ†ï¼Œæœ‰ï¼š

    `âˆ‘ğ‘ğ‘–=ğ‘âˆ‘ğ‘‘ğ‘—=ğ‘ğ‘[ğ‘–][ğ‘—]=âˆ‘ğ‘ğ‘–=1âˆ‘ğ‘‘ğ‘—=1ğ‘[ğ‘–][ğ‘—]âˆ’âˆ‘ğ‘ğ‘–=1âˆ‘ğ‘âˆ’1ğ‘—=1ğ‘[ğ‘–][ğ‘—]âˆ’âˆ‘ğ‘âˆ’1ğ‘–=1âˆ‘ğ‘‘ğ‘—=1ğ‘[ğ‘–][ğ‘—]+âˆ‘ğ‘âˆ’1ğ‘–=1âˆ‘ğ‘âˆ’1ğ‘—=1ğ‘[ğ‘–][ğ‘—]`
    
    é—®é¢˜è½¬åŒ–ä¸ºè®¡ç®—`âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ‘[ğ‘–][ğ‘—]`ï¼Œæ ¹æ®å®ƒå’Œå·®åˆ†æ•°ç»„Dçš„å…³ç³»è¿›è¡Œå˜æ¢\[1:1\]ï¼š
    
    `âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ‘[ğ‘–][ğ‘—]
    =âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1âˆ‘ğ‘–ğ‘˜=1âˆ‘ğ‘—ğ‘™=1ğ·[ğ‘˜][ğ‘™]
    =âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ·[ğ‘–][ğ‘—]Ã—(ğ‘›âˆ’ğ‘–+1)Ã—(ğ‘šâˆ’ğ‘—âˆ’1)
    =(ğ‘›+1)(ğ‘š+1)âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ·[ğ‘–][ğ‘—]âˆ’(ğ‘š+1)âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ·[ğ‘–][ğ‘—]Ã—ğ‘–âˆ’(ğ‘›+1)âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ·[ğ‘–][ğ‘—]Ã—ğ‘—+âˆ‘ğ‘›ğ‘–=1âˆ‘ğ‘šğ‘—=1ğ·[ğ‘–][ğ‘—]Ã—ğ‘–Ã—ğ‘—`
    
    è¿™æ˜¯4ä¸ªäºŒç»´æ ‘çŠ¶æ•°ç»„ã€‚

???+note "å‚è€ƒä»£ç "

    ```cpp
    #include<bits/stdc++.h>
    using namespace std;
    const int N = 2050;
    int t1[N][N],t2[N][N],t3[N][N],t4[N][N];
    #define lowbit(x)  ((x) & - (x))  
    int n,m; 
    void update(int x,int y,int d){
        for(int i=x;i<=n;i+=lowbit(i))
            for(int j=y;j<=m;j+=lowbit(j)){
                t1[i][j] += d;
                t2[i][j] += x*d;
                t3[i][j] += y*d;
                t4[i][j] += x*y*d;
            }
    }
    int sum(int x,int y){
        int ans = 0;
        for(int i=x;i>0;i-=lowbit(i))
            for(int j=y;j>0;j-=lowbit(j))
                ans += (x+1)*(y+1)*t1[i][j] - (y+1)*t2[i][j] - (x+1)*t3[i][j] + t4[i][j];
        return ans;
    }
    int main(){
        char ch[2];	scanf("%s",ch);
        scanf("%d%d",&n,&m);     
    while(scanf("%s",ch)!=EOF){
            int a,b,c,d,delta;
            scanf("%d%d%d%d",&a,&b,&c,&d);
            if(ch[0]=='L'){
                scanf("%d",&delta);
                update(a,  b,   delta);    
                update(c+1,d+1, delta);
                update(a,  d+1,-delta); 
                update(c+1,b,  -delta);
            }
            else printf("%d\n",sum(c,d)+sum(a-1,b-1)-sum(a-1,d)-sum(c,b-1));
        }	
        return 0;
    }
    ```

### ååºé—®é¢˜ï¼ˆé€†åºå¯¹ + ç¦»æ•£åŒ–ï¼‰

ååºé—®é¢˜ï¼š

1. ä¸€ç»´ååºï¼ˆé€†åºå¯¹ï¼‰ã€‚ç»™å®šæ•°åˆ—aï¼Œæ±‚æ»¡è¶³i < jä¸”ai > ajçš„äºŒå…ƒç»„(i, j)çš„æ•°é‡ã€‚
2. äºŒç»´ååºã€‚ç»™å®šnä¸ªç‚¹çš„åæ ‡ï¼Œæ±‚å‡ºæ»¡è¶³xi < xjã€yi < yjçš„äºŒå…ƒç»„(i, j)çš„æ•°é‡ã€‚
3. ä¸‰ç»´ååºã€‚ç»™å®šnä¸ªç‚¹çš„åæ ‡ï¼Œæ±‚æ»¡è¶³xi < xjã€yi < yjã€zi < zjçš„äºŒå…ƒç»„(i, j)çš„æ•°é‡ã€‚

é€†åºå¯¹é—®é¢˜æœ‰ä¸¤ç§è§£æ³•ï¼šå½’å¹¶æ’åºã€æ ‘çŠ¶æ•°ç»„ã€‚ç”¨æ ‘çŠ¶æ•°ç»„è§£é€†åºå¯¹åˆç®€å•åˆå·§å¦™ï¼Œæ˜¯æ ‘çŠ¶æ•°ç»„åº”ç”¨çš„ç»ä½³ä¾‹å­ã€‚

???+note "[é€†åºå¯¹](https://www.luogu.com.cn/problem/P1908)"
    **é¢˜ç›®æè¿°ï¼š** å¯¹äºç»™å®šçš„ä¸€æ®µæ­£æ•´æ•°åºåˆ—ï¼Œé€†åºå¯¹å°±æ˜¯åºåˆ—ä¸­ai > ajä¸”i < jçš„æœ‰åºå¯¹ã€‚è®¡ç®—ä¸€æ®µæ­£æ•´æ•°åºåˆ—ä¸­é€†åºå¯¹çš„æ•°ç›®ã€‚åºåˆ—ä¸­å¯èƒ½æœ‰é‡å¤æ•°å­—ã€‚
    
    **è¾“å…¥æ ¼å¼ï¼š** ç¬¬ä¸€è¡Œï¼Œä¸€ä¸ªæ•° nï¼Œè¡¨ç¤ºåºåˆ—ä¸­æœ‰ nä¸ªæ•°ã€‚ç¬¬äºŒè¡Œnä¸ªæ•°ï¼Œè¡¨ç¤ºç»™å®šçš„åºåˆ—ã€‚åºåˆ—ä¸­æ¯ä¸ªæ•°å­—ä¸è¶…è¿‡ 109ã€‚n <= 5Ã—105ã€‚
    
    **è¾“å‡ºæ ¼å¼ï¼š** è¾“å‡ºåºåˆ—ä¸­é€†åºå¯¹çš„æ•°ç›®ã€‚
    
    è¾“å…¥æ ·ä¾‹ï¼š
    
    6
    
    5 4 2 6 3 1
    
    è¾“å‡ºæ ·ä¾‹ï¼š
    
    11

???+note "è§£é¢˜æ€è·¯"
    ç›´æ¥ç”¨ä¸¤é‡å¾ªç¯æš´åŠ›æœï¼Œå¤æ‚åº¦O(n2)ã€‚ç”¨æ ‘çŠ¶æ•°ç»„ï¼Œå¤æ‚åº¦O(nlogn)ã€‚
    
    ç”¨æ ‘çŠ¶æ•°ç»„è§£é€†åºå¯¹ç”¨åˆ°ä¸€ä¸ªæŠ€å·§ï¼šæŠŠæ•°å­—çœ‹æˆæ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡ã€‚æ¯å¤„ç†ä¸€ä¸ªæ•°å­—ï¼Œæ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡æ‰€å¯¹åº”çš„å…ƒç´ æ•°å€¼åŠ ä¸€ï¼Œç»Ÿè®¡å‰ç¼€å’Œï¼Œå°±æ˜¯é€†åºå¯¹çš„æ•°é‡ã€‚å€’åºæˆ–æ­£åºå¤„ç†æ•°æ®éƒ½è¡Œï¼Œä¸‹é¢æ˜¯ä¾‹å­ã€‚
    
    ï¼ˆ1ï¼‰å€’åºã€‚ç”¨æ ‘çŠ¶æ•°ç»„å€’åºå¤„ç†æ•°åˆ—ï¼Œå½“å‰æ•°å­—çš„å‰ä¸€ä¸ªæ•°çš„å‰ç¼€å’Œå³ä¸ºä»¥è¯¥æ•°ä¸ºè¾ƒå¤§æ•°çš„é€†åºå¯¹çš„ä¸ªæ•°ã€‚ä¾‹å¦‚æ ·ä¾‹çš„{5, 4, 2, 6, 3, 1}ï¼Œå€’åºå¤„ç†æ•°å­—ï¼š

        1. æ•°å­—1ã€‚æŠŠa\[1\]åŠ ä¸€ï¼Œè®¡ç®—a\[1\]å‰é¢çš„å‰ç¼€å’Œsum(0)ï¼Œé€†åºå¯¹æ•°é‡ans=ans+sum(0)=0ï¼›
        2. æ•°å­—3ã€‚æŠŠa\[3\]åŠ ä¸€ï¼Œè®¡ç®—a\[3\]å‰é¢çš„å‰ç¼€å’Œsum(2)ï¼Œé€†åºå¯¹æ•°é‡ans=ans+sum(2)=1ï¼›
        3. æ•°å­—6ã€‚æŠŠa\[6\]åŠ ä¸€ï¼Œè®¡ç®—a\[6\]å‰é¢çš„å‰ç¼€å’Œsum(5)ï¼Œé€†åºå¯¹æ•°é‡ans=ans+sum(5)=1+2=3ï¼›
        
        ç­‰ç­‰ã€‚
    
    ï¼ˆ2ï¼‰æ­£åºã€‚å½“å‰å·²ç»å¤„ç†çš„æ•°å­—ä¸ªæ•°å‡æ‰å½“å‰æ•°å­—çš„å‰ç¼€å’Œå³ä¸ºä»¥è¯¥æ•°ä¸ºè¾ƒå°æ•°çš„é€†åºå¯¹ä¸ªæ•°ã€‚ä¾‹å¦‚æ ·ä¾‹çš„{5, 4, 2, 6, 3, 1}ï¼Œæ­£åºå¤„ç†æ•°å­—ï¼š

        1. æ•°å­—5ã€‚æŠŠa\[5\]åŠ ä¸€ï¼Œå½“å‰å¤„ç†äº†1ä¸ªæ•°ï¼Œans=ans+(1-sum(5))=0ï¼›
        2. æ•°å­—4ã€‚æŠŠa\[4\]åŠ ä¸€ï¼Œå½“å‰å¤„ç†äº†2ä¸ªæ•°ï¼Œans=ans+(2-sum(4))=0+1=1ï¼›
        3. æ•°å­—2ã€‚æŠŠa\[2\]åŠ ä¸€ï¼Œans=ans+(3-sum(2))=1+2=3ï¼›
        4. æ•°å­—6ã€‚æŠŠa\[6\]åŠ ä¸€ï¼Œans=ans+(4-sum(6))=3+0=3ï¼›
    
    ç­‰ç­‰ã€‚
    
    ä¸è¿‡ï¼Œä¸Šé¢çš„å¤„ç†æ–¹æ³•â€œæŠŠæ•°å­—çœ‹æˆæ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡â€æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæ•°å­—æ¯”è¾ƒå¤§ï¼Œä¾‹å¦‚æ•°å­—ç­‰äº10^9^ï¼Œé‚£ä¹ˆæ ‘çŠ¶æ•°ç»„çš„ç©ºé—´ä¹Ÿè¦å¼€åˆ°10^9^ = 1Gï¼Œè¿™è¿œè¿œè¶…è¿‡äº†é¢˜ç›®é™åˆ¶çš„ç©ºé—´ã€‚ç”¨â€œç¦»æ•£åŒ–â€è¿™ä¸ªå°æŠ€å·§èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
    
    æ‰€è°“ç¦»æ•£åŒ–ï¼Œå°±æ˜¯æŠŠåŸæ¥çš„æ•°å­—ï¼Œç”¨å®ƒä»¬çš„ç›¸å¯¹å¤§å°æ¥æ›¿æ¢åŸæ¥çš„æ•°å€¼ï¼Œè€Œå®ƒä»¬çš„é¡ºåºä»ç„¶ä¸å˜ï¼Œä¸å½±å“é€†åºå¯¹çš„è®¡ç®—ã€‚ä¾‹å¦‚{1, 20000,10, 300, 890000000}ï¼Œå®ƒä»¬çš„ç›¸å¯¹å¤§å°æ˜¯{1, 4, 2, 3, 5}ï¼Œè¿™ä¸¤ä¸ªåºåˆ—çš„é€†åºå¯¹æ•°é‡æ˜¯ä¸€æ ·çš„ã€‚å‰è€…éœ€è¦æå¤§çš„ç©ºé—´ï¼Œåè€…ç©ºé—´å¾ˆå°ã€‚æœ‰å¤šå°‘ä¸ªæ•°å­—ï¼Œç¦»æ•£åŒ–åå¼€çš„ç©ºé—´å°±æ˜¯å¤šå¤§ã€‚ 
    
    ä¸‹é¢æ˜¯æ´›è°· 1908çš„ä»£ç ï¼Œæ³¨æ„å…¶ä¸­çš„ç¦»æ•£åŒ–æ“ä½œã€‚ç¦»æ•£åŒ–æ—¶è®¡ç®—â€œç›¸å¯¹å¤§å°â€éœ€è¦ç”¨åˆ°æ’åºï¼Œè¯·ä»”ç»†åˆ†æã€‚

???+note "å‚è€ƒä»£ç "
    ```cpp
    //lowbit(x)ï¼Œupdate()ï¼Œsum()çš„ä»£ç å‰é¢å·²ç»™å‡º
    const int Maxn = 500010;
    int tree[Maxn],rank[Maxn],n;
    struct point{
    int num,val;
    }a[Maxn];
    bool cmp(point x,point y){
        if(x.val == y.val)   return x.num < y.num;  //æ³¨æ„ï¼šç›¸ç­‰çš„æƒ…å†µï¼Œå…ˆå‡ºç°æ ‡è®°æ›´å°
        return x.val < y.val;
    }
    int main(){
        scanf("%d",&n);
        for(int i=1;i<=n;i++) {
            scanf("%d",&a[i].val);
            a[i].num = i;         //è®°å½•é¡ºåºï¼Œç”¨äºç¦»æ•£åŒ–
        }
        sort(a+1,a+1+n,cmp);      //æ’åº
        for(int i=1;i<=n;i++)     //ç¦»æ•£åŒ–ï¼Œå¾—åˆ°æ–°çš„æ•°å­—åºåˆ—rank[]
            rank[a[i].num]=i;     
    long long ans=0; 
        /*for(int i=1;i<=n;i++){    //æ­£åºå¤„ç†
            update(rank[i],1);
            ans += i-sum(rank[i]);
        }*/
        for(int i=n;i > 0;--i){     //å€’åºå¤„ç†
            update(rank[i],1);
            ans += sum(rank[i]-1);
        }
        printf("%lld",ans);
        return 0;
    } 
    ```

## åŒºé—´æœ€å€¼

æ ‘çŠ¶æ•°ç»„ä¸€èˆ¬ç”¨æ¥è®¡ç®—å‰ç¼€å’Œï¼Œä¸è¿‡ï¼Œä¹Ÿèƒ½é«˜æ•ˆç‡åœ°æ±‚åŒºé—´æœ€å€¼ï¼Œæ­¤æ—¶éœ€è¦æ”¹å†™æ ‘çŠ¶æ•°ç»„çš„ä»£ç ã€‚

???+note "[I hate it](https://vjudge.net/problem/HDU-1754)"
    **é¢˜ç›®æè¿°ï¼š** æ±‚åŒºé—´å†…æœ€å¤§å€¼ã€‚
    
    **è¾“å…¥ï¼š** ç¬¬ä¸€è¡Œæ˜¯æ­£æ•´æ•°`N,M ( 0<N<=200000,0<M<5000 )`ï¼Œä»£è¡¨æ•°å­—ä¸ªæ•°å’Œæ“ä½œæ•°ã€‚ç¬¬äºŒè¡ŒåŒ…å«Nä¸ªæ•´æ•°ï¼Œæ¥ä¸‹æ¥Mè¡Œï¼Œæ¯è¡Œæœ‰ä¸€ä¸ªè¯¢é—®ï¼Œæ ¼å¼ä¸ºï¼š
    
    Q A B ä»£è¡¨ä¸€ä¸ªè¯¢é—®ï¼Œè¯¢é—®ä»ç¬¬Aåˆ°ç¬¬Bä¸ªæ•°å­—ä¸­çš„æœ€å¤§å€¼ã€‚
    
    U A B ä»£è¡¨ä¸€ä¸ªæ›´æ–°ï¼ŒæŠŠç¬¬Aä¸ªæ•°å­—æ”¹ä¸ºBã€‚
    
    **è¾“å‡ºï¼š** å¯¹æ¯ä¸ªè¯¢é—®ï¼Œè¾“å‡ºåŒºé—´æœ€å¤§å€¼ã€‚

???+note "è§£é¢˜æ€è·¯"
    ç”¨æš´åŠ›æ³•ï¼Œå¤æ‚åº¦æ˜¯O(MN)çš„ã€‚ä¸‹é¢ç”¨æ ‘çŠ¶æ•°ç»„æ±‚è§£ã€‚ 

    åœ¨æ ‡å‡†çš„å‰ç¼€å’Œæ ‘çŠ¶æ•°ç»„ä¸­ï¼Œtree\[x\]ä¸­å‚¨å­˜çš„æ˜¯\[x-lowbit(x)+1, x\]ä¸­æ¯ä¸ªæ•°çš„å’Œã€‚åœ¨æ±‚æœ€å€¼çš„æ ‘çŠ¶æ•°ç»„ä¸­ï¼Œtree\[x\]è®°å½•\[x-lowbit(x)+1, x\]å†…æ‰€æœ‰æ•°çš„æœ€å¤§å€¼ã€‚
    
    ï¼ˆ1ï¼‰å•ç‚¹ä¿®æ”¹ğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’1(ğ‘¥,ğ‘£ğ‘ğ‘™ğ‘¢ğ‘’)ã€‚ç”¨ğ‘£ğ‘ğ‘™ğ‘¢ğ‘’æ›´æ–°ğ‘¡ğ‘Ÿğ‘’ğ‘’\[ğ‘¥\]çš„æœ€å¤§å€¼ï¼Œå¹¶æ›´æ–°æ ‘çŠ¶æ•°ç»„ä¸Šè¢«å®ƒå½±å“çš„ç»“ç‚¹ã€‚ä¾‹å¦‚ä¿®æ”¹ğ‘¥ = 4ï¼Œæ­¥éª¤æ˜¯ï¼š
    
        1ï¼‰ä¿®æ”¹ğ‘¥å­æ ‘ä¸Šç›´è¿çš„ğ‘¡ğ‘Ÿğ‘’ğ‘’\[2\]ã€ğ‘¡ğ‘Ÿğ‘’ğ‘’\[3\]ï¼›
        
        2ï¼‰ğ‘¥çš„çˆ¶ç»“ç‚¹ğ‘¡ğ‘Ÿğ‘’ğ‘’\[8\]ï¼Œä»¥åŠğ‘¡ğ‘Ÿğ‘’ğ‘’\[8\]çš„ç›´è¿å­ç»“ç‚¹ğ‘¡ğ‘Ÿğ‘’ğ‘’\[6\]ã€ğ‘¡ğ‘Ÿğ‘’ğ‘’\[7\]ï¼›...ç­‰ç­‰ã€‚
    
    æ¯ä¸€æ­¥å¤æ‚åº¦æ˜¯ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)ï¼Œå…±ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)æ­¥ï¼Œæ€»å¤æ‚åº¦æ˜¯ğ‘‚((ğ‘™ğ‘œğ‘”ğ‘›)2)ã€‚æ³¨æ„ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œåˆå§‹åŒ–çš„æ—¶å€™éœ€è¦ä¿®æ”¹æ‰€æœ‰nä¸ªæ•°ï¼Œå¤æ‚åº¦ğ‘‚(ğ‘›(ğ‘™ğ‘œğ‘”ğ‘›)2)ï¼Œç¬¦åˆè¦æ±‚ã€‚

    ```cpp
    void update1(int x,int value){
        while(x <= n){
            tree[x] = value;
            for(int i=1; i<lowbit(x); i<<=1)      //ç”¨å­ç»“ç‚¹æ›´æ–°è‡ªå·±
                tree[x] = max(tree[x], tree[x-i]);
            x += lowbit(x);                       //çˆ¶ç»“ç‚¹
        }
    }
    ```

    ï¼ˆ2ï¼‰åŒºé—´æœ€å€¼æŸ¥è¯¢query1()ã€‚åŒºé—´ \[L, R\]çš„æœ€å€¼ï¼Œåˆ†ä¸¤ç§æƒ…å†µè®¨è®ºã€‚

        1ï¼‰R - L >= lowbit( R)ã€‚å¯¹ç…§â€œæ ‘çŠ¶æ•°ç»„åŸç†å›¾â€ï¼Œå³\[L, R\]èŒƒå›´åŒ…å«äº†tree\[R\]ç›´è¿å­ç»“ç‚¹çš„ä¸ªæ•°ï¼Œæ­¤æ—¶ç›´æ¥ä½¿ç”¨tree\[R\]çš„å€¼ï¼šquery1(L, R) = max(tree\[R\], query1(L, Râˆ’lowbit( R)))ã€‚

        2ï¼‰å½“ R - L < lowbit(R) æ—¶ï¼Œä¸Šè¿°åŒ…å«å…³ç³»ä¸æˆç«‹ï¼Œå…ˆä½¿ç”¨a\[R\]çš„å€¼ï¼Œç„¶åå¾€å‰é€’æ¨ï¼šquery1(L, R) = max(a\[R\], query1(L, Râˆ’1))ã€‚

    query1()çš„å¤æ‚åº¦ä»ç„¶æ˜¯ğ‘‚((ğ‘™ğ‘œğ‘”ğ‘›)2)ã€‚

    ```cpp
    int query1(int L,int R){
        int ans = 0;
        while(L<=R)	{
            ans = max(ans,a[R]);
            R--;
            while(R-L>=lowbit(R)){
                ans = max(ans,tree[R]);
                R-=lowbit(R);
            }
        }
        return ans;
    }
    ```

???+note "å‚è€ƒä»£ç "

    ```cpp
    #include<bits/stdc++.h>
    using namespace std;
    const int maxn=2e5+10; 
    int n,m,a[maxn],tree[maxn]; 
    int lowbit(int x){return x&(-x);}
    void update1(int x,int value){;}    //ä»£ç åœ¨å‰é¢
    int query1(int L,int R){;}          //ä»£ç åœ¨å‰é¢
    int main(){
        while(~scanf("%d%d",&n,&m))	{
            memset(tree,0,sizeof(tree));
            for(int i=1; i<=n; i++){
                scanf("%d",&a[i]);
                update1(i,a[i]);
            }
            while(m--){
                char s[5];int A,B;
                scanf("%s%d%d",s,&A,&B);
                if(s[0]=='Q')
                    printf("%d\n",query1(A,B));
                else{
                    a[A]=B;
                    update1(A,B);
                }
            }
        }
        return 0;
    }
    ```

## ç¦»çº¿å¤„ç†

???+note "[No Pain No Game](https://vjudge.net/problem/HDU-4630)"
    **é¢˜ç›®æè¿°ï¼š** ç»™å‡ºä¸€ä¸ªåºåˆ—ï¼Œè¿™ä¸ªåºåˆ—æ˜¯1~nè¿™nä¸ªæ•°å­—çš„ä¸€ä¸ªå…¨æ’åˆ—ã€‚ç»™å‡ºä¸€ä¸ªåŒºé—´\[L, R\]ï¼Œæ±‚åŒºé—´å†…ä»»æ„ä¸¤ä¸ªæ•°çš„GCDï¼ˆæœ€å¤§å…¬çº¦æ•°ï¼‰çš„æœ€å¤§å€¼ã€‚
    
    **è¾“å…¥ï¼š** ç¬¬ä¸€è¡ŒåŒ…æ‹¬ä¸€ä¸ªæ•°Tï¼Œåé¢æœ‰Tä¸ªæµ‹è¯•ã€‚æ¯ä¸ªæµ‹è¯•çš„ç¬¬ä¸€è¡Œæ˜¯æ•°å­—nï¼Œ`1<=n<=50000`ï¼Œç¬¬äºŒè¡ŒåŒ…æ‹¬nä¸ªæ•°ï¼Œæ˜¯1~nè¿™nä¸ªæ•°å­—çš„ä¸€ä¸ªå…¨æ’åˆ—ã€‚ç¬¬ä¸‰è¡ŒåŒ…æ‹¬æ•°å­—Qï¼Œ`1<=Q<=50000`ï¼Œè¡¨ç¤ºQä¸ªè¯¢é—®ã€‚åé¢æœ‰Qè¡Œï¼Œæ¯è¡Œæœ‰2ä¸ªæ•´æ•°`Lï¼ŒRï¼Œ1<=L<=R<=n`ï¼Œè¡¨ç¤ºä¸€ä¸ªè¯¢é—®ã€‚
    
    **è¾“å‡ºï¼š** æ¯ä¸ªè¯¢é—®çš„ç»“æœæ‰“å°ä¸€è¡Œã€‚

???+note "è§£é¢˜æ€è·¯"
    åœ¨åŒºé—´\[L, R\]å†…ï¼Œå…ˆæ±‚å‡ºåŒºé—´å†…æ‰€æœ‰æ•°çš„å› å­ï¼Œå‡ºç°2æ¬¡çš„å› å­æ˜¯å…¬çº¦æ•°ï¼Œæœ€å¤§çš„é‚£ä¸ªå°±æ˜¯ç­”æ¡ˆã€‚
    
    æœ‰Qä¸ªåŒºé—´è¯¢é—®ï¼Œè€ŒQå¾ˆå¤§ï¼Œæ‰€ä»¥æ¯æ¬¡æŸ¥è¯¢çš„å¤æ‚åº¦éœ€è¦è¾¾åˆ°ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘›)æ‰è¡Œã€‚ä½†æ˜¯å¦‚æœå¯¹æ¯ä¸ªè¯¢é—®éƒ½å•ç‹¬è®¡ç®—è¿™ä¸ªåŒºé—´å†…çš„æœ€å¤§å…¬çº¦æ•°ï¼Œæœ€å¿«ä¹Ÿæ˜¯ğ‘‚(ğ‘›)çš„ï¼ŒQä¸ªè¯¢é—®å°±æ˜¯ğ‘‚(ğ‘›2)ï¼Œè¶…æ—¶ã€‚
    
    æ­¤æ—¶éœ€è¦ç”¨ç¦»çº¿å¤„ç†ï¼Œå³å…ˆè¯»å–æ‰€æœ‰çš„è¯¢é—®ï¼Œç„¶åç»Ÿä¸€å¤„ç†ï¼Œè®¡ç®—ç»“æŸåä¸€èµ·è¾“å‡ºã€‚
    
    å‰é¢çš„æ ‡å‡†æ ‘çŠ¶æ•°ç»„çš„ä»£ç ï¼Œåªèƒ½æ±‚åŒºé—´å’Œã€‚èƒ½å¦æ”¹æˆæ±‚åŒºé—´æœ€å€¼ï¼ŸæŠŠupdate()ã€sum()ç®€å•åœ°æ”¹å†™æˆï¼š

    ```cpp
    void update2(int x,int d){    
        while(x <= n){
            tree[x] = max(tree[x],d);  //æ”¹æˆï¼šæ›´æ–°æœ€å¤§å€¼
            x += lowbit(x);
        }
    }
    int query2(int x){              
        int ans = 0;
        while(x > 0){
            ans = max(ans,tree[x]);   //æ”¹æˆï¼šæ±‚æœ€å¤§å€¼
            x -= lowbit(x);
        }
        return ans;
    }
    ```

    å¯¹ç…§â€œæ ‘çŠ¶æ•°ç»„åŸç†å›¾â€ï¼Œæ‰§è¡Œğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’2(ğ‘¥,ğ‘‘)çš„ç»“æœï¼Œæ˜¯åœ¨\[ğ‘¥,ğ‘›\]åŒºé—´å†…ï¼ŒæŠŠğ‘¥çš„çˆ¶ç»“ç‚¹ï¼ˆå³ğ‘¥+ğ‘™ğ‘œğ‘¤ğ‘ğ‘–ğ‘¡(ğ‘¥),ä»¥åŠçˆ¶ç»“ç‚¹çš„çˆ¶ç»“ç‚¹ï¼‰çš„ğ‘¡ğ‘Ÿğ‘’ğ‘’\[\]å€¼è®¾ç½®ä¸ºğ‘ğ‘¥çš„æœ€å¤§å€¼ï¼›æ‰§è¡Œğ‘ğ‘¢ğ‘’ğ‘Ÿğ‘¦2(ğ‘¥)ï¼Œè¿”å›çš„æ˜¯ğ‘1 ğ‘ğ‘¥çš„æœ€å¤§å€¼ã€‚
    
    ä¸Šè¿°ä»£ç å¹¶ä¸èƒ½ç”¨äºä¸Šä¸€å°ç»“çš„â€œæ±‚åŒºé—´\[L, R\]æœ€å€¼â€é—®é¢˜ã€‚å› ä¸ºæœ€å€¼æ²¡æœ‰å‰ç¼€å’Œçš„é‚£ç§çº¿æ€§å…³ç³»ï¼Œ\[L, R\]çš„æœ€å€¼ä¸\[1, L-1\]ã€\[1, R\]çš„æœ€å€¼å¹¶æ²¡æœ‰å…³ç³»ã€‚ä½†æ˜¯åœ¨æœ¬é¢˜ä¸­å¾ˆæœ‰ç”¨ã€‚
    
    é¦–å…ˆå°†æ‰€æœ‰çš„è¯¢é—®\[L, R\]æŒ‰å·¦ç«¯ç‚¹Lä»å¤§åˆ°å°æ’åºã€‚ä»æœ€å¤§çš„L1å¼€å§‹è®¡ç®—ï¼Œç”¨ğ‘¢ğ‘ğ‘‘ğ‘ğ‘¡ğ‘’2()å¾€çˆ¶ç»“ç‚¹æ–¹å‘æ›´æ–°æœ€å¤§å€¼ï¼Œå¹¶ç”¨ğ‘ğ‘¢ğ‘’ğ‘Ÿğ‘¦2(ğ‘…1)è¿”å›åŒºé—´\[L1, R1\]çš„æœ€å¤§å€¼ï¼Œç”±äºæ­¤æ—¶æ¯”L1å°çš„é‚£äº›è¯¢é—®è¿˜æ²¡æœ‰å¼€å§‹ä¿®æ”¹æ ‘çŠ¶æ•°ç»„ï¼Œä¹Ÿå°±ä¸å½±å“\[L1, R1\]çš„è®¡ç®—ã€‚ä¸‹ä¸€æ­¥å†ä»ç¬¬äºŒå¤§çš„L2å¼€å§‹è®¡ç®—ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå…ˆè®¡ç®—çš„åŒºé—´ï¼Œèƒ½ç”¨äºåè®¡ç®—çš„åŒºé—´ï¼Œä»è€Œæé«˜äº†æ•ˆç‡ã€‚

## è€ç‰ˆæœ¬--åŒºé—´åŠ  & åŒºé—´æ±‚å’Œ

è‹¥ç»´æŠ¤åºåˆ— $a$ çš„å·®åˆ†æ•°ç»„ $b$ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹ $a$ çš„ä¸€ä¸ªå‰ç¼€ $r$ æ±‚å’Œï¼Œå³ $\sum_{i=1}^{r} a_i$ï¼Œç”±å·®åˆ†æ•°ç»„å®šä¹‰å¾— $a_i=\sum_{j=1}^i b_j$

è¿›è¡Œæ¨å¯¼

???+note "è¯æ˜"
    $$
    \begin{aligned}
    &\sum_{i=1}^{r} a_i\\=&\sum_{i=1}^r\sum_{j=1}^i b_j\\=&\sum_{i=1}^r b_i\times(r-i+1)
    \\=&\sum_{i=1}^r b_i\times (r+1)-\sum_{i=1}^r b_i\times i
    \end{aligned}
    $$

åŒºé—´å’Œå¯ä»¥ç”¨ä¸¤ä¸ªå‰ç¼€å’Œç›¸å‡å¾—åˆ°ï¼Œå› æ­¤åªéœ€è¦ç”¨ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„åˆ†åˆ«ç»´æŠ¤ $\sum b_i$ å’Œ $\sum i \times b_i$ï¼Œå°±èƒ½å®ç°åŒºé—´æ±‚å’Œã€‚

ä»£ç å¦‚ä¸‹

???+note "å®ç°"
    === "C++"
    
        ```cpp
        int t1[MAXN], t2[MAXN], n;
    
        inline int lowbit(int x) { return x & (-x); }
    
        void add(int k, int v) {
          int v1 = k * v;
          while (k <= n) {
            t1[k] += v, t2[k] += v1;
            k += lowbit(k);
          }
        }
    
        int getsum(int *t, int k) {
          int ret = 0;
          while (k) {
            ret += t[k];
            k -= lowbit(k);
          }
          return ret;
        }
    
        void add1(int l, int r, int v) {
          add(l, v), add(r + 1, -v);  // å°†åŒºé—´åŠ å·®åˆ†ä¸ºä¸¤ä¸ªå‰ç¼€åŠ 
        }
    
        long long getsum1(int l, int r) {
          return (r + 1ll) * getsum(t1, r) - 1ll * l * getsum(t1, l - 1) -
                (getsum(t2, r) - getsum(t2, l - 1));
        }
        ```
    
    === "Python"
    
        ```python
        t1 = [0] * MAXN, t2 = [0] * MAXN; n = 0
    
        def lowbit(x):
            return x & (-x)
    
        def add(k, v):
            v1 = k * v
            while k <= n:
                t1[k] = t1[k] + v; t2[k] = t2[k] + v1
                k = k + lowbit(k)
    
        def getsum(t, k):
            ret = 0
            while k:
                ret = ret + t[k]
                k = k - lowbit(k)
            return ret
    
        def add1(l, r, v):
            add(l, v)
            add(r + 1, -v)
    
        def getsum1(l, r):
            return (r) * getsum(t1, r) - l * getsum(t1, l - 1) - \
                  (getsum(t2, r) - getsum(t2, l - 1))
        ```

## Tricks

### $O(n)$ å»ºæ ‘

æ–¹æ³•ä¸€ï¼š

æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼æ˜¯ç”±æ‰€æœ‰ä¸è‡ªå·±ç›´æ¥ç›¸è¿çš„å„¿å­çš„å€¼æ±‚å’Œå¾—åˆ°çš„ã€‚å› æ­¤å¯ä»¥å€’ç€è€ƒè™‘è´¡çŒ®ï¼Œå³æ¯æ¬¡ç¡®å®šå®Œå„¿å­çš„å€¼åï¼Œç”¨è‡ªå·±çš„å€¼æ›´æ–°è‡ªå·±çš„ç›´æ¥çˆ¶äº²ã€‚

???+note "å®ç°"
    === "C++"
    
        ```cpp
        // O(n) å»ºæ ‘
        void init() {
          for (int i = 1; i <= n; ++i) {
            t[i] += a[i];
            int j = i + lowbit(i);
            if (j <= n) t[j] += t[i];
          }
        }
        ```
    
    === "Python"
    
        ```python
        def init():
            for i in range(1, n + 1):
                t[i] = t[i] + a[i]
                j = i + lowbit(i)
                if j <= n:
                    t[j] = t[j] + t[i]
        ```

æ–¹æ³•äºŒï¼š

å‰é¢è®²åˆ° $c_i$ è¡¨ç¤ºçš„åŒºé—´æ˜¯ $[i-\operatorname{lowbit}(i)+1, i]$ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆé¢„å¤„ç†ä¸€ä¸ª $sum$ å‰ç¼€å’Œæ•°ç»„ï¼Œå†è®¡ç®— $c$ æ•°ç»„ã€‚

???+note "å®ç°"
    === "C++"
    
        ```cpp
        void init() {
          for (int i = 1; i <= n; ++i) {
            t[i] = sum[i] - sum[i - lowbit(i)];
          }
        }
        ```
    
    === "Python"
    
        ```python
        def init():
            for i in range(1, n + 1):
                t[i] = sum[i] - sum[i-lowbit(i)]
        ```

### $O(\log n)$ æŸ¥è¯¢ç¬¬ $k$ å°/å¤§å…ƒç´ 

#### è¿‡ç¨‹

åœ¨æ­¤å¤„åªè®¨è®ºç¬¬ $k$ å°ï¼Œç¬¬ $k$ å¤§é—®é¢˜å¯ä»¥é€šè¿‡ç®€å•è®¡ç®—è½¬åŒ–ä¸ºç¬¬ $k$ å°é—®é¢˜ã€‚

å‚è€ƒã€Œå¯æŒä¹…åŒ–çº¿æ®µæ ‘ã€ç« èŠ‚ä¸­ï¼Œå…³äºæ±‚åŒºé—´ç¬¬ $k$ å°çš„æ€æƒ³ã€‚å°†æ‰€æœ‰æ•°å­—çœ‹æˆä¸€ä¸ªå¯é‡é›†åˆï¼Œå³å®šä¹‰æ•°ç»„ $a$ è¡¨ç¤ºå€¼ä¸º $i$ çš„å…ƒç´ åœ¨æ•´ä¸ªåºåˆ—ä¸­å‡ºç°äº† $a_i$ æ¬¡ã€‚æ‰¾ç¬¬ $k$ å°å°±æ˜¯æ‰¾åˆ°æœ€å°çš„ $x$ æ°å¥½æ»¡è¶³ $\sum_{i=1}^{x}a_i \geq k$

å› æ­¤å¯ä»¥æƒ³åˆ°ç®—æ³•ï¼šå¦‚æœå·²ç»æ‰¾åˆ° $x$ æ»¡è¶³ $\sum_{i=1}^{x}a_i < k$ï¼Œè€ƒè™‘èƒ½ä¸èƒ½è®© $x$ ç»§ç»­å¢åŠ ï¼Œä½¿å…¶ä»ç„¶æ»¡è¶³è¿™ä¸ªæ¡ä»¶ã€‚æ‰¾åˆ°æœ€å¤§çš„ $x$ åï¼Œ$x+1$ å°±æ˜¯æ‰€è¦çš„å€¼ã€‚
åœ¨æ ‘çŠ¶æ•°ç»„ä¸­ï¼ŒèŠ‚ç‚¹æ˜¯æ ¹æ® 2 çš„å¹‚åˆ’åˆ†çš„ï¼Œæ¯æ¬¡å¯ä»¥æ‰©å¤§ 2 çš„å¹‚çš„é•¿åº¦ã€‚ä»¤ $sum$ è¡¨ç¤ºå½“å‰çš„ $x$ æ‰€ä»£è¡¨çš„å‰ç¼€å’Œï¼Œæœ‰å¦‚ä¸‹ç®—æ³•æ‰¾åˆ°æœ€å¤§çš„ $x$ï¼š

1. æ±‚å‡º $depth=\left \lfloor \log_2n \right \rfloor$
2. è®¡ç®— $t=\sum_{i=x+1}^{x+2^{depth}}a_i$
3. å¦‚æœ $sum+t < k$ï¼Œåˆ™æ­¤æ—¶æ‰©å±•æˆåŠŸï¼Œå°† $2^{depth}$ ç´¯åŠ åˆ° $x$ ä¸Šï¼›å¦åˆ™æ‰©å±•å¤±è´¥ï¼Œå¯¹ $x$ ä¸è¿›è¡Œæ“ä½œ
4. å°† $depth$ å‡ 1ï¼Œå›åˆ°æ­¥éª¤ 2ï¼Œç›´è‡³ $depth$ ä¸º 0

#### å®ç°

=== "C++"

    ```cpp
    // æƒå€¼æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢ç¬¬kå°
    int kth(int k) {
      int cnt = 0, ret = 0;
      for (int i = log2(n); ~i; --i) {      // i ä¸ä¸Šæ–‡ depth å«ä¹‰ç›¸åŒ
        ret += 1 << i;                      // å°è¯•æ‰©å±•
        if (ret >= n || cnt + t[ret] >= k)  // å¦‚æœæ‰©å±•å¤±è´¥
          ret -= 1 << i;
        else
          cnt += t[ret];  // æ‰©å±•æˆåŠŸå è¦æ›´æ–°ä¹‹å‰æ±‚å’Œçš„å€¼
      }
      return ret + 1;
    }
    ```

=== "Python"

    ```python
    # æƒå€¼æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢ç¬¬ k å°
    def kth(k):
        cnt = 0; ret = 0
        i = log2(n) # i ä¸ä¸Šæ–‡ depth å«ä¹‰ç›¸åŒ
        while ~i:
            ret = ret + (1 << i) # å°è¯•æ‰©å±•
            if ret >= n or cnt + t[ret] >= k: # å¦‚æœæ‰©å±•å¤±è´¥
                ret = ret - (1 << i)
            else:
                cnt = cnt + t[ret] # æ‰©å±•æˆåŠŸå è¦æ›´æ–°ä¹‹å‰æ±‚å’Œçš„å€¼
        return ret + 1
    ```

### æ—¶é—´æˆ³ä¼˜åŒ–

#### è¿‡ç¨‹

å¯¹ä»˜å¤šç»„æ•°æ®å¾ˆå¸¸è§çš„æŠ€å·§ã€‚å¦‚æœæ¯æ¬¡è¾“å…¥æ–°æ•°æ®æ—¶ï¼Œéƒ½æš´åŠ›æ¸…ç©ºæ ‘çŠ¶æ•°ç»„ï¼Œå°±å¯èƒ½ä¼šé€ æˆè¶…æ—¶ã€‚å› æ­¤ä½¿ç”¨ $tag$ æ ‡è®°ï¼Œå­˜å‚¨å½“å‰èŠ‚ç‚¹ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´ï¼ˆå³æœ€è¿‘ä¸€æ¬¡æ˜¯è¢«ç¬¬å‡ ç»„æ•°æ®ä½¿ç”¨ï¼‰ã€‚æ¯æ¬¡æ“ä½œæ—¶åˆ¤æ–­è¿™ä¸ªä½ç½® $tag$ ä¸­çš„æ—¶é—´å’Œå½“å‰æ—¶é—´æ˜¯å¦ç›¸åŒï¼Œå°±å¯ä»¥åˆ¤æ–­è¿™ä¸ªä½ç½®åº”è¯¥æ˜¯ 0 è¿˜æ˜¯æ•°ç»„å†…çš„å€¼ã€‚

#### å®ç°

=== "C++"

    ```cpp
    // æ—¶é—´æˆ³ä¼˜åŒ–
    int tag[MAXN], t[MAXN], Tag;

    void reset() { ++Tag; }

    void add(int k, int v) {
      while (k <= n) {
        if (tag[k] != Tag) t[k] = 0;
        t[k] += v, tag[k] = Tag;
        k += lowbit(k);
      }
    }

    int getsum(int k) {
      int ret = 0;
      while (k) {
        if (tag[k] == Tag) ret += t[k];
        k -= lowbit(k);
      }
      return ret;
    }
    ```

=== "Python"

    ```python
    # æ—¶é—´æˆ³ä¼˜åŒ–
    tag = [0] * MAXN; t = [0] * MAXN; Tag = 0
    def reset():
        Tag = Tag + 1
    def add(k, v):
        while k <= n:
            if tag[k] != Tag:
                t[k] = 0
            t[k] = t[k] + v
            tag[k] = Tag
            k = k + lowbit(k)
    def getsum(k):
        ret = 0
        while k:
            if tag[k] == Tag:
                ret = ret + t[k]
            k = k - lowbit(k)
        return ret
    ```

## ä¾‹é¢˜

- [æ ‘çŠ¶æ•°ç»„ 1ï¼šå•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢](https://loj.ac/problem/130)
- [æ ‘çŠ¶æ•°ç»„ 2ï¼šåŒºé—´ä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢](https://loj.ac/problem/131)
- [æ ‘çŠ¶æ•°ç»„ 3ï¼šåŒºé—´ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢](https://loj.ac/problem/132)
- [äºŒç»´æ ‘çŠ¶æ•°ç»„ 1ï¼šå•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢](https://loj.ac/problem/133)
- [äºŒç»´æ ‘çŠ¶æ•°ç»„ 3ï¼šåŒºé—´ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢](https://loj.ac/problem/135)
- [MooFest](http://poj.org/problem?id=1990)
- [Inner Vertices](http://poj.org/problem?id=3109)
- [Matrix](http://poj.org/problem?id=2155)
- [Who Gets the Most Candies?](http://poj.org/problem?id=2886)
